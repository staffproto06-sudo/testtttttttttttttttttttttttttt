<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation Manager Pro | Full Firebase Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ========== FULL ORIGINAL STYLES (kept exactly) ========== */
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #475569;
            --accent-color: #0ea5e9;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --expense-color: #8b5cf6;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: var(--text-primary); line-height: 1.5; min-height: 100vh; }
        .container { display: flex; min-height: 100vh; max-width: 100%; }
        .sidebar { width: 260px; background-color: var(--card-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; box-shadow: var(--shadow-sm); z-index: 10; }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid var(--border-color); }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 36px; height: 36px; background-color: var(--primary-color); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }
        .logo-text { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        .logo-subtext { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
        .nav-menu { padding: 20px 0; flex-grow: 1; }
        .nav-item { display: flex; align-items: center; padding: 12px 20px; color: var(--text-secondary); text-decoration: none; font-weight: 500; transition: var(--transition); border-left: 3px solid transparent; }
        .nav-item:hover { background-color: var(--light-bg); color: var(--primary-color); }
        .nav-item.active { background-color: rgba(37, 99, 235, 0.05); color: var(--primary-color); border-left: 3px solid var(--primary-color); }
        .nav-item i { margin-right: 12px; width: 20px; text-align: center; }
        .sidebar-footer { padding: 20px; border-top: 1px solid var(--border-color); font-size: 13px; color: var(--text-secondary); }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: auto; }
        .header { padding: 20px 32px; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); }
        .header-title h1 { font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
        .header-title p { color: var(--text-secondary); font-size: 14px; }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .btn { padding: 10px 20px; border-radius: var(--radius-md); border: none; font-weight: 600; font-size: 14px; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); box-shadow: var(--shadow-md); }
        .btn-secondary { background-color: var(--light-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: #e2e8f0; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #0d9c6d; }
        .btn-expense { background-color: var(--expense-color); color: white; }
        .btn-expense:hover { background-color: #7c3aed; box-shadow: var(--shadow-md); }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        .content-wrapper { padding: 32px; flex-grow: 1; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card { background-color: var(--card-bg); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); transition: var(--transition); }
        .stat-card:hover { box-shadow: var(--shadow-md); }
        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .stat-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-icon { width: 48px; height: 48px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .stat-value { font-size: 32px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
        .stat-change { font-size: 13px; font-weight: 600; }
        .stat-change.positive { color: var(--success-color); }
        .stat-change.negative { color: var(--danger-color); }
        .panel-container { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }
        @media (max-width: 1200px) { .panel-container { grid-template-columns: 1fr; } }
        .panel { background-color: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); overflow: hidden; }
        .panel-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); background-color: var(--light-bg); }
        .panel-header h2 { font-size: 18px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        .panel-header h2 i { color: var(--primary-color); }
        .panel-body { padding: 24px; }
        .form-group { margin-bottom: 20px; position: relative; }
        .form-group.draggable { cursor: grab; border: 2px solid transparent; border-radius: var(--radius-md); padding: 12px; transition: all 0.2s ease; background-color: white; }
        .form-group.draggable:hover { background-color: rgba(37, 99, 235, 0.03); border-color: rgba(37, 99, 235, 0.2); }
        .form-group.draggable.dragging { opacity: 0.5; background-color: rgba(37, 99, 235, 0.1); border: 2px dashed var(--primary-color); }
        .form-group.draggable.drag-over { border: 2px dashed var(--success-color); background-color: rgba(16, 185, 129, 0.05); }
        .drag-handle { position: absolute; left: -10px; top: 50%; transform: translateY(-50%); width: 28px; height: 28px; border-radius: 50%; background-color: var(--light-bg); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); cursor: grab; transition: var(--transition); z-index: 5; opacity: 0.7; }
        .form-group.draggable:hover .drag-handle { opacity: 1; }
        .drag-handle:hover { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .drag-handle:active { cursor: grabbing; }
        .field-order-indicator { position: absolute; right: 0; top: 0; background-color: var(--primary-color); color: white; width: 24px; height: 24px; border-radius: 0 var(--radius-md) 0 var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; padding-left: 8px; }
        .form-label span { color: var(--danger-color); }
        .form-control { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-family: 'Inter', sans-serif; font-size: 14px; color: var(--text-primary); background-color: white; transition: var(--transition); }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .form-control-sm { padding: 8px 12px; font-size: 13px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; }
        .checkbox-group input { width: 18px; height: 18px; }
        .checkbox-group label { font-size: 14px; color: var(--text-secondary); font-weight: 400; }
        .column-types { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin: 20px 0; }
        .type-option { border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px 12px; text-align: center; cursor: pointer; transition: var(--transition); background-color: white; }
        .type-option:hover { border-color: var(--primary-color); background-color: rgba(37, 99, 235, 0.02); }
        .type-option.selected { border-color: var(--primary-color); background-color: rgba(37, 99, 235, 0.05); }
        .type-icon { font-size: 20px; margin-bottom: 8px; color: var(--primary-color); }
        .type-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
        .table-container { background-color: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); overflow: hidden; }
        .table-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--light-bg); }
        .table-title { font-size: 18px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        .table-title i { color: var(--primary-color); }
        .table-actions { display: flex; gap: 12px; }
        .table-wrapper { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        .data-table th { padding: 16px 20px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-color); background-color: var(--light-bg); white-space: nowrap; }
        .data-table td { padding: 16px 20px; border-bottom: 1px solid var(--border-color); font-size: 14px; color: var(--text-primary); }
        .data-table tbody tr:hover { background-color: rgba(37, 99, 235, 0.02); }
        .status-badge { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        .status-confirmed { background-color: rgba(16, 185, 129, 0.1); color: var(--success-color); }
        .status-pending { background-color: rgba(245, 158, 11, 0.1); color: var(--warning-color); }
        .status-cancelled { background-color: rgba(239, 68, 68, 0.1); color: var(--danger-color); }
        .status-paid { background-color: rgba(16, 185, 129, 0.1); color: var(--success-color); }
        .status-expense-pending { background-color: rgba(245, 158, 11, 0.1); color: var(--warning-color); }
        .category-badge { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        .currency-cell { font-weight: 600; color: var(--success-color); }
        .expense-cell { font-weight: 600; color: var(--danger-color); }
        .checkbox-cell { text-align: center; }
        .checkbox-cell i.fa-check-circle { color: var(--success-color); }
        .checkbox-cell i.fa-times-circle { color: var(--danger-color); }
        .action-buttons { display: flex; gap: 8px; }
        .btn-icon { width: 32px; height: 32px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: var(--transition); background-color: transparent; color: var(--text-secondary); }
        .btn-icon:hover { background-color: var(--light-bg); }
        .btn-icon.edit:hover { color: var(--primary-color); }
        .btn-icon.delete:hover { color: var(--danger-color); }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state i { font-size: 48px; margin-bottom: 20px; color: var(--border-color); }
        .empty-state h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }
        .empty-state p { font-size: 14px; max-width: 400px; margin: 0 auto; }
        .active-filters { display: flex; flex-wrap: wrap; gap: 10px; padding: 16px 24px; background-color: var(--light-bg); border-bottom: 1px solid var(--border-color); }
        .filter-tag { display: inline-flex; align-items: center; gap: 8px; background-color: white; border: 1px solid var(--border-color); border-radius: 20px; padding: 6px 12px; font-size: 13px; font-weight: 500; }
        .filter-tag .filter-remove { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; width: 18px; height: 18px; border-radius: 50%; }
        .filter-tag .filter-remove:hover { background-color: var(--light-bg); color: var(--danger-color); }
        @media (max-width: 768px) { .container { flex-direction: column; } .sidebar { width: 100%; } .header { padding: 16px 20px; } .content-wrapper { padding: 20px; } .dashboard-stats { grid-template-columns: 1fr; } .btn { padding: 8px 16px; } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--card-bg); border-radius: var(--radius-lg); width: 100%; max-width: 600px; box-shadow: var(--shadow-lg); max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        .modal-close { background: none; border: none; font-size: 18px; color: var(--text-secondary); cursor: pointer; }
        .modal-close:hover { color: var(--danger-color); }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }
        .reorder-instructions { background-color: rgba(37, 99, 235, 0.05); border: 1px solid rgba(37, 99, 235, 0.2); border-radius: var(--radius-md); padding: 12px 16px; margin-bottom: 20px; font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 10px; }
        .reorder-instructions i { color: var(--primary-color); }
        .tab-navigation { display: flex; border-bottom: 1px solid var(--border-color); background-color: var(--light-bg); }
        .tab-btn { padding: 16px 24px; background: none; border: none; font-size: 15px; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: var(--transition); border-bottom: 3px solid transparent; display: flex; align-items: center; gap: 8px; }
        .tab-btn:hover { color: var(--primary-color); background-color: rgba(37, 99, 235, 0.05); }
        .tab-btn.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background-color: rgba(37, 99, 235, 0.05); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .expense-breakdown { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .expense-category-card { background-color: var(--card-bg); border-radius: var(--radius-md); padding: 20px; border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; text-align: center; }
        .expense-category-icon { width: 48px; height: 48px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-bottom: 12px; }
        .expense-category-name { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .expense-category-amount { font-size: 20px; font-weight: 700; color: var(--text-primary); }
        .expense-chart { background-color: var(--card-bg); border-radius: var(--radius-lg); padding: 24px; border: 1px solid var(--border-color); margin-bottom: 32px; height: 300px; display: flex; align-items: center; justify-content: center; flex-direction: column; color: var(--text-secondary); }
        .expense-chart i { font-size: 64px; margin-bottom: 20px; color: var(--border-color); }
        .expense-chart h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .expense-table-container { background-color: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); overflow: hidden; }
        .expense-table-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--light-bg); }
        .expense-table-title { font-size: 18px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        .expense-table-title i { color: var(--expense-color); }
        .expense-table-actions { display: flex; gap: 12px; }
        .expense-table-wrapper { overflow-x: auto; }
        .expense-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .expense-table th { padding: 16px 20px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-color); background-color: var(--light-bg); white-space: nowrap; }
        .expense-table td { padding: 16px 20px; border-bottom: 1px solid var(--border-color); font-size: 14px; color: var(--text-primary); }
        .expense-table tbody tr:hover { background-color: rgba(139, 92, 246, 0.02); }
        .expense-table tbody tr.status-paid { background-color: rgba(16, 185, 129, 0.08); }
        .expense-table tbody tr.status-pending { background-color: rgba(239, 68, 68, 0.08); }
        .category-management { display: grid; grid-template-columns: 300px 1fr; gap: 24px; margin-bottom: 32px; }
        @media (max-width: 992px) { .category-management { grid-template-columns: 1fr; } }
        .categories-sidebar { background-color: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); overflow: hidden; }
        .categories-list { max-height: 600px; overflow-y: auto; }
        .category-item { padding: 16px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: var(--transition); position: relative; }
        .category-item:hover { background-color: var(--light-bg); }
        .category-item.active { background-color: rgba(37, 99, 235, 0.05); border-left: 4px solid var(--primary-color); }
        .category-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .category-name { font-weight: 600; color: var(--text-primary); }
        .category-actions { display: flex; gap: 8px; opacity: 0; transition: var(--transition); }
        .category-item:hover .category-actions { opacity: 1; }
        .color-picker { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .color-option { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: var(--transition); }
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: var(--text-primary); transform: scale(1.1); }
        .icon-picker { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; margin-top: 8px; max-height: 200px; overflow-y: auto; padding: 8px; background-color: white; border: 1px solid var(--border-color); border-radius: var(--radius-md); }
        .icon-option { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition); color: var(--text-secondary); }
        .icon-option:hover { background-color: var(--light-bg); color: var(--primary-color); }
        .icon-option.selected { background-color: var(--primary-color); color: white; }
        .expense-summary { background-color: var(--light-bg); border-top: 1px solid var(--border-color); padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .expense-summary-left { display: flex; align-items: center; gap: 16px; }
        .summary-item { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); }
        .summary-value { font-weight: 700; color: var(--text-primary); }
        .summary-total { font-size: 18px; color: var(--danger-color); }
        .summary-total-value { font-size: 24px; font-weight: 800; color: var(--danger-color); }
        .analytics-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .analytics-stat-card { background-color: var(--card-bg); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); transition: var(--transition); }
        .analytics-stat-card:hover { box-shadow: var(--shadow-md); }
        .analytics-stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .analytics-stat-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .analytics-stat-icon { width: 48px; height: 48px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .analytics-stat-value { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
        .analytics-stat-subtitle { font-size: 14px; color: var(--text-secondary); }
        .chart-container { background-color: var(--card-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); overflow: hidden; margin-bottom: 24px; }
        .chart-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); background-color: var(--light-bg); }
        .chart-header h3 { font-size: 18px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        .chart-header h3 i { color: var(--primary-color); }
        .chart-body { padding: 20px; height: 350px; position: relative; }
        .analytics-filters { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-label { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .chart-placeholder { display: flex; align-items: center; justify-content: center; flex-direction: column; height: 100%; color: var(--text-secondary); }
        .chart-placeholder i { font-size: 64px; margin-bottom: 20px; color: var(--border-color); }
        .chart-placeholder h4 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .comparison-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }
        @media (max-width: 768px) { .comparison-cards { grid-template-columns: 1fr; } }
        .comparison-card { background-color: var(--card-bg); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
        .comparison-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .comparison-title { font-size: 16px; font-weight: 700; color: var(--text-primary); }
        .comparison-value { font-size: 24px; font-weight: 800; }
        .profit { color: var(--success-color); }
        .loss { color: var(--danger-color); }
        .comparison-details { margin-top: 16px; }
        .comparison-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .comparison-row:last-child { border-bottom: none; }
        .comparison-label { font-size: 14px; color: var(--text-secondary); }
        .comparison-amount { font-size: 16px; font-weight: 600; }
        .income-amount { color: var(--success-color); }
        .expense-amount { color: var(--danger-color); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .calendar-navigation { display: flex; align-items: center; gap: 12px; }
        .calendar-current-month { font-size: 20px; font-weight: 700; color: var(--text-primary); min-width: 200px; text-align: center; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 24px; }
        .calendar-day-header { text-align: center; padding: 12px; font-weight: 600; color: var(--text-secondary); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .calendar-day { aspect-ratio: 1; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 12px; display: flex; flex-direction: column; cursor: pointer; transition: var(--transition); position: relative; overflow: hidden; }
        .calendar-day:hover { background-color: var(--light-bg); border-color: var(--primary-color); }
        .calendar-day.empty { background-color: transparent; border: none; cursor: default; }
        .calendar-day.today { background-color: rgba(37, 99, 235, 0.05); border-color: var(--primary-color); }
        .calendar-day-number { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .calendar-reservation-indicator { display: flex; flex-direction: column; gap: 4px; margin-top: 4px; font-size: 10px; }
        .calendar-reservation { font-size: 10px; padding: 3px 4px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; flex-direction: column; line-height: 1.2; position: relative; }
        .calendar-reservation .time { font-weight: 600; }
        .calendar-reservation .name { font-weight: 500; font-size: 9px; }
        .calendar-reservation .room-type { font-weight: 400; font-size: 8px; font-style: italic; }
        .calendar-reservation .duration { font-weight: 400; font-size: 8px; font-style: italic; color: var(--text-secondary); }
        .reservation-confirmed { background-color: rgba(16, 185, 129, 0.1); color: var(--success-color); border-left: 2px solid var(--success-color); }
        .reservation-pending { background-color: rgba(245, 158, 11, 0.1); color: var(--warning-color); border-left: 2px solid var(--warning-color); }
        .reservation-cancelled { background-color: rgba(239, 68, 68, 0.1); color: var(--danger-color); border-left: 2px solid var(--danger-color); }
        .reservation-multi-day-start { border-top-left-radius: 3px; border-bottom-left-radius: 3px; border-top-right-radius: 0; border-bottom-right-radius: 0; margin-right: -1px; }
        .reservation-multi-day-middle { border-radius: 0; margin: 0 -1px; }
        .reservation-multi-day-end { border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-top-left-radius: 0; border-bottom-left-radius: 0; margin-left: -1px; }
        .reservation-multi-day-middle .time, .reservation-multi-day-middle .name, .reservation-multi-day-middle .room-type, .reservation-multi-day-middle .duration, .reservation-multi-day-end .time, .reservation-multi-day-end .name, .reservation-multi-day-end .room-type, .reservation-multi-day-end .duration { display: none; }
        .reservation-multi-day-middle::after, .reservation-multi-day-end::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: inherit; opacity: 0.3; z-index: 1; }
        .reservation-room-single { background-color: rgba(14, 165, 233, 0.1); color: var(--accent-color); border-left: 2px solid var(--accent-color); }
        .reservation-room-double { background-color: rgba(139, 92, 246, 0.1); color: var(--expense-color); border-left: 2px solid var(--expense-color); }
        .reservation-room-suite { background-color: rgba(245, 158, 11, 0.1); color: var(--warning-color); border-left: 2px solid var(--warning-color); }
        .reservation-room-vip { background-color: rgba(239, 68, 68, 0.1); color: var(--danger-color); border-left: 2px solid var(--danger-color); }
        .reservation-room-family { background-color: rgba(16, 185, 129, 0.1); color: var(--success-color); border-left: 2px solid var(--success-color); }
        .reservation-room-deluxe { background-color: rgba(37, 99, 235, 0.1); color: var(--primary-color); border-left: 2px solid var(--primary-color); }
        .calendar-reservation-count { position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; }
        .calendar-reservation-details { background-color: var(--card-bg); border-radius: var(--radius-lg); padding: 24px; border: 1px solid var(--border-color); }
        .calendar-details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .calendar-details-date { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        .calendar-reservation-list { display: flex; flex-direction: column; gap: 12px; }
        .calendar-reservation-item { padding: 16px; border: 1px solid var(--border-color); border-radius: var(--radius-md); display: flex; flex-direction: column; gap: 8px; transition: var(--transition); background-color: white; }
        .calendar-reservation-item:hover { background-color: var(--light-bg); }
        .calendar-reservation-header { display: flex; justify-content: space-between; align-items: center; }
        .calendar-reservation-title { font-weight: 600; font-size: 16px; }
        .calendar-reservation-detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; margin-top: 8px; }
        .calendar-reservation-detail { font-size: 13px; }
        .calendar-reservation-detail strong { color: var(--text-secondary); font-weight: 600; }
        .calendar-no-reservations { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .calendar-view-switcher { display: flex; gap: 8px; margin-bottom: 20px; }
        .calendar-view-btn { padding: 8px 16px; border: 1px solid var(--border-color); background-color: var(--light-bg); border-radius: var(--radius-md); font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: var(--transition); }
        .calendar-view-btn:hover { background-color: #e2e8f0; }
        .calendar-view-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .calendar-monthly-view { display: block; }
        .calendar-weekly-view { display: none; }
        .calendar-week-grid { display: flex; flex-direction: column; gap: 8px; }
        .calendar-week-day { display: flex; align-items: center; padding: 12px 16px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-md); }
        .calendar-week-day-header { min-width: 100px; font-weight: 600; color: var(--text-primary); }
        .calendar-week-reservations { display: flex; flex-wrap: wrap; gap: 8px; flex-grow: 1; }
        .calendar-reservation-detail-card { background-color: var(--light-bg); border-radius: var(--radius-md); padding: 16px; margin-top: 8px; border: 1px solid var(--border-color); }
        .calendar-reservation-detail-card h4 { font-size: 14px; font-weight: 600; color: var(--primary-color); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .calendar-reservation-detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .calendar-reservation-detail-item { font-size: 13px; }
        .calendar-reservation-detail-item strong { color: var(--text-primary); font-weight: 600; display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-secondary); }
        .calendar-reservation-detail-item span { color: var(--text-primary); font-weight: 500; }
        .reservation-duration-display { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background-color: rgba(37, 99, 235, 0.1); border-radius: 20px; font-size: 12px; font-weight: 600; color: var(--primary-color); margin-top: 8px; }
        .reservation-duration-display i { font-size: 11px; }
    </style>
</head>
<body>
    <!-- ========== FULL HTML STRUCTURE (modified) ========== -->
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon"><i class="fas fa-calendar-alt"></i></div>
                    <div><div class="logo-text">Reservation Pro</div><div class="logo-subtext">BUSINESS EDITION</div></div>
                </div>
            </div>
            <div class="nav-menu">
                <a href="#" class="nav-item active" id="dashboard-tab-btn"><i class="fas fa-home"></i>Dashboard</a>
                <a href="#" class="nav-item" id="calendar-tab-btn"><i class="fas fa-calendar"></i>Calendar</a>
                <a href="#" class="nav-item" id="expenses-tab-btn"><i class="fas fa-money-bill-wave"></i>Expenses</a>
                <a href="#" class="nav-item" id="analytics-tab-btn"><i class="fas fa-chart-bar"></i>Analytics</a>
                <a href="#" class="nav-item" id="settings-tab-btn"><i class="fas fa-cog"></i>Settings</a>
            </div>
            <div class="sidebar-footer"><div>Reservation Manager Pro v2.1</div><div style="font-size: 11px;">Â© 2023 Business Solutions Inc.</div></div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-title"><h1 id="page-title">Reservation Dashboard</h1><p id="page-subtitle">Manage bookings, custom fields, and business expenses</p></div>
                <div class="header-actions">
                    <button class="btn btn-secondary btn-sm" id="export-dashboard-btn"><i class="fas fa-download"></i> Export Dashboard</button>
                    <button class="btn btn-primary btn-sm" id="print-btn"><i class="fas fa-print"></i> Print Report</button>
                    <div style="width:1px;height:24px;background-color:var(--border-color);"></div>
                    <div style="font-size:14px;font-weight:600;color:var(--text-primary);"><i class="fas fa-user-circle" style="margin-right:8px;"></i>Admin User</div>
                </div>
            </div>
            <!-- Dashboard Content -->
            <div class="content-wrapper" id="dashboard-content">
                <!-- Dashboard Stats -->
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-header"><div class="stat-title">Total Transfers</div><div class="stat-icon" style="background-color: var(--primary-color);"><i class="fas fa-calendar-check"></i></div></div>
                        <div class="stat-value" id="total-reservations">0</div>
                        <div class="stat-change positive"><i class="fas fa-arrow-up"></i> 12% from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><div class="stat-title">Pending Confirmations</div><div class="stat-icon" style="background-color: var(--warning-color);"><i class="fas fa-clock"></i></div></div>
                        <div class="stat-value" id="pending-reservations">0</div>
                        <div class="stat-change negative"><i class="fas fa-arrow-down"></i> 5% from last week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><div class="stat-title">Monthly Expenses</div><div class="stat-icon" style="background-color: var(--expense-color);"><i class="fas fa-money-bill-wave"></i></div></div>
                        <div class="stat-value" id="monthly-expenses">$0</div>
                        <div class="stat-change negative"><i class="fas fa-arrow-up"></i> 8% from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><div class="stat-title">Net Revenue</div><div class="stat-icon" style="background-color: var(--success-color);"><i class="fas fa-dollar-sign"></i></div></div>
                        <div class="stat-value" id="net-revenue">$0</div>
                        <div class="stat-change positive"><i class="fas fa-arrow-up"></i> 15% from last month</div>
                    </div>
                </div>

                <!-- Main Panels -->
                <div class="panel-container">
                    <!-- Add Custom Fields Panel (with edit/delete list) -->
                    <div class="panel">
                        <div class="panel-header"><h2><i class="fas fa-plus-circle"></i> Custom Fields</h2></div>
                        <div class="panel-body">
                            <div class="form-group"><label class="form-label">Field Name</label><input type="text" class="form-control" id="field-name" placeholder="e.g., Deposit Amount"></div>
                            <div class="form-group">
                                <label class="form-label">Field Type</label>
                                <div class="column-types">
                                    <div class="type-option" data-type="text"><div class="type-icon"><i class="fas fa-font"></i></div><div class="type-name">Text</div></div>
                                    <div class="type-option" data-type="checkbox"><div class="type-icon"><i class="fas fa-check-square"></i></div><div class="type-name">Checkbox</div></div>
                                    <div class="type-option" data-type="currency"><div class="type-icon"><i class="fas fa-dollar-sign"></i></div><div class="type-name">Currency</div></div>
                                    <div class="type-option" data-type="status"><div class="type-icon"><i class="fas fa-circle"></i></div><div class="type-name">Status</div></div>
                                    <div class="type-option" data-type="date"><div class="type-icon"><i class="fas fa-calendar"></i></div><div class="type-name">Date</div></div>
                                    <div class="type-option" data-type="email"><div class="type-icon"><i class="fas fa-envelope"></i></div><div class="type-name">Email</div></div>
                                    <div class="type-option" data-type="number"><div class="type-icon"><i class="fas fa-hashtag"></i></div><div class="type-name">Number</div></div>
                                    <div class="type-option" data-type="dropdown"><div class="type-icon"><i class="fas fa-list"></i></div><div class="type-name">Dropdown</div></div>
                                </div>
                            </div>
                            <div class="form-group" id="dropdown-options-container" style="display: none;"><label class="form-label">Dropdown Options (comma separated)</label><input type="text" class="form-control" id="dropdown-options" placeholder="e.g., Option 1, Option 2"></div>
                            <div class="form-group"><label class="form-label">Default Value (Optional)</label><input type="text" class="form-control" id="field-default" placeholder="Leave empty"></div>
                            <div style="display: flex; gap: 12px; margin-top: 24px;">
                                <button class="btn btn-primary" id="add-field-btn"><i class="fas fa-plus"></i> Add Field</button>
                                <button class="btn btn-secondary" id="clear-fields-btn"><i class="fas fa-trash-alt"></i> Clear All</button>
                            </div>
                            <!-- List of existing fields with edit/delete -->
                            <div style="margin-top: 30px;">
                                <h4 style="margin-bottom: 10px;">Existing Fields</h4>
                                <div id="custom-fields-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 10px;"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Add Reservation Panel (Room Type dropdown, Transfer Amount, Meal Price, Check-in/out times) -->
                    <div class="panel">
                        <div class="panel-header"><h2><i class="fas fa-calendar-plus"></i> New Reservation</h2><div style="margin-top: 10px; font-size: 13px; color: var(--text-secondary);"><i class="fas fa-info-circle"></i> Drag the <i class="fas fa-grip-vertical"></i> handle to reorder fields</div></div>
                        <div class="panel-body">
                            <div class="reorder-instructions">
                                <i class="fas fa-arrows-alt"></i>
                                <span>Drag the <i class="fas fa-grip-vertical" style="margin: 0 4px;"></i> handle on the left to reorder custom fields below</span>
                            </div>
                            <!-- Room Type dropdown -->
                            <div class="form-group"><label class="form-label">Room Type <span>*</span></label>
                                <select class="form-control" id="reservation-room">
                                    <option value="">Select Room Type</option>
                                    <option value="Apartment 1">Apartment 1</option>
                                    <option value="Apartment 2">Apartment 2</option>
                                    <option value="Studio">Studio</option>
                                    <option value="Villa">Villa</option>
                                    <option value="Horizon">Horizon</option>
                                </select>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div class="form-group"><label class="form-label">Check-in Date <span>*</span></label><input type="date" class="form-control" id="reservation-checkin"></div>
                                <div class="form-group"><label class="form-label">Check-out Date <span>*</span></label><input type="date" class="form-control" id="reservation-checkout"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div class="form-group"><label class="form-label">Check-in Time <span>*</span></label><input type="time" class="form-control" id="reservation-time"></div>
                                <div class="form-group"><label class="form-label">Check-out Time <span>*</span></label><input type="time" class="form-control" id="reservation-checkout-time"></div>
                            </div>
                            <!-- Transfer and Meal -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div class="form-group"><label class="form-label">Transfer Amount ($)</label><input type="number" class="form-control" id="reservation-transfer" step="0.01" min="0" value="0"></div>
                                <div class="form-group"><label class="form-label">Meal Price ($)</label><input type="number" class="form-control" id="reservation-meal" step="0.01" min="0" value="0"></div>
                            </div>
                            <div class="form-group" id="duration-display" style="display: none;"><div class="reservation-duration-display"><i class="fas fa-moon"></i><span id="duration-days">0</span> nights stay</div></div>
                            <div id="custom-fields-container"></div>
                            <div style="display: flex; gap: 12px; margin-top: 24px;"><button class="btn btn-success" id="add-reservation-btn"><i class="fas fa-save"></i> Save Reservation</button><button class="btn btn-secondary" id="clear-form-btn"><i class="fas fa-eraser"></i> Clear Form</button><button class="btn btn-secondary" id="reset-order-btn" style="display: none;"><i class="fas fa-undo"></i> Reset Order</button></div>
                        </div>
                    </div>
                </div>

                <!-- Active Filters -->
                <div class="active-filters" id="active-filters" style="display: none;"></div>

                <!-- Reservations Table (with Transfer and Meal columns) -->
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title"><i class="fas fa-table"></i> All Reservations <span id="reservation-count-badge" style="background-color: var(--primary-color); color: white; padding: 4px 10px; border-radius: 20px; font-size: 13px; margin-left: 10px;">0</span></div>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" id="refresh-table-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                            <button class="btn btn-primary btn-sm" id="filter-table-btn"><i class="fas fa-filter"></i> Filter</button>
                            <button class="btn btn-secondary btn-sm" id="clear-filters-btn" style="display: none;"><i class="fas fa-times"></i> Clear Filters</button>
                            <button class="btn btn-success btn-sm" id="export-reservations-btn"><i class="fas fa-file-excel"></i> Export</button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table" id="reservations-table">
                            <thead id="reservations-thead"><tr><th>Room Type</th><th>Check-in</th><th>Check-out</th><th>Duration</th><th>Check-in Time</th><th>Check-out Time</th><th>Transfer ($)</th><th>Meal ($)</th><th>Actions</th></tr></thead>
                            <tbody id="reservations-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Calendar Content (enhanced details) -->
            <div class="content-wrapper" id="calendar-content" style="display: none;">
                <div class="calendar-header">
                    <div class="calendar-navigation">
                        <button class="btn btn-secondary btn-sm" id="calendar-prev-month"><i class="fas fa-chevron-left"></i></button>
                        <div class="calendar-current-month" id="calendar-month-year">January 2023</div>
                        <button class="btn btn-secondary btn-sm" id="calendar-next-month"><i class="fas fa-chevron-right"></i></button>
                        <button class="btn btn-primary btn-sm" id="calendar-today"><i class="fas fa-calendar-day"></i> Today</button>
                    </div>
                    <div class="calendar-view-switcher">
                        <button class="calendar-view-btn active" id="calendar-month-view-btn"><i class="fas fa-calendar-alt"></i> Month</button>
                        <button class="calendar-view-btn" id="calendar-week-view-btn"><i class="fas fa-calendar-week"></i> Week</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar-days-headers">
                    <div class="calendar-day-header">Sun</div><div class="calendar-day-header">Mon</div><div class="calendar-day-header">Tue</div><div class="calendar-day-header">Wed</div><div class="calendar-day-header">Thu</div><div class="calendar-day-header">Fri</div><div class="calendar-day-header">Sat</div>
                </div>
                <div class="calendar-grid" id="calendar-days-grid"></div>
                <div class="calendar-reservation-details" id="calendar-reservation-details">
                    <div class="calendar-details-header">
                        <div class="calendar-details-date" id="selected-date-title">Select a date</div>
                        <button class="btn btn-primary btn-sm" id="add-reservation-from-calendar"><i class="fas fa-plus"></i> Add</button>
                    </div>
                    <div class="calendar-reservation-list" id="selected-date-reservations"></div>
                </div>
            </div>

            <!-- Expenses Content (unchanged) -->
            <div class="content-wrapper" id="expenses-content" style="display: none;">
                <!-- Stats -->
                <div class="dashboard-stats">
                    <div class="stat-card"><div class="stat-header"><div class="stat-title">Total Expenses</div><div class="stat-icon" style="background-color: var(--expense-color);"><i class="fas fa-money-bill-wave"></i></div></div><div class="stat-value" id="total-expenses">$0</div><div class="stat-change negative"><i class="fas fa-arrow-up"></i> 8% from last month</div></div>
                    <div class="stat-card"><div class="stat-header"><div class="stat-title">This Month</div><div class="stat-icon" style="background-color: var(--accent-color);"><i class="fas fa-calendar"></i></div></div><div class="stat-value" id="month-expenses">$0</div><div class="stat-change positive"><i class="fas fa-arrow-down"></i> 5% from last month</div></div>
                    <div class="stat-card"><div class="stat-header"><div class="stat-title">Highest Category</div><div class="stat-icon" style="background-color: var(--danger-color);"><i class="fas fa-chart-pie"></i></div></div><div class="stat-value" id="highest-category">Supplies</div><div class="stat-change negative"><i class="fas fa-arrow-up"></i> 15% of total</div></div>
                </div>

                <!-- Category Management -->
                <div class="category-management">
                    <div class="categories-sidebar">
                        <div class="panel-header"><h2><i class="fas fa-folder"></i> Expense Categories</h2><button class="btn btn-primary btn-sm" id="add-category-btn"><i class="fas fa-plus"></i> Add Category</button></div>
                        <div class="categories-list" id="categories-list"></div>
                    </div>
                    <div class="panel">
                        <div class="panel-header"><h2><i class="fas fa-edit"></i> <span id="category-form-title">Add New Category</span></h2></div>
                        <div class="panel-body">
                            <div class="form-group"><label class="form-label">Category Name <span>*</span></label><input type="text" class="form-control" id="category-name" placeholder="e.g., Office Supplies"></div>
                            <div class="form-group"><label class="form-label">Description</label><textarea class="form-control" id="category-description" rows="3"></textarea></div>
                            <div class="form-group"><label class="form-label">Category Color</label><div class="color-picker" id="category-color-picker">
                                <div class="color-option" data-color="#8b5cf6" style="background-color: #8b5cf6;"></div>
                                <div class="color-option" data-color="#0ea5e9" style="background-color: #0ea5e9;"></div>
                                <div class="color-option" data-color="#10b981" style="background-color: #10b981;"></div>
                                <div class="color-option" data-color="#f59e0b" style="background-color: #f59e0b;"></div>
                                <div class="color-option" data-color="#ef4444" style="background-color: #ef4444;"></div>
                                <div class="color-option" data-color="#2563eb" style="background-color: #2563eb;"></div>
                                <div class="color-option" data-color="#7c3aed" style="background-color: #7c3aed;"></div>
                                <div class="color-option" data-color="#059669" style="background-color: #059669;"></div>
                                <div class="color-option" data-color="#dc2626" style="background-color: #dc2626;"></div>
                                <div class="color-option" data-color="#475569" style="background-color: #475569;"></div>
                            </div><input type="hidden" id="category-color" value="#8b5cf6"></div>
                            <div class="form-group"><label class="form-label">Category Icon</label><div class="icon-picker" id="category-icon-picker"></div><input type="hidden" id="category-icon" value="fas fa-box"></div>
                            <div class="form-group"><label class="form-label">Budget (Monthly)</label><input type="number" class="form-control" id="category-budget" step="0.01" min="0"></div>
                            <div style="display: flex; gap: 12px; margin-top: 24px;">
                                <button class="btn btn-primary" id="save-category-btn"><i class="fas fa-save"></i> Save Category</button>
                                <button class="btn btn-secondary" id="cancel-category-btn" style="display: none;"><i class="fas fa-times"></i> Cancel Edit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expense Form & Filters -->
                <div class="panel-container">
                    <div class="panel">
                        <div class="panel-header"><h2><i class="fas fa-plus-circle"></i> Add New Expense</h2></div>
                        <div class="panel-body">
                            <div class="form-group"><label class="form-label">Expense Name <span>*</span></label><input type="text" class="form-control" id="expense-name" placeholder="e.g., Office Supplies"></div>
                            <div class="form-group"><label class="form-label">Category <span>*</span></label><select class="form-control" id="expense-category"><option value="">Select a category</option></select></div>
                            <div class="form-group"><label class="form-label">Amount <span>*</span></label><input type="number" class="form-control" id="expense-amount" step="0.01" min="0"></div>
                            <div class="form-group"><label class="form-label">Date <span>*</span></label><input type="date" class="form-control" id="expense-date"></div>
                            <div class="form-group"><label class="form-label">Payment Method</label><select class="form-control" id="expense-payment"><option value="cash">Cash</option><option value="credit_card">Credit Card</option><option value="bank_transfer">Bank Transfer</option><option value="check">Check</option><option value="other">Other</option></select></div>
                            <div class="form-group"><label class="form-label">Description</label><textarea class="form-control" id="expense-description" rows="3"></textarea></div>
                            <div class="form-group"><label class="form-label">Status <span>*</span></label><select class="form-control" id="expense-status"><option value="paid">Paid</option><option value="pending" selected>Pending</option></select></div>
                            <div style="display: flex; gap: 12px; margin-top: 24px;"><button class="btn btn-expense" id="add-expense-btn"><i class="fas fa-plus"></i> Add Expense</button><button class="btn btn-secondary" id="clear-expense-form-btn"><i class="fas fa-eraser"></i> Clear Form</button></div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header"><h2><i class="fas fa-filter"></i> Filter Expenses</h2></div>
                        <div class="panel-body">
                            <div class="form-group"><label class="form-label">Expense Name</label><input type="text" class="form-control" id="expense-filter-name" placeholder="Filter by name"></div>
                            <div class="form-group"><label class="form-label">Category</label><select class="form-control" id="expense-filter-category"><option value="">All Categories</option></select></div>
                            <div class="form-group"><label class="form-label">Status</label><select class="form-control" id="expense-filter-status"><option value="">All Statuses</option><option value="paid">Paid</option><option value="pending">Pending</option></select></div>
                            <div class="form-group"><label class="form-label">Date Range</label><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><input type="date" class="form-control" id="expense-filter-date-from"><input type="date" class="form-control" id="expense-filter-date-to"></div></div>
                            <div class="form-group"><label class="form-label">Amount Range</label><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><input type="number" class="form-control" id="expense-filter-amount-from" placeholder="Min"><input type="number" class="form-control" id="expense-filter-amount-to" placeholder="Max"></div></div>
                            <div style="display: flex; gap: 12px; margin-top: 24px;"><button class="btn btn-primary" id="apply-expense-filters-btn"><i class="fas fa-filter"></i> Apply Filters</button><button class="btn btn-secondary" id="clear-expense-filters-btn"><i class="fas fa-times"></i> Clear Filters</button></div>
                        </div>
                    </div>
                </div>

                <!-- Active Expense Filters -->
                <div class="active-filters" id="expense-active-filters" style="display: none;"></div>

                <!-- Expenses Table -->
                <div class="expense-table-container">
                    <div class="expense-table-header">
                        <div class="expense-table-title"><i class="fas fa-table"></i> All Expenses <span id="expense-count-badge" style="background-color: var(--expense-color); color: white; padding: 4px 10px; border-radius: 20px; font-size: 13px; margin-left: 10px;">0</span></div>
                        <div class="expense-table-actions">
                            <button class="btn btn-secondary btn-sm" id="refresh-expense-table-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                            <button class="btn btn-expense btn-sm" id="export-expenses-btn"><i class="fas fa-file-excel"></i> Export</button>
                        </div>
                    </div>
                    <div class="expense-table-wrapper">
                        <table class="expense-table" id="expenses-table">
                            <thead><tr><th>Name</th><th>Category</th><th>Amount</th><th>Date</th><th>Payment</th><th>Description</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="expenses-body"></tbody>
                        </table>
                    </div>
                    <div class="expense-summary" id="expense-summary" style="display: none;"><div class="expense-summary-left"><div class="summary-item"><span>Showing:</span><span class="summary-value" id="summary-count">0</span></div><div class="summary-item"><span>Paid:</span><span class="summary-value" id="summary-paid-count">0</span></div><div class="summary-item"><span>Pending:</span><span class="summary-value" id="summary-pending-count">0</span></div></div><div class="summary-total"><span>Total:</span><span class="summary-total-value" id="summary-total-amount">$0.00</span></div></div>
                </div>
            </div>

            <!-- Analytics Content -->
            <div class="content-wrapper" id="analytics-content" style="display: none;">
                <div class="analytics-filters">
                    <div class="filter-group"><label class="filter-label">Time Period</label><select class="form-control" id="analytics-period"><option value="30">Last 30 Days</option><option value="90">Last 90 Days</option><option value="180">Last 6 Months</option><option value="365">Last 12 Months</option><option value="all">All Time</option></select></div>
                    <div class="filter-group"><label class="filter-label">&nbsp;</label><button class="btn btn-primary" id="apply-analytics-filters"><i class="fas fa-filter"></i> Apply</button></div>
                    <div class="filter-group"><label class="filter-label">&nbsp;</label><button class="btn btn-success" id="export-analytics-btn"><i class="fas fa-file-excel"></i> Export</button></div>
                </div>
                <div class="analytics-stats">
                    <div class="analytics-stat-card"><div class="analytics-stat-header"><div class="analytics-stat-title">Total Revenue</div><div class="analytics-stat-icon" style="background-color: var(--success-color);"><i class="fas fa-dollar-sign"></i></div></div><div class="analytics-stat-value" id="analytics-total-revenue">$0</div><div class="analytics-stat-subtitle">All income</div></div>
                    <div class="analytics-stat-card"><div class="analytics-stat-header"><div class="analytics-stat-title">Transfer Income</div><div class="analytics-stat-icon" style="background-color: var(--primary-color);"><i class="fas fa-truck"></i></div></div><div class="analytics-stat-value" id="analytics-transfer-income">$0</div><div class="analytics-stat-subtitle">From transfers</div></div>
                    <div class="analytics-stat-card"><div class="analytics-stat-header"><div class="analytics-stat-title">Meal Income</div><div class="analytics-stat-icon" style="background-color: var(--warning-color);"><i class="fas fa-utensils"></i></div></div><div class="analytics-stat-value" id="analytics-meal-income">$0</div><div class="analytics-stat-subtitle">From meals</div></div>
                    <div class="analytics-stat-card"><div class="analytics-stat-header"><div class="analytics-stat-title">Total Expenses</div><div class="analytics-stat-icon" style="background-color: var(--danger-color);"><i class="fas fa-money-bill-wave"></i></div></div><div class="analytics-stat-value" id="analytics-total-expenses">$0</div><div class="analytics-stat-subtitle">All expenses</div></div>
                </div>
                <div class="comparison-cards">
                    <div class="comparison-card"><div class="comparison-header"><div class="comparison-title">This Month</div><div class="comparison-value" id="this-month-profit">$0</div></div><div class="comparison-details"><div class="comparison-row"><div class="comparison-label">Income</div><div class="comparison-amount income-amount" id="this-month-income">$0</div></div><div class="comparison-row"><div class="comparison-label">Expenses</div><div class="comparison-amount expense-amount" id="this-month-expenses">$0</div></div><div class="comparison-row"><div class="comparison-label">Net Profit</div><div class="comparison-amount" id="this-month-net">$0</div></div></div></div>
                    <div class="comparison-card"><div class="comparison-header"><div class="comparison-title">Last Month</div><div class="comparison-value" id="last-month-profit">$0</div></div><div class="comparison-details"><div class="comparison-row"><div class="comparison-label">Income</div><div class="comparison-amount income-amount" id="last-month-income">$0</div></div><div class="comparison-row"><div class="comparison-label">Expenses</div><div class="comparison-amount expense-amount" id="last-month-expenses">$0</div></div><div class="comparison-row"><div class="comparison-label">Net Profit</div><div class="comparison-amount" id="last-month-net">$0</div></div></div></div>
                </div>
                <div class="panel-container">
                    <div class="chart-container"><div class="chart-header"><h3><i class="fas fa-chart-bar"></i> Income vs Expenses</h3></div><div class="chart-body"><canvas id="incomeExpenseChart"></canvas></div></div>
                    <div class="chart-container"><div class="chart-header"><h3><i class="fas fa-pie-chart"></i> Expense by Category</h3></div><div class="chart-body"><canvas id="expenseCategoryChart"></canvas></div></div>
                </div>
                <div class="panel-container">
                    <div class="chart-container"><div class="chart-header"><h3><i class="fas fa-chart-line"></i> Monthly Revenue by Type</h3></div><div class="chart-body"><canvas id="monthlyTrendChart"></canvas></div></div>
                    <div class="chart-container"><div class="chart-header"><h3><i class="fas fa-percentage"></i> Profit Margin</h3></div><div class="chart-body"><canvas id="profitMarginChart"></canvas></div></div>
                </div>
                <div class="chart-container"><div class="chart-header"><h3><i class="fas fa-table"></i> Detailed Analytics</h3></div><div class="panel-body"><table class="data-table"><thead><tr><th>Period</th><th>Reservations</th><th>Transfer Income</th><th>Meal Income</th><th>Total Income</th><th>Expenses</th><th>Monthly Profit</th><th>Total Profit</th><th>Margin</th></tr></thead><tbody id="analytics-body"></tbody></table></div></div>
            </div>

            <!-- Settings Content -->
            <div class="content-wrapper" id="settings-content" style="display: none;"><div class="panel"><div class="panel-header"><h2><i class="fas fa-cog"></i> System Settings</h2></div><div class="panel-body"><div class="empty-state"><i class="fas fa-cog"></i><h3>Configuration</h3><p>Settings will be available soon.</p></div></div></div></div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="edit-reservation-modal">
        <div class="modal-content"><div class="modal-header"><div class="modal-title">Edit Reservation</div><button class="modal-close" id="close-edit-reservation-modal"><i class="fas fa-times"></i></button></div><div class="modal-body" id="edit-reservation-body"></div><div class="modal-footer"><button class="btn btn-secondary" id="cancel-edit-reservation-btn">Cancel</button><button class="btn btn-primary" id="save-edit-reservation-btn">Save Changes</button></div></div>
    </div>
    <div class="modal" id="edit-category-modal">
        <div class="modal-content"><div class="modal-header"><div class="modal-title">Edit Category</div><button class="modal-close" id="close-edit-category-modal"><i class="fas fa-times"></i></button></div><div class="modal-body"><div class="form-group"><label>Name</label><input type="text" id="edit-category-name" class="form-control"></div><div class="form-group"><label>Description</label><textarea id="edit-category-description" class="form-control"></textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" id="cancel-edit-category-btn">Cancel</button><button class="btn btn-primary" id="save-edit-category-btn">Save</button></div></div>
    </div>
    <div class="modal" id="edit-expense-modal">
        <div class="modal-content"><div class="modal-header"><div class="modal-title">Edit Expense</div><button class="modal-close" id="close-edit-expense-modal"><i class="fas fa-times"></i></button></div><div class="modal-body">
            <div class="form-group"><label>Name</label><input type="text" id="edit-expense-name" class="form-control"></div>
            <div class="form-group"><label>Category</label><select id="edit-expense-category" class="form-control"></select></div>
            <div class="form-group"><label>Amount</label><input type="number" id="edit-expense-amount" class="form-control" step="0.01"></div>
            <div class="form-group"><label>Date</label><input type="date" id="edit-expense-date" class="form-control"></div>
            <div class="form-group"><label>Payment</label><select id="edit-expense-payment" class="form-control"><option value="cash">Cash</option><option value="credit_card">Credit Card</option><option value="bank_transfer">Bank Transfer</option><option value="check">Check</option><option value="other">Other</option></select></div>
            <div class="form-group"><label>Description</label><textarea id="edit-expense-description" class="form-control"></textarea></div>
            <div class="form-group"><label>Status</label><select id="edit-expense-status" class="form-control"><option value="paid">Paid</option><option value="pending">Pending</option></select></div>
        </div><div class="modal-footer"><button class="btn btn-secondary" id="cancel-edit-expense-btn">Cancel</button><button class="btn btn-primary" id="save-edit-expense-btn">Save</button></div></div>
    </div>
    <div class="modal" id="filter-reservation-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header"><div class="modal-title"><i class="fas fa-filter"></i> Filter Reservations</div><button class="modal-close" id="close-filter-reservation-modal"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="filter-reservation-body">
                <!-- Room Type filter -->
                <div class="form-group"><label class="form-label">Room Type</label>
                    <select class="form-control" id="filter-room">
                        <option value="">All</option>
                        <option value="Apartment 1">Apartment 1</option>
                        <option value="Apartment 2">Apartment 2</option>
                        <option value="Studio">Studio</option>
                        <option value="Villa">Villa</option>
                        <option value="Horizon">Horizon</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group"><label class="form-label">Check-in From</label><input type="date" class="form-control" id="filter-checkin-from"></div>
                    <div class="form-group"><label class="form-label">Check-in To</label><input type="date" class="form-control" id="filter-checkin-to"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group"><label class="form-label">Check-out From</label><input type="date" class="form-control" id="filter-checkout-from"></div>
                    <div class="form-group"><label class="form-label">Check-out To</label><input type="date" class="form-control" id="filter-checkout-to"></div>
                </div>
                <div id="custom-field-filters"></div>
                <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <div class="form-group"><label class="form-label">Sort By</label><select class="form-control" id="filter-sort-by"><option value="checkin">Check-in (newest)</option><option value="checkin_oldest">Check-in (oldest)</option><option value="name">Room Type A-Z</option></select></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" id="clear-all-filters-btn">Clear All</button><button class="btn btn-primary" id="apply-filters-btn">Apply Filters</button></div>
        </div>
    </div>

    <!-- ========== FIREBASE SCRIPT (modified) ========== -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc,
            query, orderBy, where, writeBatch
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD0YaoF4Ux9Bm_ZmnrZGFxQcDv2ayicx5c",
            authDomain: "easyreservtionsmom.firebaseapp.com",
            projectId: "easyreservtionsmom",
            storageBucket: "easyreservtionsmom.firebasestorage.app",
            messagingSenderId: "550628889531",
            appId: "1:550628889531:web:9c957a45d8a6552fc66a9e"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const customFieldsCol = collection(db, 'customFields');
        const reservationsCol = collection(db, 'reservations');
        const expenseCategoriesCol = collection(db, 'expenseCategories');
        const expensesCol = collection(db, 'expenses');
        const settingsCol = collection(db, 'settings');

        // State
        const state = {
            customFields: [], reservations: [], expenseCategories: [], expenses: [],
            selectedFieldType: 'text', editingReservationId: null, editingExpenseId: null,
            deletingReservationId: null, deletingExpenseId: null,
            activeFilters: {}, activeExpenseFilters: {},
            filteredReservations: null, filteredExpenses: null,
            fieldOrder: [], currentPage: 'dashboard', selectedCategoryId: null,
            editingCategoryId: null, deletingCategoryId: null,
            currentCalendarDate: new Date(), selectedCalendarDate: null, calendarView: 'month',
            charts: {}
        };

        // Helper functions
        function showNotification(msg, type = 'info') {
            const n = document.createElement('div');
            n.style.cssText = `position:fixed;top:20px;right:20px;padding:16px 24px;border-radius:var(--radius-md);font-weight:600;z-index:1000;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:10px;animation:slideIn 0.3s ease;`;
            n.style.backgroundColor = type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--danger-color)' : 'var(--primary-color)';
            n.style.color = 'white';
            n.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':type==='error'?'fa-exclamation-circle':'fa-info-circle'}"></i> ${msg}`;
            document.body.appendChild(n);
            setTimeout(() => { n.style.animation = 'slideOut 0.3s ease'; setTimeout(() => n.remove(), 300); }, 3000);
        }
        function calculateDuration(checkin, checkout) {
            return Math.max(0, Math.ceil((new Date(checkout) - new Date(checkin)) / (1000*60*60*24)));
        }

        // Load data
        async function loadAllData() {
            try {
                const [customSnap, resSnap, catSnap, expSnap, settingsSnap] = await Promise.all([
                    getDocs(query(customFieldsCol, orderBy('createdAt'))),
                    getDocs(query(reservationsCol, orderBy('createdAt', 'desc'))),
                    getDocs(query(expenseCategoriesCol, orderBy('createdAt'))),
                    getDocs(query(expensesCol, orderBy('createdAt', 'desc'))),
                    getDocs(settingsCol)
                ]);
                state.customFields = customSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                state.reservations = resSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                state.expenseCategories = catSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                state.expenses = expSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                if (!settingsSnap.empty) {
                    const settingsData = settingsSnap.docs[0].data();
                    state.fieldOrder = settingsData.fieldOrder || [];
                    state.activeExpenseFilters = settingsData.expenseFilters || {};
                } else {
                    state.fieldOrder = state.customFields.map(f => f.id);
                    if (state.fieldOrder.length) await addDoc(settingsCol, { fieldOrder: state.fieldOrder, expenseFilters: {} });
                }

                applyExpenseFiltersFromState();
                renderCustomFieldsList();
                renderCustomFields();
                renderReservationsTable();
                renderCategories();
                updateCategoryDropdowns();
                renderExpensesTable();
                updateStats();
                if (state.currentPage === 'calendar') renderCalendar();
                if (state.currentPage === 'analytics') renderAnalytics();
                showNotification('Data loaded', 'success');
            } catch (e) { console.error(e); showNotification('Load failed', 'error'); }
        }

        // Save settings
        async function saveSettings() {
            try {
                const snap = await getDocs(settingsCol);
                const data = { fieldOrder: state.fieldOrder, expenseFilters: state.activeExpenseFilters };
                if (!snap.empty) {
                    await updateDoc(doc(db, 'settings', snap.docs[0].id), data);
                } else {
                    await addDoc(settingsCol, data);
                }
            } catch (e) { console.error(e); }
        }

        // Custom Fields (unchanged)
        async function addCustomField() {
            const name = document.getElementById('field-name').value.trim();
            const def = document.getElementById('field-default').value.trim();
            if (!name) { showNotification('Field name required', 'error'); return; }
            if (state.customFields.some(f => f.name.toLowerCase() === name.toLowerCase())) {
                showNotification('Field name exists', 'error'); return;
            }
            const newField = {
                name, type: state.selectedFieldType, defaultValue: def || null,
                createdAt: new Date().toISOString()
            };
            if (state.selectedFieldType === 'dropdown') {
                const opts = document.getElementById('dropdown-options').value.trim();
                if (!opts) { showNotification('Dropdown options required', 'error'); return; }
                newField.options = opts.split(',').map(s => s.trim()).filter(Boolean);
            }
            try {
                await addDoc(customFieldsCol, newField);
                await loadAllData();
                document.getElementById('field-name').value = '';
                document.getElementById('field-default').value = '';
                document.getElementById('dropdown-options').value = '';
                showNotification('Field added', 'success');
            } catch (e) { console.error(e); showNotification('Error adding field', 'error'); }
        }

        async function deleteCustomField(id) {
            if (!confirm('Delete this custom field? All associated data in reservations will be lost.')) return;
            try {
                await deleteDoc(doc(db, 'customFields', id));
                await loadAllData();
                showNotification('Field deleted', 'success');
            } catch (e) { console.error(e); showNotification('Delete failed', 'error'); }
        }

        async function updateCustomField(id, newName, newDefault) {
            try {
                await updateDoc(doc(db, 'customFields', id), { name: newName, defaultValue: newDefault });
                await loadAllData();
                showNotification('Field updated', 'success');
            } catch (e) { console.error(e); showNotification('Update failed', 'error'); }
        }

        function renderCustomFieldsList() {
            const listDiv = document.getElementById('custom-fields-list');
            if (!listDiv) return;
            listDiv.innerHTML = '';
            if (state.customFields.length === 0) {
                listDiv.innerHTML = '<p class="empty-state" style="padding:20px;">No custom fields yet.</p>';
                return;
            }
            state.customFields.forEach(field => {
                const item = document.createElement('div');
                item.style.display = 'flex'; item.style.justifyContent = 'space-between'; item.style.alignItems = 'center'; item.style.padding = '8px'; item.style.borderBottom = '1px solid var(--border-color)';
                item.innerHTML = `
                    <span><strong>${field.name}</strong> (${field.type})</span>
                    <div>
                        <button class="btn-icon edit" data-id="${field.id}" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon delete" data-id="${field.id}" title="Delete"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                item.querySelector('.edit')?.addEventListener('click', () => {
                    const newName = prompt('Enter new field name:', field.name);
                    if (newName && newName.trim()) {
                        const newDefault = prompt('Enter new default value (optional):', field.defaultValue || '');
                        updateCustomField(field.id, newName.trim(), newDefault || null);
                    }
                });
                item.querySelector('.delete')?.addEventListener('click', () => deleteCustomField(field.id));
                listDiv.appendChild(item);
            });
        }

        // Reservations (modified: includes transferAmount, mealPrice, checkinTime, checkoutTime)
        async function addReservation() {
            const room = document.getElementById('reservation-room').value;
            const checkin = document.getElementById('reservation-checkin').value;
            const checkout = document.getElementById('reservation-checkout').value;
            const time = document.getElementById('reservation-time').value; // check-in time
            const checkoutTime = document.getElementById('reservation-checkout-time').value;
            const transferAmount = parseFloat(document.getElementById('reservation-transfer').value) || 0;
            const mealPrice = parseFloat(document.getElementById('reservation-meal').value) || 0;
            if (!room || !checkin || !checkout || !time || !checkoutTime) { showNotification('Fill all required fields', 'error'); return; }
            if (new Date(checkout) < new Date(checkin)) { showNotification('Check-out after check-in', 'error'); return; }
            const duration = calculateDuration(checkin, checkout);
            const newRes = { 
                name: room, 
                checkin, 
                checkout, 
                duration, 
                time, // check-in time
                checkoutTime,
                transferAmount, 
                mealPrice, 
                createdAt: new Date().toISOString() 
            };
            state.customFields.forEach(f => {
                const el = document.getElementById(f.id);
                if (el) newRes[f.id] = f.type === 'checkbox' ? el.checked : el.value;
            });
            try {
                await addDoc(reservationsCol, newRes);
                await loadAllData();
                clearForm();
                showNotification('Reservation added', 'success');
            } catch (e) { console.error(e); showNotification('Error adding reservation', 'error'); }
        }

        async function deleteReservation(id) {
            try {
                await deleteDoc(doc(db, 'reservations', id));
                await loadAllData();
                showNotification('Reservation deleted', 'success');
            } catch (e) { console.error(e); showNotification('Error deleting', 'error'); }
        }

        async function updateReservation(id, data) {
            try {
                await updateDoc(doc(db, 'reservations', id), data);
                await loadAllData();
                showNotification('Reservation updated', 'success');
            } catch (e) { console.error(e); showNotification('Update failed', 'error'); }
        }

        function clearForm() {
            document.getElementById('reservation-room').value = '';
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now()+86400000).toISOString().split('T')[0];
            document.getElementById('reservation-checkin').value = today;
            document.getElementById('reservation-checkout').value = tomorrow;
            document.getElementById('reservation-time').value = '12:00';
            document.getElementById('reservation-checkout-time').value = '10:00';
            document.getElementById('reservation-transfer').value = '0';
            document.getElementById('reservation-meal').value = '0';
            state.customFields.forEach(f => {
                const el = document.getElementById(f.id);
                if (el) {
                    if (f.type === 'checkbox') el.checked = f.defaultValue === 'true';
                    else el.value = f.defaultValue || '';
                }
            });
        }

        // Categories (unchanged)
        async function addCategory() {
            const name = document.getElementById('category-name').value.trim();
            if (!name) { showNotification('Category name required', 'error'); return; }
            const newCat = {
                name,
                description: document.getElementById('category-description').value.trim(),
                color: document.getElementById('category-color').value,
                icon: document.getElementById('category-icon').value,
                budget: parseFloat(document.getElementById('category-budget').value) || 0,
                createdAt: new Date().toISOString()
            };
            try {
                await addDoc(expenseCategoriesCol, newCat);
                await loadAllData();
                document.getElementById('category-name').value = '';
                document.getElementById('category-description').value = '';
                document.getElementById('category-budget').value = '';
                showNotification('Category added', 'success');
            } catch (e) { console.error(e); showNotification('Error adding category', 'error'); }
        }

        async function updateCategory(id) {
            const name = document.getElementById('category-name').value.trim();
            if (!name) return;
            const updated = {
                name,
                description: document.getElementById('category-description').value.trim(),
                color: document.getElementById('category-color').value,
                icon: document.getElementById('category-icon').value,
                budget: parseFloat(document.getElementById('category-budget').value) || 0
            };
            try {
                await updateDoc(doc(db, 'expenseCategories', id), updated);
                await loadAllData();
                showNotification('Category updated', 'success');
            } catch (e) { console.error(e); showNotification('Update failed', 'error'); }
        }

        async function deleteCategory(id) {
            try {
                const batch = writeBatch(db);
                state.expenses.filter(e => e.categoryId === id).forEach(e => {
                    batch.update(doc(db, 'expenses', e.id), { categoryId: null });
                });
                batch.delete(doc(db, 'expenseCategories', id));
                await batch.commit();
                await loadAllData();
                showNotification('Category deleted', 'success');
            } catch (e) { console.error(e); showNotification('Delete failed', 'error'); }
        }

        // Expenses (unchanged)
        async function addExpense() {
            const name = document.getElementById('expense-name').value.trim();
            const catId = document.getElementById('expense-category').value;
            const amount = document.getElementById('expense-amount').value;
            const date = document.getElementById('expense-date').value;
            if (!name || !catId || !amount || !date) { showNotification('Fill required fields', 'error'); return; }
            const newExp = {
                name, categoryId: catId, amount: parseFloat(amount).toFixed(2), date,
                payment: document.getElementById('expense-payment').value,
                description: document.getElementById('expense-description').value.trim(),
                status: document.getElementById('expense-status').value,
                createdAt: new Date().toISOString()
            };
            try {
                await addDoc(expensesCol, newExp);
                await loadAllData();
                document.getElementById('expense-name').value = '';
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-description').value = '';
                document.getElementById('expense-status').value = 'pending';
                showNotification('Expense added', 'success');
            } catch (e) { console.error(e); showNotification('Error adding expense', 'error'); }
        }

        async function deleteExpense(id) {
            try {
                await deleteDoc(doc(db, 'expenses', id));
                await loadAllData();
                showNotification('Expense deleted', 'success');
            } catch (e) { console.error(e); showNotification('Error deleting', 'error'); }
        }

        async function updateExpense(id) {
            const name = document.getElementById('edit-expense-name').value.trim();
            const catId = document.getElementById('edit-expense-category').value;
            const amount = document.getElementById('edit-expense-amount').value;
            const date = document.getElementById('edit-expense-date').value;
            if (!name || !catId || !amount || !date) return;
            const updated = {
                name, categoryId: catId, amount: parseFloat(amount).toFixed(2), date,
                payment: document.getElementById('edit-expense-payment').value,
                description: document.getElementById('edit-expense-description').value.trim(),
                status: document.getElementById('edit-expense-status').value
            };
            try {
                await updateDoc(doc(db, 'expenses', id), updated);
                await loadAllData();
                closeEditExpenseModal();
                showNotification('Expense updated', 'success');
            } catch (e) { console.error(e); showNotification('Update failed', 'error'); }
        }

        // Filters
        function applyExpenseFiltersFromState() {
            const filters = state.activeExpenseFilters;
            if (Object.keys(filters).length === 0) {
                state.filteredExpenses = null;
                return;
            }
            state.filteredExpenses = state.expenses.filter(e => {
                if (filters.name && !e.name.toLowerCase().includes(filters.name.toLowerCase())) return false;
                if (filters.categoryId && e.categoryId !== filters.categoryId) return false;
                if (filters.status && e.status !== filters.status) return false;
                if (filters.dateFrom && e.date < filters.dateFrom) return false;
                if (filters.dateTo && e.date > filters.dateTo) return false;
                if (filters.amountFrom && parseFloat(e.amount) < parseFloat(filters.amountFrom)) return false;
                if (filters.amountTo && parseFloat(e.amount) > parseFloat(filters.amountTo)) return false;
                return true;
            });
        }

        async function applyExpenseFilters() {
            state.activeExpenseFilters = {
                name: document.getElementById('expense-filter-name').value,
                categoryId: document.getElementById('expense-filter-category').value,
                status: document.getElementById('expense-filter-status').value,
                dateFrom: document.getElementById('expense-filter-date-from').value,
                dateTo: document.getElementById('expense-filter-date-to').value,
                amountFrom: document.getElementById('expense-filter-amount-from').value,
                amountTo: document.getElementById('expense-filter-amount-to').value
            };
            Object.keys(state.activeExpenseFilters).forEach(key => !state.activeExpenseFilters[key] && delete state.activeExpenseFilters[key]);
            applyExpenseFiltersFromState();
            renderExpensesTable();
            await saveSettings();
        }

        function clearExpenseFilters() {
            state.activeExpenseFilters = {};
            state.filteredExpenses = null;
            document.getElementById('expense-filter-name').value = '';
            document.getElementById('expense-filter-category').value = '';
            document.getElementById('expense-filter-status').value = '';
            document.getElementById('expense-filter-date-from').value = '';
            document.getElementById('expense-filter-date-to').value = '';
            document.getElementById('expense-filter-amount-from').value = '';
            document.getElementById('expense-filter-amount-to').value = '';
            renderExpensesTable();
            saveSettings();
        }

        // UI Rendering
        function renderCustomFields() {
            const container = document.getElementById('custom-fields-container');
            if (!container) return;
            if (state.customFields.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding:20px 0;"><i class="fas fa-list-alt"></i><h3>No Custom Fields</h3><p>Add fields using the panel.</p></div>`;
                document.getElementById('reset-order-btn').style.display = 'none';
                return;
            }
            container.innerHTML = '';
            const sorted = [...state.customFields].sort((a,b) => state.fieldOrder.indexOf(a.id) - state.fieldOrder.indexOf(b.id));
            sorted.forEach((field, idx) => {
                const div = document.createElement('div');
                div.className = 'form-group draggable';
                div.dataset.id = field.id;
                let inputHtml = '';
                if (field.type === 'checkbox') {
                    inputHtml = `<div class="checkbox-group"><input type="checkbox" id="${field.id}" ${field.defaultValue==='true'?'checked':''}><label>${field.name}</label></div>`;
                } else if (field.type === 'dropdown') {
                    let options = '<option value="">Select</option>';
                    if (field.options) {
                        field.options.forEach(o => {
                            options += `<option value="${o}" ${o===field.defaultValue?'selected':''}>${o}</option>`;
                        });
                    }
                    inputHtml = `<select class="form-control" id="${field.id}">${options}</select>`;
                } else if (field.type === 'status') {
                    inputHtml = `<select class="form-control" id="${field.id}">
                        <option value="pending" ${field.defaultValue==='pending'?'selected':''}>Pending</option>
                        <option value="confirmed" ${field.defaultValue==='confirmed'?'selected':''}>Confirmed</option>
                        <option value="cancelled" ${field.defaultValue==='cancelled'?'selected':''}>Cancelled</option>
                    </select>`;
                } else {
                    inputHtml = `<input type="${field.type==='date'?'date':field.type==='currency'||field.type==='number'?'number':'text'}" 
                        class="form-control" id="${field.id}" value="${field.defaultValue || ''}" 
                        ${field.type==='currency'?'step="0.01"':''} placeholder="${field.name}">`;
                }
                div.innerHTML = `
                    <div class="drag-handle" draggable="true"><i class="fas fa-grip-vertical"></i></div>
                    <div class="field-order-indicator">${idx+1}</div>
                    <label class="form-label">${field.name}</label>
                    ${inputHtml}
                `;
                container.appendChild(div);
            });
            // drag & drop - improved
            const handles = container.querySelectorAll('.drag-handle');
            handles.forEach(h => {
                h.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', e.target.closest('.draggable').dataset.id);
                    e.target.closest('.draggable').classList.add('dragging');
                });
                h.addEventListener('dragend', e => e.target.closest('.draggable').classList.remove('dragging'));
            });
            container.addEventListener('dragover', e => e.preventDefault());
            container.addEventListener('drop', e => {
                e.preventDefault();
                const draggedId = e.dataTransfer.getData('text/plain');
                const target = e.target.closest('.draggable');
                if (!target || target.dataset.id === draggedId) return;
                const draggedIdx = state.fieldOrder.indexOf(draggedId);
                const targetIdx = state.fieldOrder.indexOf(target.dataset.id);
                state.fieldOrder.splice(draggedIdx, 1);
                state.fieldOrder.splice(targetIdx, 0, draggedId);
                renderCustomFields();
                saveSettings();
                showNotification('Field order updated', 'success');
            });
        }

        function renderReservationsTable() {
            const thead = document.getElementById('reservations-thead');
            const tbody = document.getElementById('reservations-body');
            if (!thead || !tbody) return;

            let headerHtml = '<tr><th>Room Type</th><th>Check-in</th><th>Check-out</th><th>Duration</th><th>Check-in Time</th><th>Check-out Time</th><th>Transfer ($)</th><th>Meal ($)</th>';
            state.customFields.forEach(f => { headerHtml += `<th>${f.name}</th>`; });
            headerHtml += '<th>Actions</th></tr>';
            thead.innerHTML = headerHtml;

            tbody.innerHTML = '';
            const res = state.filteredReservations || state.reservations;
            if (res.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${8 + state.customFields.length + 1}"><div class="empty-state"><i class="fas fa-calendar-times"></i><h3>No Reservations</h3></div></td></tr>`;
                return;
            }
            res.forEach(r => {
                const tr = document.createElement('tr');
                let rowHtml = `
                    <td>${r.name}</td>
                    <td>${r.checkin}</td>
                    <td>${r.checkout}</td>
                    <td>${r.duration || 1}</td>
                    <td>${r.time || ''}</td>
                    <td>${r.checkoutTime || ''}</td>
                    <td class="currency-cell">$${(r.transferAmount || 0).toFixed(2)}</td>
                    <td class="currency-cell">$${(r.mealPrice || 0).toFixed(2)}</td>
                `;
                state.customFields.forEach(f => {
                    let val = r[f.id];
                    if (f.type === 'checkbox') {
                        val = val ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>';
                    } else if (f.type === 'currency') {
                        val = val ? `$${parseFloat(val).toFixed(2)}` : '-';
                    } else {
                        val = val || '-';
                    }
                    rowHtml += `<td>${val}</td>`;
                });
                rowHtml += `<td><div class="action-buttons"><button class="btn-icon edit" onclick="window.editReservation('${r.id}')"><i class="fas fa-edit"></i></button><button class="btn-icon delete" onclick="window.deleteReservation('${r.id}')"><i class="fas fa-trash-alt"></i></button></div></td>`;
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
            document.getElementById('reservation-count-badge').textContent = res.length;
        }

        function renderCategories() {
            const list = document.getElementById('categories-list');
            if (!list) return;
            list.innerHTML = '';
            state.expenseCategories.forEach(cat => {
                const item = document.createElement('div');
                item.className = `category-item ${state.selectedCategoryId===cat.id?'active':''}`;
                item.dataset.id = cat.id;
                item.innerHTML = `
                    <div class="category-item-header"><span class="category-name">${cat.name}</span>
                        <div class="category-actions">
                            <button class="btn-icon edit" onclick="window.editCategory('${cat.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon delete" onclick="window.deleteCategory('${cat.id}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div style="font-size:13px;color:var(--text-secondary);">${cat.description || ''}</div>
                    <div><span style="background-color:${cat.color}; width:12px;height:12px;display:inline-block;border-radius:50%;"></span> <i class="${cat.icon}"></i> $${cat.budget || 0}</div>
                `;
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.btn-icon')) {
                        state.selectedCategoryId = cat.id;
                        document.getElementById('category-name').value = cat.name;
                        document.getElementById('category-description').value = cat.description || '';
                        document.getElementById('category-color').value = cat.color;
                        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                        document.querySelector(`.color-option[data-color="${cat.color}"]`)?.classList.add('selected');
                        document.getElementById('category-icon').value = cat.icon;
                        document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
                        document.querySelector(`.icon-option i.${cat.icon}`)?.closest('.icon-option')?.classList.add('selected');
                        document.getElementById('category-budget').value = cat.budget;
                        document.getElementById('category-form-title').textContent = `Edit: ${cat.name}`;
                        document.getElementById('cancel-category-btn').style.display = 'block';
                        renderCategories();
                    }
                });
                list.appendChild(item);
            });
        }

        function updateCategoryDropdowns() {
            const selects = ['expense-category', 'expense-filter-category', 'edit-expense-category'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;
                sel.innerHTML = `<option value="">${id.includes('filter')?'All Categories':'Select a category'}</option>`;
                state.expenseCategories.forEach(c => {
                    sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                });
            });
        }

        function renderExpensesTable() {
            const tbody = document.getElementById('expenses-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            const exps = state.filteredExpenses || state.expenses;
            if (exps.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><i class="fas fa-money-bill-wave"></i><h3>No Expenses</h3></div></td></tr>`;
                document.getElementById('expense-summary').style.display = 'none';
                return;
            }
            exps.forEach(e => {
                const cat = state.expenseCategories.find(c => c.id === e.categoryId);
                const tr = document.createElement('tr');
                tr.className = e.status === 'paid' ? 'status-paid' : 'status-pending';
                tr.innerHTML = `
                    <td>${e.name}</td>
                    <td><span class="category-badge" style="background-color:${cat?.color}20; color:${cat?.color};">${cat?.name||'Uncategorized'}</span></td>
                    <td class="expense-cell">$${parseFloat(e.amount).toFixed(2)}</td>
                    <td>${e.date}</td>
                    <td>${e.payment}</td>
                    <td>${e.description || '-'}</td>
                    <td><span class="status-badge ${e.status==='paid'?'status-paid':'status-expense-pending'}">${e.status}</span></td>
                    <td><div class="action-buttons">
                        <button class="btn-icon edit" onclick="window.editExpense('${e.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon delete" onclick="window.deleteExpense('${e.id}')"><i class="fas fa-trash-alt"></i></button>
                    </div></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('expense-count-badge').textContent = exps.length;
            updateExpenseSummary(exps);
        }

        function updateExpenseSummary(exps) {
            if (!exps.length) { document.getElementById('expense-summary').style.display = 'none'; return; }
            const total = exps.reduce((s,e)=>s+parseFloat(e.amount),0);
            const paid = exps.filter(e=>e.status==='paid').length;
            const pend = exps.length - paid;
            document.getElementById('summary-count').textContent = exps.length;
            document.getElementById('summary-paid-count').textContent = paid;
            document.getElementById('summary-pending-count').textContent = pend;
            document.getElementById('summary-total-amount').textContent = `$${total.toFixed(2)}`;
            document.getElementById('expense-summary').style.display = 'flex';
        }

        function updateStats() {
            const tot = state.filteredReservations?.length || state.reservations.length;
            document.getElementById('total-reservations').textContent = tot;
            document.getElementById('reservation-count-badge').textContent = tot;
            const pending = state.reservations.filter(r => {
                for (let f of state.customFields) {
                    if (f.type==='status' && r[f.id]==='pending') return true;
                } return false;
            }).length;
            document.getElementById('pending-reservations').textContent = pending;
            const monthlyExp = state.expenses.filter(e => {
                let d = new Date(e.date);
                let now = new Date();
                return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
            }).reduce((s,e)=>s+parseFloat(e.amount),0);
            document.getElementById('monthly-expenses').textContent = `$${monthlyExp.toFixed(2)}`;
            let revenue = 0;
            state.reservations.forEach(r => {
                revenue += (r.transferAmount || 0) + (r.mealPrice || 0);
            });
            document.getElementById('net-revenue').textContent = `$${(revenue-monthlyExp).toFixed(2)}`;
            const totalExpenses = state.expenses.reduce((s,e)=>s+parseFloat(e.amount),0);
            document.getElementById('total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('month-expenses').textContent = `$${monthlyExp.toFixed(2)}`;
            const catTotals = {};
            state.expenses.forEach(e => { if (e.categoryId) catTotals[e.categoryId] = (catTotals[e.categoryId]||0) + parseFloat(e.amount); });
            let maxCat = { name: 'None', amount: 0 };
            for (let [cid, amt] of Object.entries(catTotals)) {
                let cat = state.expenseCategories.find(c => c.id === cid);
                if (cat && amt > maxCat.amount) maxCat = { name: cat.name, amount: amt };
            }
            document.getElementById('highest-category').textContent = maxCat.name;
        }

        // Analytics with transfer and meal breakdown
        function renderAnalytics() {
            const period = document.getElementById('analytics-period').value;
            const cutoff = period === 'all' ? new Date(0) : new Date(Date.now() - parseInt(period)*24*60*60*1000);
            
            let monthly = {};
            let totalTransfer = 0, totalMeal = 0;
            state.reservations.forEach(r => {
                const d = new Date(r.checkin);
                if (d >= cutoff) {
                    const monthKey = `${d.getFullYear()}-${d.getMonth()+1}`;
                    const transfer = r.transferAmount || 0;
                    const meal = r.mealPrice || 0;
                    totalTransfer += transfer;
                    totalMeal += meal;
                    monthly[monthKey] = monthly[monthKey] || { transfer:0, meal:0, expenses:0, count:0 };
                    monthly[monthKey].transfer += transfer;
                    monthly[monthKey].meal += meal;
                    monthly[monthKey].count += 1;
                }
            });
            state.expenses.forEach(e => {
                const d = new Date(e.date);
                if (d >= cutoff) {
                    const monthKey = `${d.getFullYear()}-${d.getMonth()+1}`;
                    monthly[monthKey] = monthly[monthKey] || { transfer:0, meal:0, expenses:0, count:0 };
                    monthly[monthKey].expenses += parseFloat(e.amount)||0;
                }
            });

            const months = Object.keys(monthly).sort();
            const labels = months.map(m => { let [y,mo]=m.split('-'); return new Date(y,mo-1).toLocaleString('default',{month:'short'})+' '+y; });
            const transferData = months.map(m => monthly[m].transfer);
            const mealData = months.map(m => monthly[m].meal);
            const expenseData = months.map(m => monthly[m].expenses);
            const totalIncomeData = months.map(m => monthly[m].transfer + monthly[m].meal);
            const profitData = months.map(m => (monthly[m].transfer + monthly[m].meal) - monthly[m].expenses);

            const totalRevenue = totalTransfer + totalMeal;
            document.getElementById('analytics-total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('analytics-transfer-income').textContent = `$${totalTransfer.toFixed(2)}`;
            document.getElementById('analytics-meal-income').textContent = `$${totalMeal.toFixed(2)}`;
            document.getElementById('analytics-total-expenses').textContent = `$${state.expenses.reduce((s,e)=>s+parseFloat(e.amount),0).toFixed(2)}`;

            if (state.charts.incomeExpense) state.charts.incomeExpense.destroy();
            if (state.charts.expenseCategory) state.charts.expenseCategory.destroy();
            if (state.charts.monthlyTrend) state.charts.monthlyTrend.destroy();
            if (state.charts.profitMargin) state.charts.profitMargin.destroy();

            const ctx1 = document.getElementById('incomeExpenseChart').getContext('2d');
            state.charts.incomeExpense = new Chart(ctx1, {
                type: 'bar',
                data: { labels, datasets: [
                    { label: 'Total Income', data: totalIncomeData, backgroundColor: 'rgba(16,185,129,0.7)' },
                    { label: 'Expenses', data: expenseData, backgroundColor: 'rgba(239,68,68,0.7)' }
                ]}
            });

            const catTotals = {};
            state.expenses.filter(e => new Date(e.date) >= cutoff).forEach(e => {
                const cat = state.expenseCategories.find(c => c.id === e.categoryId);
                const name = cat ? cat.name : 'Uncategorized';
                catTotals[name] = (catTotals[name]||0) + parseFloat(e.amount);
            });
            const ctx2 = document.getElementById('expenseCategoryChart').getContext('2d');
            state.charts.expenseCategory = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: Object.keys(catTotals),
                    datasets: [{
                        data: Object.values(catTotals),
                        backgroundColor: ['#8b5cf6','#0ea5e9','#10b981','#f59e0b','#ef4444','#2563eb','#7c3aed','#475569']
                    }]
                }
            });

            const ctx3 = document.getElementById('monthlyTrendChart').getContext('2d');
            state.charts.monthlyTrend = new Chart(ctx3, {
                type: 'line',
                data: { labels, datasets: [
                    { label: 'Transfer Income', data: transferData, borderColor: '#2563eb', fill: false },
                    { label: 'Meal Income', data: mealData, borderColor: '#f59e0b', fill: false }
                ]}
            });

            const marginData = months.map(m => {
                const total = monthly[m].transfer + monthly[m].meal;
                return total>0 ? ((total - monthly[m].expenses)/total*100) : 0;
            });
            const ctx4 = document.getElementById('profitMarginChart').getContext('2d');
            state.charts.profitMargin = new Chart(ctx4, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Profit Margin %', data: marginData, backgroundColor: marginData.map(v=>v>=0?'rgba(16,185,129,0.7)':'rgba(239,68,68,0.7)') }] }
            });

            const tbody = document.getElementById('analytics-body');
            tbody.innerHTML = '';
            let cumulative = 0;
            months.forEach(m => {
                const transfer = monthly[m].transfer;
                const meal = monthly[m].meal;
                const total = transfer + meal;
                const exp = monthly[m].expenses;
                const profit = total - exp;
                cumulative += profit;
                const margin = total>0 ? (profit/total*100).toFixed(1) : '0.0';
                const row = `<tr>
                    <td>${m}</td>
                    <td>${monthly[m].count}</td>
                    <td class="currency-cell">$${transfer.toFixed(2)}</td>
                    <td class="currency-cell">$${meal.toFixed(2)}</td>
                    <td class="currency-cell">$${total.toFixed(2)}</td>
                    <td class="expense-cell">$${exp.toFixed(2)}</td>
                    <td class="${profit>=0?'currency-cell':'expense-cell'}">$${profit.toFixed(2)}</td>
                    <td class="${cumulative>=0?'currency-cell':'expense-cell'}">$${cumulative.toFixed(2)}</td>
                    <td>${margin}%</td>
                </tr>`;
                tbody.innerHTML += row;
            });

            const now = new Date();
            const thisMonthKey = `${now.getFullYear()}-${now.getMonth()+1}`;
            const lastMonth = new Date(now.getFullYear(), now.getMonth()-1, 1);
            const lastMonthKey = `${lastMonth.getFullYear()}-${lastMonth.getMonth()+1}`;
            document.getElementById('this-month-income').textContent = `$${((monthly[thisMonthKey]?.transfer||0)+(monthly[thisMonthKey]?.meal||0)).toFixed(2)}`;
            document.getElementById('this-month-expenses').textContent = `$${(monthly[thisMonthKey]?.expenses||0).toFixed(2)}`;
            document.getElementById('this-month-net').textContent = `$${(((monthly[thisMonthKey]?.transfer||0)+(monthly[thisMonthKey]?.meal||0))-(monthly[thisMonthKey]?.expenses||0)).toFixed(2)}`;
            document.getElementById('last-month-income').textContent = `$${((monthly[lastMonthKey]?.transfer||0)+(monthly[lastMonthKey]?.meal||0)).toFixed(2)}`;
            document.getElementById('last-month-expenses').textContent = `$${(monthly[lastMonthKey]?.expenses||0).toFixed(2)}`;
            document.getElementById('last-month-net').textContent = `$${(((monthly[lastMonthKey]?.transfer||0)+(monthly[lastMonthKey]?.meal||0))-(monthly[lastMonthKey]?.expenses||0)).toFixed(2)}`;
        }

        // Calendar (enhanced details)
        function renderCalendar() {
            const grid = document.getElementById('calendar-days-grid');
            if (!grid) return;
            const year = state.currentCalendarDate.getFullYear();
            const month = state.currentCalendarDate.getMonth();
            document.getElementById('calendar-month-year').textContent = 
                new Date(year, month).toLocaleString('default', { month:'long', year:'numeric' });
            grid.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month+1, 0).getDate();
            for (let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div')).className = 'calendar-day empty';
            for (let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayReservations = state.reservations.filter(r => 
                    new Date(r.checkin) <= new Date(dateStr) && new Date(r.checkout) > new Date(dateStr)
                );
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.dataset.date = dateStr;
                if (dateStr === new Date().toISOString().split('T')[0]) dayDiv.classList.add('today');
                dayDiv.innerHTML = `<div class="calendar-day-number">${d}</div>`;
                if (dayReservations.length > 0) {
                    const indicator = document.createElement('div');
                    indicator.className = 'calendar-reservation-indicator';
                    dayReservations.slice(0,3).forEach(r => {
                        const resDiv = document.createElement('div');
                        // map room name to a class for color
                        let roomClass = 'reservation-pending';
                        if (r.name === 'Apartment 1') roomClass = 'reservation-room-single';
                        else if (r.name === 'Apartment 2') roomClass = 'reservation-room-double';
                        else if (r.name === 'Studio') roomClass = 'reservation-room-suite';
                        else if (r.name === 'Villa') roomClass = 'reservation-room-vip';
                        else if (r.name === 'Horizon') roomClass = 'reservation-room-deluxe';
                        resDiv.className = `calendar-reservation ${roomClass}`;
                        resDiv.innerHTML = `<div class="time">${r.time || ''}</div><div class="name">${r.name}</div>`;
                        indicator.appendChild(resDiv);
                    });
                    if (dayReservations.length > 3) {
                        const more = document.createElement('div');
                        more.textContent = `+${dayReservations.length-3} more`;
                        more.style.fontStyle = 'italic';
                        indicator.appendChild(more);
                    }
                    dayDiv.appendChild(indicator);
                }
                dayDiv.addEventListener('click', () => showDayReservations(dateStr));
                grid.appendChild(dayDiv);
            }
        }

        function showDayReservations(dateStr) {
            const container = document.getElementById('selected-date-reservations');
            const title = document.getElementById('selected-date-title');
            title.textContent = `Reservations for ${dateStr}`;
            const dayRes = state.reservations.filter(r => 
                new Date(r.checkin) <= new Date(dateStr) && new Date(r.checkout) > new Date(dateStr)
            );
            if (dayRes.length === 0) {
                container.innerHTML = '<div class="calendar-no-reservations">No reservations</div>';
                return;
            }
            container.innerHTML = '';
            dayRes.forEach(r => {
                const item = document.createElement('div');
                item.className = 'calendar-reservation-item';
                // Build details grid
                let detailsHtml = `
                    <div class="calendar-reservation-header">
                        <span class="calendar-reservation-title">${r.name}</span>
                        <div class="action-buttons">
                            <button class="btn-icon edit" onclick="window.editReservation('${r.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon delete" onclick="window.deleteReservation('${r.id}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="calendar-reservation-detail-grid">
                        <div class="calendar-reservation-detail"><strong>Check-in:</strong> ${r.checkin} ${r.time || ''}</div>
                        <div class="calendar-reservation-detail"><strong>Check-out:</strong> ${r.checkout} ${r.checkoutTime || ''}</div>
                        <div class="calendar-reservation-detail"><strong>Duration:</strong> ${r.duration} nights</div>
                        <div class="calendar-reservation-detail"><strong>Transfer:</strong> $${(r.transferAmount || 0).toFixed(2)}</div>
                        <div class="calendar-reservation-detail"><strong>Meal:</strong> $${(r.mealPrice || 0).toFixed(2)}</div>
                `;
                // Add custom fields
                state.customFields.forEach(f => {
                    let val = r[f.id];
                    if (val !== undefined && val !== null && val !== '') {
                        if (f.type === 'checkbox') val = val ? 'Yes' : 'No';
                        else if (f.type === 'currency') val = `$${parseFloat(val).toFixed(2)}`;
                        detailsHtml += `<div class="calendar-reservation-detail"><strong>${f.name}:</strong> ${val}</div>`;
                    }
                });
                detailsHtml += '</div>';
                item.innerHTML = detailsHtml;
                container.appendChild(item);
            });
        }

        // Export functions
        function exportToCSV(data, filename) {
            if (!data || data.length === 0) { showNotification('No data to export', 'error'); return; }
            const headers = Object.keys(data[0]);
            const csvRows = [];
            csvRows.push(headers.join(','));
            for (const row of data) {
                const values = headers.map(h => {
                    const val = row[h] || '';
                    return `"${String(val).replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            }
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Modal functions (edit reservation updated)
        window.editReservation = (id) => {
            const r = state.reservations.find(r => r.id === id);
            if (!r) return;
            state.editingReservationId = id;
            const body = document.getElementById('edit-reservation-body');
            body.innerHTML = `
                <div class="form-group"><label>Room Type</label>
                    <select id="edit-name" class="form-control">
                        <option value="">Select</option>
                        <option value="Apartment 1" ${r.name==='Apartment 1'?'selected':''}>Apartment 1</option>
                        <option value="Apartment 2" ${r.name==='Apartment 2'?'selected':''}>Apartment 2</option>
                        <option value="Studio" ${r.name==='Studio'?'selected':''}>Studio</option>
                        <option value="Villa" ${r.name==='Villa'?'selected':''}>Villa</option>
                        <option value="Horizon" ${r.name==='Horizon'?'selected':''}>Horizon</option>
                    </select>
                </div>
                <div class="form-group"><label>Check-in Date</label><input type="date" id="edit-checkin" class="form-control" value="${r.checkin}"></div>
                <div class="form-group"><label>Check-out Date</label><input type="date" id="edit-checkout" class="form-control" value="${r.checkout}"></div>
                <div class="form-group"><label>Check-in Time</label><input type="time" id="edit-time" class="form-control" value="${r.time || ''}"></div>
                <div class="form-group"><label>Check-out Time</label><input type="time" id="edit-checkout-time" class="form-control" value="${r.checkoutTime || ''}"></div>
                <div class="form-group"><label>Transfer Amount ($)</label><input type="number" id="edit-transfer" class="form-control" step="0.01" value="${r.transferAmount || 0}"></div>
                <div class="form-group"><label>Meal Price ($)</label><input type="number" id="edit-meal" class="form-control" step="0.01" value="${r.mealPrice || 0}"></div>
                ${state.customFields.map(f => `
                    <div class="form-group"><label>${f.name}</label>
                        ${f.type==='checkbox' ? `<input type="checkbox" id="edit-${f.id}" ${r[f.id]?'checked':''}>` :
                          f.type==='dropdown' ? `<select id="edit-${f.id}" class="form-control">${f.options?.map(o=>`<option ${r[f.id]===o?'selected':''}>${o}</option>`).join('')}</select>` :
                          `<input type="${f.type==='date'?'date':'text'}" id="edit-${f.id}" class="form-control" value="${r[f.id]||''}">`}
                    </div>
                `).join('')}
            `;
            document.getElementById('edit-reservation-modal').classList.add('active');
        };
        document.getElementById('save-edit-reservation-btn')?.addEventListener('click', async () => {
            if (!state.editingReservationId) return;
            const data = {
                name: document.getElementById('edit-name').value,
                checkin: document.getElementById('edit-checkin').value,
                checkout: document.getElementById('edit-checkout').value,
                time: document.getElementById('edit-time').value,
                checkoutTime: document.getElementById('edit-checkout-time').value,
                transferAmount: parseFloat(document.getElementById('edit-transfer').value) || 0,
                mealPrice: parseFloat(document.getElementById('edit-meal').value) || 0,
                duration: calculateDuration(document.getElementById('edit-checkin').value, document.getElementById('edit-checkout').value)
            };
            state.customFields.forEach(f => {
                const el = document.getElementById(`edit-${f.id}`);
                if (el) data[f.id] = f.type==='checkbox' ? el.checked : el.value;
            });
            await updateReservation(state.editingReservationId, data);
            document.getElementById('edit-reservation-modal').classList.remove('active');
        });
        document.getElementById('close-edit-reservation-modal')?.addEventListener('click', ()=>{
            document.getElementById('edit-reservation-modal').classList.remove('active');
        });
        document.getElementById('cancel-edit-reservation-btn')?.addEventListener('click', ()=>{
            document.getElementById('edit-reservation-modal').classList.remove('active');
        });

        window.deleteReservation = (id) => { if (confirm('Delete?')) deleteReservation(id); };

        window.editCategory = (id) => {
            const c = state.expenseCategories.find(c => c.id === id);
            if (!c) return;
            document.getElementById('edit-category-name').value = c.name;
            document.getElementById('edit-category-description').value = c.description || '';
            state.editingCategoryId = id;
            document.getElementById('edit-category-modal').classList.add('active');
        };
        document.getElementById('save-edit-category-btn')?.addEventListener('click', async () => {
            if (!state.editingCategoryId) return;
            await updateDoc(doc(db, 'expenseCategories', state.editingCategoryId), {
                name: document.getElementById('edit-category-name').value,
                description: document.getElementById('edit-category-description').value
            });
            await loadAllData();
            document.getElementById('edit-category-modal').classList.remove('active');
        });
        document.getElementById('close-edit-category-modal')?.addEventListener('click', ()=>{
            document.getElementById('edit-category-modal').classList.remove('active');
        });

        window.deleteCategory = (id) => { if (confirm('Delete category?')) deleteCategory(id); };

        window.editExpense = (id) => {
            const e = state.expenses.find(e => e.id === id);
            if (!e) return;
            document.getElementById('edit-expense-name').value = e.name;
            document.getElementById('edit-expense-category').value = e.categoryId || '';
            document.getElementById('edit-expense-amount').value = e.amount;
            document.getElementById('edit-expense-date').value = e.date;
            document.getElementById('edit-expense-payment').value = e.payment;
            document.getElementById('edit-expense-description').value = e.description || '';
            document.getElementById('edit-expense-status').value = e.status;
            state.editingExpenseId = id;
            const catSelect = document.getElementById('edit-expense-category');
            catSelect.innerHTML = '<option value="">Select a category</option>';
            state.expenseCategories.forEach(c => {
                catSelect.innerHTML += `<option value="${c.id}" ${c.id===e.categoryId?'selected':''}>${c.name}</option>`;
            });
            document.getElementById('edit-expense-modal').classList.add('active');
        };
        document.getElementById('save-edit-expense-btn')?.addEventListener('click', async () => {
            if (!state.editingExpenseId) return;
            await updateExpense(state.editingExpenseId);
        });
        document.getElementById('close-edit-expense-modal')?.addEventListener('click', ()=>{
            document.getElementById('edit-expense-modal').classList.remove('active');
        });
        document.getElementById('cancel-edit-expense-btn')?.addEventListener('click', ()=>{
            document.getElementById('edit-expense-modal').classList.remove('active');
        });

        window.deleteExpense = (id) => { if (confirm('Delete expense?')) deleteExpense(id); };

        // Navigation
        function showPage(page) {
            state.currentPage = page;
            ['dashboard','calendar','expenses','analytics','settings'].forEach(p => {
                const el = document.getElementById(`${p}-content`);
                if (el) el.style.display = p === page ? 'block' : 'none';
                document.getElementById(`${p}-tab-btn`)?.classList.toggle('active', p === page);
            });
            if (page === 'calendar') renderCalendar();
            if (page === 'analytics') renderAnalytics();
        }

        // Filter modal
        function openFilterModal() {
            document.getElementById('filter-room').value = state.activeFilters.room || '';
            document.getElementById('filter-checkin-from').value = state.activeFilters.checkinFrom || '';
            document.getElementById('filter-checkin-to').value = state.activeFilters.checkinTo || '';
            document.getElementById('filter-checkout-from').value = state.activeFilters.checkoutFrom || '';
            document.getElementById('filter-checkout-to').value = state.activeFilters.checkoutTo || '';
            document.getElementById('filter-sort-by').value = state.activeFilters.sortBy || 'checkin';
            const container = document.getElementById('custom-field-filters');
            container.innerHTML = '';
            state.customFields.forEach(f => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `<label class="form-label">${f.name}</label>`;
                if (f.type === 'checkbox') {
                    const select = document.createElement('select');
                    select.className = 'form-control';
                    select.id = `filter-${f.id}`;
                    select.innerHTML = `<option value="">All</option><option value="true">Yes</option><option value="false">No</option>`;
                    select.value = state.activeFilters[f.id] || '';
                    div.appendChild(select);
                } else if (f.type === 'dropdown' || f.type === 'status') {
                    const select = document.createElement('select');
                    select.className = 'form-control';
                    select.id = `filter-${f.id}`;
                    select.innerHTML = '<option value="">All</option>';
                    if (f.type === 'status') {
                        select.innerHTML += '<option value="pending">Pending</option><option value="confirmed">Confirmed</option><option value="cancelled">Cancelled</option>';
                    } else if (f.options) {
                        f.options.forEach(o => { select.innerHTML += `<option value="${o}">${o}</option>`; });
                    }
                    select.value = state.activeFilters[f.id] || '';
                    div.appendChild(select);
                } else {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.id = `filter-${f.id}`;
                    input.value = state.activeFilters[f.id] || '';
                    div.appendChild(input);
                }
                container.appendChild(div);
            });
            document.getElementById('filter-reservation-modal').classList.add('active');
        }

        function closeFilterModal() {
            document.getElementById('filter-reservation-modal').classList.remove('active');
        }

        function applyFilters() {
            const filters = {};
            if (document.getElementById('filter-room').value) filters.room = document.getElementById('filter-room').value;
            if (document.getElementById('filter-checkin-from').value) filters.checkinFrom = document.getElementById('filter-checkin-from').value;
            if (document.getElementById('filter-checkin-to').value) filters.checkinTo = document.getElementById('filter-checkin-to').value;
            if (document.getElementById('filter-checkout-from').value) filters.checkoutFrom = document.getElementById('filter-checkout-from').value;
            if (document.getElementById('filter-checkout-to').value) filters.checkoutTo = document.getElementById('filter-checkout-to').value;
            if (document.getElementById('filter-sort-by').value) filters.sortBy = document.getElementById('filter-sort-by').value;
            state.customFields.forEach(f => {
                const el = document.getElementById(`filter-${f.id}`);
                if (el && el.value) filters[f.id] = el.value;
            });
            state.activeFilters = filters;
            state.filteredReservations = state.reservations.filter(r => {
                for (let [key, val] of Object.entries(filters)) {
                    if (key === 'room') { if (r.name !== val) return false; }
                    else if (key === 'checkinFrom') { if (r.checkin < val) return false; }
                    else if (key === 'checkinTo') { if (r.checkin > val) return false; }
                    else if (key === 'checkoutFrom') { if (r.checkout < val) return false; }
                    else if (key === 'checkoutTo') { if (r.checkout > val) return false; }
                    else if (key === 'sortBy') continue;
                    else {
                        const field = state.customFields.find(f => f.id === key);
                        if (field) {
                            if (field.type === 'checkbox') {
                                const rVal = r[key] === true || r[key] === 'true';
                                const fVal = val === 'true';
                                if (rVal !== fVal) return false;
                            } else {
                                if (r[key] != val) return false;
                            }
                        }
                    }
                }
                return true;
            });
            renderReservationsTable();
            updateStats();
            closeFilterModal();
            document.getElementById('clear-filters-btn').style.display = 'block';
        }

        function clearAllFilters() {
            state.activeFilters = {};
            state.filteredReservations = null;
            renderReservationsTable();
            updateStats();
            document.getElementById('clear-filters-btn').style.display = 'none';
        }

        // Export handlers
        document.getElementById('export-dashboard-btn')?.addEventListener('click', () => {
            const data = state.reservations.map(r => ({
                Room: r.name,
                Checkin: r.checkin,
                Checkout: r.checkout,
                Duration: r.duration,
                'Check-in Time': r.time,
                'Check-out Time': r.checkoutTime,
                Transfer: r.transferAmount || 0,
                Meal: r.mealPrice || 0,
                ...state.customFields.reduce((acc, f) => ({ ...acc, [f.name]: r[f.id] }), {})
            }));
            exportToCSV(data, 'reservations.csv');
        });
        document.getElementById('export-reservations-btn')?.addEventListener('click', () => {
            const data = state.reservations.map(r => ({
                Room: r.name,
                Checkin: r.checkin,
                Checkout: r.checkout,
                Duration: r.duration,
                'Check-in Time': r.time,
                'Check-out Time': r.checkoutTime,
                Transfer: r.transferAmount || 0,
                Meal: r.mealPrice || 0,
                ...state.customFields.reduce((acc, f) => ({ ...acc, [f.name]: r[f.id] }), {})
            }));
            exportToCSV(data, 'reservations.csv');
        });
        document.getElementById('export-expenses-btn')?.addEventListener('click', () => {
            const data = state.expenses.map(e => {
                const cat = state.expenseCategories.find(c => c.id === e.categoryId);
                return {
                    Name: e.name,
                    Category: cat ? cat.name : 'Uncategorized',
                    Amount: e.amount,
                    Date: e.date,
                    Payment: e.payment,
                    Description: e.description,
                    Status: e.status
                };
            });
            exportToCSV(data, 'expenses.csv');
        });
        document.getElementById('export-analytics-btn')?.addEventListener('click', () => {
            const period = document.getElementById('analytics-period').value;
            const cutoff = period === 'all' ? new Date(0) : new Date(Date.now() - parseInt(period)*24*60*60*1000);
            let monthly = {};
            state.reservations.forEach(r => {
                const d = new Date(r.checkin);
                if (d >= cutoff) {
                    const monthKey = `${d.getFullYear()}-${d.getMonth()+1}`;
                    monthly[monthKey] = monthly[monthKey] || { transfer:0, meal:0, expenses:0, count:0 };
                    monthly[monthKey].transfer += r.transferAmount || 0;
                    monthly[monthKey].meal += r.mealPrice || 0;
                    monthly[monthKey].count += 1;
                }
            });
            state.expenses.forEach(e => {
                const d = new Date(e.date);
                if (d >= cutoff) {
                    const monthKey = `${d.getFullYear()}-${d.getMonth()+1}`;
                    monthly[monthKey] = monthly[monthKey] || { transfer:0, meal:0, expenses:0, count:0 };
                    monthly[monthKey].expenses += parseFloat(e.amount)||0;
                }
            });
            const months = Object.keys(monthly).sort();
            const data = months.map(m => ({
                Period: m,
                Reservations: monthly[m].count,
                TransferIncome: monthly[m].transfer.toFixed(2),
                MealIncome: monthly[m].meal.toFixed(2),
                TotalIncome: (monthly[m].transfer + monthly[m].meal).toFixed(2),
                Expenses: monthly[m].expenses.toFixed(2),
                Profit: (monthly[m].transfer + monthly[m].meal - monthly[m].expenses).toFixed(2)
            }));
            exportToCSV(data, 'analytics.csv');
        });

        // Refresh buttons
        document.getElementById('refresh-table-btn')?.addEventListener('click', () => {
            renderReservationsTable();
            showNotification('Reservations table refreshed', 'success');
        });
        document.getElementById('refresh-expense-table-btn')?.addEventListener('click', () => {
            renderExpensesTable();
            showNotification('Expenses table refreshed', 'success');
        });

        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now()+86400000).toISOString().split('T')[0];
            document.getElementById('reservation-checkin') && (document.getElementById('reservation-checkin').value = today);
            document.getElementById('reservation-checkout') && (document.getElementById('reservation-checkout').value = tomorrow);
            document.getElementById('reservation-time') && (document.getElementById('reservation-time').value = '12:00');
            document.getElementById('reservation-checkout-time') && (document.getElementById('reservation-checkout-time').value = '10:00');
            document.getElementById('expense-date') && (document.getElementById('expense-date').value = today);
            await loadAllData();

            document.querySelectorAll('.type-option').forEach(opt => {
                opt.addEventListener('click', function() {
                    document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    state.selectedFieldType = this.dataset.type;
                    document.getElementById('dropdown-options-container').style.display = this.dataset.type==='dropdown' ? 'block' : 'none';
                });
            });

            document.querySelectorAll('.color-option').forEach(opt => {
                opt.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('category-color').value = this.dataset.color;
                });
            });

            const iconPicker = document.getElementById('category-icon-picker');
            const icons = ['fas fa-box','fas fa-bolt','fas fa-users','fas fa-tools','fas fa-car','fas fa-home','fas fa-utensils','fas fa-shopping-cart','fas fa-plane','fas fa-wifi'];
            iconPicker.innerHTML = '';
            icons.forEach(icon => {
                const opt = document.createElement('div');
                opt.className = 'icon-option';
                opt.innerHTML = `<i class="${icon}"></i>`;
                opt.dataset.icon = icon;
                opt.addEventListener('click', function() {
                    document.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('category-icon').value = icon;
                });
                iconPicker.appendChild(opt);
            });

            document.getElementById('add-field-btn')?.addEventListener('click', addCustomField);
            document.getElementById('clear-fields-btn')?.addEventListener('click', async () => {
                if (!confirm('Delete ALL data?')) return;
                try {
                    const batch = writeBatch(db);
                    state.customFields.forEach(f => batch.delete(doc(db, 'customFields', f.id)));
                    state.reservations.forEach(r => batch.delete(doc(db, 'reservations', r.id)));
                    state.expenses.forEach(e => batch.delete(doc(db, 'expenses', e.id)));
                    state.expenseCategories.forEach(c => batch.delete(doc(db, 'expenseCategories', c.id)));
                    const snap = await getDocs(settingsCol);
                    snap.forEach(d => batch.delete(doc(db, 'settings', d.id)));
                    await batch.commit();
                    await loadAllData();
                    showNotification('All data cleared', 'success');
                } catch (e) { console.error(e); showNotification('Error clearing', 'error'); }
            });
            document.getElementById('add-reservation-btn')?.addEventListener('click', addReservation);
            document.getElementById('clear-form-btn')?.addEventListener('click', clearForm);
            document.getElementById('add-expense-btn')?.addEventListener('click', addExpense);
            document.getElementById('save-category-btn')?.addEventListener('click', () => {
                if (state.selectedCategoryId) updateCategory(state.selectedCategoryId);
                else addCategory();
            });
            document.getElementById('cancel-category-btn')?.addEventListener('click', () => {
                state.selectedCategoryId = null;
                document.getElementById('category-name').value = '';
                document.getElementById('category-description').value = '';
                document.getElementById('category-budget').value = '';
                document.getElementById('category-form-title').textContent = 'Add New Category';
                document.getElementById('cancel-category-btn').style.display = 'none';
                renderCategories();
            });

            // Navigation
            document.getElementById('dashboard-tab-btn')?.addEventListener('click', () => showPage('dashboard'));
            document.getElementById('calendar-tab-btn')?.addEventListener('click', () => showPage('calendar'));
            document.getElementById('expenses-tab-btn')?.addEventListener('click', () => showPage('expenses'));
            document.getElementById('analytics-tab-btn')?.addEventListener('click', () => showPage('analytics'));
            document.getElementById('settings-tab-btn')?.addEventListener('click', () => showPage('settings'));

            // Calendar nav
            document.getElementById('calendar-prev-month')?.addEventListener('click', () => {
                state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth()-1);
                renderCalendar();
            });
            document.getElementById('calendar-next-month')?.addEventListener('click', () => {
                state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth()+1);
                renderCalendar();
            });
            document.getElementById('calendar-today')?.addEventListener('click', () => {
                state.currentCalendarDate = new Date();
                renderCalendar();
            });
            document.getElementById('calendar-month-view-btn')?.addEventListener('click', () => { state.calendarView = 'month'; renderCalendar(); });
            document.getElementById('calendar-week-view-btn')?.addEventListener('click', () => { state.calendarView = 'week'; renderCalendar(); });
            document.getElementById('add-reservation-from-calendar')?.addEventListener('click', () => {
                showPage('dashboard');
                if (state.selectedCalendarDate) document.getElementById('reservation-checkin').value = state.selectedCalendarDate;
            });

            // Analytics apply
            document.getElementById('apply-analytics-filters')?.addEventListener('click', renderAnalytics);

            // Expense filters
            document.getElementById('apply-expense-filters-btn')?.addEventListener('click', applyExpenseFilters);
            document.getElementById('clear-expense-filters-btn')?.addEventListener('click', clearExpenseFilters);

            // Reservation filters
            document.getElementById('filter-table-btn')?.addEventListener('click', openFilterModal);
            document.getElementById('close-filter-reservation-modal')?.addEventListener('click', closeFilterModal);
            document.getElementById('clear-all-filters-btn')?.addEventListener('click', () => {
                document.getElementById('filter-room').value = '';
                document.getElementById('filter-checkin-from').value = '';
                document.getElementById('filter-checkin-to').value = '';
                document.getElementById('filter-checkout-from').value = '';
                document.getElementById('filter-checkout-to').value = '';
                document.getElementById('filter-sort-by').value = 'checkin';
                state.customFields.forEach(f => {
                    const el = document.getElementById(`filter-${f.id}`);
                    if (el) el.value = '';
                });
            });
            document.getElementById('apply-filters-btn')?.addEventListener('click', applyFilters);
            document.getElementById('clear-filters-btn')?.addEventListener('click', clearAllFilters);

            // Print
            document.getElementById('print-btn')?.addEventListener('click', () => window.print());
        });
    </script>
</body>
</html>
