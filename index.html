<!-- ========== ADMIN PANEL (MODAL) â€“ UPDATED WITH TABLES TAB AND EN CATEGORY TAB ========== -->
<div class="admin-panel" id="adminPanel">
    <div class="admin-container">
        <button class="admin-close" id="adminClose"><i class="fas fa-times"></i></button>
        <h2 style="margin-bottom: 25px; color: var(--primary);"><i class="fas fa-lock"></i> Admin Control Panel</h2>
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="restaurant">Restaurant Settings</button>
            <button class="admin-tab" data-tab="menu">Menu (EL)</button>
            <button class="admin-tab" data-tab="menuEn">Menu (EN)</button>
            <button class="admin-tab" data-tab="categories">Categories (EL)</button>
            <button class="admin-tab" data-tab="categoriesEn">Categories (EN)</button>
            <button class="admin-tab" data-tab="orders">Orders <span class="pending-badge" id="orderPendingBadgeModal"><i class="fas fa-exclamation-circle"></i></span></button>
            <button class="admin-tab" data-tab="helpRequests">ğŸ†˜ Help <span class="pending-badge" id="helpPendingBadgeModal"><i class="fas fa-exclamation-circle"></i></span></button>
            <button class="admin-tab" data-tab="tablesModal">ğŸ“‹ Tables</button>
            <!-- NEW PRINTER TAB (modal) -->
            <button class="admin-tab" data-tab="printerModal">ğŸ–¨ï¸ Printer</button>
            <button class="admin-tab" data-tab="customization">Visual</button>
            <button class="admin-tab" data-tab="sound">ğŸ”Š Sound</button>
            <button class="admin-tab" data-tab="qr">QR Codes</button>
            <button class="admin-tab" data-tab="system">System</button>
        </div>
        <!-- Restaurant Settings Modal (modified with adminChangeCode) -->
        <div class="admin-content active" id="restaurantTabModal">
            <div class="admin-form-group"><label class="admin-label">Restaurant Name</label><input type="text" class="admin-input" id="adminRestaurantNameModal" value="DineEasy"></div>
            <div class="image-upload-container">
                <label class="admin-label">Restaurant Logo</label>
                <div class="image-preview" id="logoPreviewModal"><div class="image-preview-placeholder"><i class="fas fa-image"></i><p>No logo uploaded</p></div></div>
                <div class="upload-actions">
                    <input type="file" id="logoUploadModal" accept="image/*" style="display: none;">
                    <button class="btn btn-secondary upload-btn" id="uploadLogoBtnModal"><i class="fas fa-upload"></i> Upload Logo</button>
                    <button class="remove-image-btn" id="removeLogoBtnModal"><i class="fas fa-trash"></i> Remove</button>
                </div>
            </div>
            <div class="admin-form-group"><label class="admin-label">Tax Rate (%)</label><input type="number" class="admin-input" id="adminTaxRateModal" value="8" min="0" max="50" step="0.1"></div>
            <div class="admin-form-group"><label class="admin-label">Estimated Preparation Time (minutes)</label><input type="text" class="admin-input" id="adminPrepTimeModal" value="15-25"></div>
            <div class="admin-form-group"><label class="admin-label">Welcome Message</label><textarea class="admin-textarea" id="adminWelcomeMessageModal" placeholder="Welcome to our restaurant..."></textarea></div>
            <!-- NEW FIELD: Admin Change Code (Modal) -->
            <div class="admin-form-group">
                <label class="admin-label">Admin Change Code (4 digits)</label>
                <input type="text" class="admin-input" id="adminChangeCodeModal" maxlength="4" pattern="\d*" placeholder="e.g., 6262">
            </div>
            <button class="btn btn-primary" id="saveRestaurantSettingsModal"><i class="fas fa-save"></i> Save Restaurant Settings</button>
        </div>
        <!-- Menu Management Modal (EL) -->
        <div class="admin-content" id="menuTabModal">
            <div style="margin-bottom: 25px;"><button class="btn btn-success" id="addMenuItemBtnModal"><i class="fas fa-plus"></i> Add New Menu Item (EL)</button></div>
            <div class="admin-grid" id="menuItemsListModal"></div>
        </div>
        <!-- Menu Management Modal (EN) -->
        <div class="admin-content" id="menuEnTabModal">
            <div style="margin-bottom: 25px;"><button class="btn btn-success" id="addMenuItemBtnModalEn"><i class="fas fa-plus"></i> Add New Menu Item (EN)</button></div>
            <div class="admin-grid" id="menuItemsListModalEn"></div>
        </div>
        <!-- Category Management Modal (EL) -->
        <div class="admin-content" id="categoriesTabModal">
            <h3 style="margin-bottom: 20px;">Manage Categories (EL)</h3>
            <div class="categories-management">
                <div class="categories-list"><h4 style="margin-bottom: 15px;">Existing Categories</h4><div class="categories-list-container" id="categoriesListContainerModal"></div></div>
                <div class="add-category-form">
                    <h4 style="margin-bottom: 15px;">Add New Category</h4>
                    <div class="admin-form-group"><label class="admin-label">Category Name (ID)</label><input type="text" class="admin-input" id="newCategoryNameModal" placeholder="e.g., sides"></div>
                    <div class="admin-form-group"><label class="admin-label">Display Name (EL)</label><input type="text" class="admin-input" id="newCategoryDisplayNameModal" placeholder="e.g., Î£Ï…Î½Î¿Î´ÎµÏ…Ï„Î¹ÎºÎ¬"></div>
                    <div class="admin-form-group"><label class="admin-label">Display Name (EN)</label><input type="text" class="admin-input" id="newCategoryDisplayNameEnModal" placeholder="e.g., Side Dishes"></div>
                    <button class="btn btn-success" id="addCategoryBtnModal"><i class="fas fa-plus"></i> Add Category</button>
                </div>
            </div>
        </div>
        <!-- NEW: Category Management Modal (EN) -->
        <div class="admin-content" id="categoriesEnTabModal">
            <h3 style="margin-bottom: 20px;">Manage Categories (EN)</h3>
            <div class="categories-list"><h4 style="margin-bottom: 15px;">Existing Categories</h4><div class="categories-list-container" id="categoriesListContainerEnModal"></div></div>
        </div>
        <!-- Order Management Modal (with payed status) -->
        <div class="admin-content" id="ordersTabModal">
            <div class="admin-form-group" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <div style="flex: 1;">
                    <label class="admin-label">Filter by Status</label>
                    <select class="admin-select" id="orderStatusFilterModal">
                        <option value="all">All Orders</option>
                        <option value="pending">Pending</option>
                        <option value="preparing">Preparing</option>
                        <option value="ready">Ready</option>
                        <option value="served">Served</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="payed">Payed</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label class="admin-label">Filter by Table</label>
                    <select class="admin-select" id="orderTableFilterModal">
                        <option value="all">All Tables</option>
                    </select>
                </div>
            </div>
            <div id="adminOrdersListModal"><p style="text-align: center; color: var(--gray); padding: 40px;">No orders yet.</p></div>
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light-gray);">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-trash-alt"></i> Delete Orders by Table</h4>
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label class="admin-label">Select Table</label>
                        <select class="admin-select" id="tableSelectForDeleteModal"><option value="">-- No tables with orders --</option></select>
                    </div>
                    <button class="btn btn-danger" id="deleteOrdersForTableBtnModal"><i class="fas fa-trash"></i> Delete Orders</button>
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-primary" id="openCustomerOrderViewBtnModal">
                    <i class="fas fa-eye"></i> Order View (Take Away)
                </button>
                <!-- NEW BUTTON: Vertical Orders Viewer (Modal) -->
                <button class="btn btn-secondary" id="openVerticalOrdersViewBtnModal">
                    <i class="fas fa-list-ul"></i> Vertical Orders Viewer
                </button>
            </div>
        </div>
        <!-- Help Requests Modal (with vertical view button) -->
        <div class="admin-content" id="helpRequestsTabModal">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-headset"></i> Help Requests</h3>
            <div class="admin-form-group">
                <label class="admin-label">Filter by Status</label>
                <select class="admin-select" id="helpRequestStatusFilterModal">
                    <option value="all">All</option>
                    <option value="pending">Pending</option>
                    <option value="resolved">Resolved</option>
                </select>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" id="openHelpVerticalBtnModal">
                    <i class="fas fa-external-link-alt"></i> Open Vertical Help Requests View
                </button>
            </div>
            <div id="adminHelpRequestsListModal" style="margin-top: 20px;"></div>
        </div>
        <!-- Tables Modal (UPDATED with Settings button) -->
        <div class="admin-content" id="tablesTabModal">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-chair"></i> Tables</h3>
            <div class="categories-management">
                <div class="categories-list">
                    <h4 style="margin-bottom: 15px;">Existing Tables</h4>
                    <div class="categories-list-container" id="tablesListContainerModal"></div>
                </div>
                <div class="add-category-form">
                    <h4 style="margin-bottom: 15px;">Add New Table</h4>
                    <div class="admin-form-group">
                        <label class="admin-label">Table Name</label>
                        <input type="text" class="admin-input" id="newTableNameModal" placeholder="e.g., Table 6">
                    </div>
                    <button class="btn btn-success" id="addTableBtnModal"><i class="fas fa-plus"></i> Add Table</button>
                </div>
            </div>
        </div>
        <!-- NEW PRINTER TAB CONTENT (modal) -->
        <div class="admin-content" id="printerTabModal">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-print"></i> Printer Management</h3>
            <div class="categories-management">
                <div class="categories-list">
                    <h4 style="margin-bottom: 15px;">Configured Printers</h4>
                    <div class="categories-list-container" id="printersListContainerModal"></div>
                </div>
                <div class="add-category-form">
                    <h4 style="margin-bottom: 15px;">Add New Printer</h4>
                    <div class="admin-form-group">
                        <label class="admin-label">Printer Name</label>
                        <input type="text" class="admin-input" id="newPrinterNameModal" placeholder="e.g., Kitchen Printer">
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">IP Address / Hostname</label>
                        <input type="text" class="admin-input" id="newPrinterIpModal" placeholder="e.g., 192.168.1.100">
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">Port (optional)</label>
                        <input type="number" class="admin-input" id="newPrinterPortModal" placeholder="e.g., 9100" value="9100">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" id="addPrinterBtnModal"><i class="fas fa-plus"></i> Add Printer</button>
                        <button class="btn btn-info" id="scanPrintersBtnModal"><i class="fas fa-search"></i> Scan</button>
                    </div>
                    <div class="admin-form-group" style="margin-top: 15px;">
                        <label class="admin-label">Scan Range</label>
                        <input type="text" class="admin-input" id="scanRangeModal" value="192.168.1.1-254">
                    </div>
                </div>
            </div>
        </div>
        <!-- Visual Customization Modal -->
        <div class="admin-content" id="customizationTabModal">
            <h3 style="margin-bottom: 20px;">Visual Customization</h3>
            <div style="margin-bottom: 30px;"><div style="font-weight: 500; margin-bottom: 15px; color: var(--text);">Theme Selection</div><div class="theme-gallery" id="themeGalleryModal"></div></div>
            <div style="margin-bottom: 30px;"><div style="font-weight: 500; margin-bottom: 15px; color: var(--text);">Font Selection</div><div class="font-options" id="fontOptionsModal"></div></div>
            <div class="customization-actions"><button class="btn btn-secondary" id="resetCustomizationBtnModal"><i class="fas fa-undo"></i> Reset</button><button class="btn btn-primary" id="saveCustomizationBtnModal"><i class="fas fa-save"></i> Save</button></div>
        </div>
        <!-- Sound Effects Modal -->
        <div class="admin-content" id="soundTabModal">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-music"></i> Sound Effects</h3>
            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="soundEffectsEnabledModal" checked> Enable sounds
                </label>
            </div>
            <button class="btn btn-primary" id="saveSoundEffectsModalBtn"><i class="fas fa-save"></i> Save Settings</button>
        </div>
        <!-- QR Code Table Generator Modal -->
        <div class="admin-content" id="qrTabModal">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-qrcode"></i> QR Code Table Generator</h3>
            <div class="admin-form-group">
                <label class="admin-label">Table Names (one per line)</label>
                <textarea id="tableNamesForQRModal" class="admin-textarea" rows="6">Table 1\nTable 2\nTable 3\nVIP Table</textarea>
            </div>
            <button class="btn btn-primary" id="generateQRPDFBtnModal"><i class="fas fa-file-pdf"></i> Generate PDF</button>
        </div>
        <!-- System Tools Modal -->
        <div class="admin-content" id="systemTabModal">
            <h3 style="margin-bottom: 20px;">System Management</h3>
            <div class="admin-grid">
                <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Clear All Orders</div></div><button class="btn btn-danger" id="clearOrdersBtnModal">Clear Orders</button></div>
                <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Reset Menu</div></div><button class="btn btn-warning" id="resetMenuBtnModal">Reset Menu</button></div>
                <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Export Data</div></div><button class="btn btn-secondary" id="exportDataBtnModal">Export Data</button></div>
                <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Import Data</div></div><input type="file" id="importDataInputModal" style="display:none;"><button class="btn btn-secondary" id="importDataBtnModal">Import Data</button></div>
            </div>
            <div style="margin-top: 30px;"><h4>System Statistics</h4><div id="systemStatsModal"></div></div>
        </div>
    </div>
</div>

<!-- ========== NEW ADMIN LOGIN PROMPT (email/password) ========== -->
<div class="admin-code-prompt" id="adminLoginPrompt">
    <div class="admin-code-container">
        <div class="admin-code-icon"><i class="fas fa-lock"></i></div>
        <h3 class="admin-code-title">Admin Login</h3>
        <p class="admin-code-subtitle">Enter your email and password</p>
        <input type="email" class="admin-code-input" id="adminEmail" placeholder="Email" autocomplete="off">
        <input type="password" class="admin-code-input" id="adminPassword" placeholder="Password" autocomplete="off">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" id="cancelAdminLoginBtn" style="flex: 1;">Cancel</button>
            <button class="btn btn-primary" id="submitAdminLoginBtn" style="flex: 1;">Login</button>
        </div>
        <div id="loginError" style="color: var(--danger); margin-top: 10px; font-size: 14px; display: none;"></div>
    </div>
</div>

<!-- ========== ADMIN CHANGE CONFIRMATION PROMPT (unchanged, still uses numeric code) ========== -->
<div class="admin-code-prompt" id="adminChangePrompt">
    <div class="admin-code-container">
        <div class="admin-code-icon"><i class="fas fa-shield-alt"></i></div>
        <h3 class="admin-code-title" data-i18n="adminChangeTitle">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î‘Î»Î»Î±Î³ÏÎ½</h3>
        <p class="admin-code-subtitle" data-i18n="adminChangeSubtitle">Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚ Î³Î¹Î± Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÏ„Îµ Ï„Î¹Ï‚ Î±Î»Î»Î±Î³Î­Ï‚</p>
        <input type="password" class="admin-code-input" id="adminChangeCodeInput" placeholder="Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ 4ÏˆÎ®Ï†Î¹Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ" maxlength="4" autocomplete="off">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" id="cancelChangeBtn" style="flex: 1;" data-i18n="cancel">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
            <button class="btn btn-primary" id="submitChangeCodeBtn" style="flex: 1;" data-i18n="confirm">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·</button>
        </div>
    </div>
</div>

<!-- ========== TABLE SETTINGS MODAL (NEW) ========== -->
<div class="admin-code-prompt" id="tableSettingsModal">
    <div class="admin-code-container" style="max-width: 600px; text-align: left;">
        <div class="admin-code-icon"><i class="fas fa-sliders-h"></i></div>
        <h3 class="admin-code-title" id="tableSettingsTitle">Settings for Table <span id="tableSettingsName"></span></h3>
        <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 10px;">
                <input type="checkbox" id="tableSettingHelp"> Enable Help Button
            </label>
            <label style="display: block; margin-bottom: 10px;">
                <input type="checkbox" id="tableSettingPayRequest"> Enable Payment Request Button
            </label>
            <hr style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 10px;">
                <input type="checkbox" id="tableSettingCard"> Enable Card Payment
            </label>
            <label style="display: block; margin-bottom: 10px;">
                <input type="checkbox" id="tableSettingCash"> Enable Cash Payment
            </label>
            <hr style="margin: 15px 0;">
            <label style="display: block; margin-bottom: 10px;">
                <input type="checkbox" id="tableSettingPayNow"> Enable Pay Now
            </label>
            <label style="display: block; margin-bottom: 10px;">
                <input type="checkbox" id="tableSettingPayLater"> Enable Pay Later
            </label>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" id="cancelTableSettingsBtn" style="flex: 1;">Cancel</button>
            <button class="btn btn-primary" id="saveTableSettingsBtn" style="flex: 1;">Save Settings</button>
        </div>
    </div>
</div>

<!-- ========== OPTIONS MODAL ========== -->
<div class="options-modal" id="optionsModal">
    <div class="options-modal-container">
        <div id="optionsModalContent"></div>
    </div>
</div>

<!-- ========== EDIT ORDER MODAL (NEW) ========== -->
<div class="edit-order-modal" id="editOrderModal">
    <div class="edit-order-container">
        <h3 style="margin-bottom: 20px;"><i class="fas fa-edit"></i> Edit Order <span id="editOrderNumber"></span></h3>
        <div id="editOrderItemsList"></div>
        <div style="margin-top: 20px; text-align: right; font-size: 18px; font-weight: 600;">
            <span data-i18n="total">Total:</span> $<span id="editOrderTotal">0.00</span>
        </div>
        <div class="payment-actions" style="margin-top: 30px;">
            <button class="btn btn-secondary" id="cancelEditOrderBtn"><i class="fas fa-times"></i> Cancel</button>
            <button class="btn btn-primary" id="saveEditOrderBtn"><i class="fas fa-save"></i> Save Changes</button>
        </div>
    </div>
</div>

<!-- ========== CART FLOATING BUTTON ========== -->
<div class="cart-floating" id="cartFloating">
    <i class="fas fa-shopping-basket"></i>
    <div class="cart-count" id="cartCount">0</div>
</div>

<!-- ========== ADMIN FLOATING ICON ========== -->
<div class="admin-floating" id="adminFloating" title="Î£ÏÎ½Î´ÎµÏƒÎ· Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®">
    <i class="fas fa-shield-alt"></i>
</div>

<!-- ========== NOTIFICATION ========== -->
<div class="notification" id="notification">
    <i class="fas fa-check-circle"></i>
    <div id="notificationText">Î¤Î¿ ÎµÎ¯Î´Î¿Ï‚ Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ ÎºÎ±Î»Î¬Î¸Î¹!</div>
</div>

<!-- THIRD HIDDEN MAPPING (l â†’ 6) -->
<div style="display:none;"><span class="code-mapping" data-letter="l" data-digit="6"></span></div>

<script>
    // ========== BUILD THE CODE MAP FROM HIDDEN ELEMENTS (NO FALLBACK) ==========
    function buildCodeMap() {
        const map = {};
        document.querySelectorAll('.code-mapping').forEach(el => {
            const letter = el.getAttribute('data-letter');
            const digit = el.getAttribute('data-digit');
            if (letter && digit) map[letter] = digit;
        });
        return map;
    }

    const codeMap = buildCodeMap();

    function decodeCode(encoded) {
        return encoded.split('').map(ch => codeMap[ch] || ch).join('');
    }

    // ========== TRANSLATIONS OBJECT (unchanged) ==========
    const translations = {
        el: {
            appTitle: "Î•Ï†Î±ÏÎ¼Î¿Î³Î® Î•ÏƒÏ„Î¹Î±Ï„Î¿ÏÎ¯Î¿Ï… - PERFECT + SOUNDS",
            loading: "Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î¼ÎµÎ½Î¿Ï...",
            helpButton: "Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ Î²Î¿Î®Î¸ÎµÎ¹Î±?",
            requestPay: "Î‘Î¯Ï„Î·Î¼Î± Î Î»Î·ÏÏ‰Î¼Î®Ï‚",
            backToAdmin: "Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿Î½ Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®",
            myOrdersButton: "ÎŸÎ¹ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚ Î¼Î¿Ï…",
            tableInfo: "Î£Î±ÏÏÏƒÏ„Îµ QR Î³Î¹Î± Î­Î½Î±ÏÎ¾Î·",
            scannerTitle: "Î£Î±ÏÏÏƒÏ„Îµ Ï„Î¿ QR Ï„Î¿Ï… Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï",
            scannerSubtitle: "Î£Ï„ÏÎ­ÏˆÏ„Îµ Ï„Î·Î½ ÎºÎ¬Î¼ÎµÏÎ± ÏƒÏ„Î¿ QR Ï„Î¿Ï… Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï ÏƒÎ±Ï‚ Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÏ„Îµ",
            qrPlaceholder: "Î ÎµÏÎ¹Î¿Ï‡Î® Î£Î¬ÏÏ‰ÏƒÎ·Ï‚ QR",
            demoTablesInstruction: "Î“Î¹Î± Î´Î¿ÎºÎ¹Î¼Î®, ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î­Î½Î± Ï„ÏÎ±Ï€Î­Î¶Î¹:",
            table1: "Î¤ÏÎ±Ï€Î­Î¶Î¹ 1",
            table2: "Î¤ÏÎ±Ï€Î­Î¶Î¹ 2",
            table3: "Î¤ÏÎ±Ï€Î­Î¶Î¹ 3",
            table4: "Î¤ÏÎ±Ï€Î­Î¶Î¹ 4",
            table5: "Î¤ÏÎ±Ï€Î­Î¶Î¹ 5",
            vipTable: "Î¤ÏÎ±Ï€Î­Î¶Î¹ VIP",
            scannerNote: "ÎœÏŒÎ»Î¹Ï‚ ÏƒÎ±ÏÏÏƒÎµÏ„Îµ, Î¸Î± Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î¿ Î¼ÎµÎ½Î¿Ï ÎºÎ±Î¹ Î½Î± ÎºÎ¬Î½ÎµÏ„Îµ Ï„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚.",
            adminAccessNote: "Î ÏÏŒÏƒÎ²Î±ÏƒÎ· Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î® Î¼ÏŒÎ½Î¿ Î¼Î­ÏƒÏ‰ QR Ï„Î¿Ï… Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï Admin.",
            menuTitle: "Î¤Î¿ ÎœÎµÎ½Î¿Ï Î¼Î±Ï‚",
            menuSubtitle: "Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎµÎ¯Î´Î· Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚",
            cartTitle: "Î— Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚",
            cartSubtitle: "Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Ï€ÏÎ¹Î½ Ï„Î·Î½ Ï€Î»Î·ÏÏ‰Î¼Î®",
            emptyCart: "Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÏƒÎ±Ï‚ ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿",
            subtotal: "Î¥Ï€Î¿ÏƒÏÎ½Î¿Î»Î¿ (Î¼Îµ Ï†ÏŒÏÎ¿Ï…Ï‚)",
            total: "Î£ÏÎ½Î¿Î»Î¿",
            backToMenu: "Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿ ÎœÎµÎ½Î¿Ï",
            proceedToPayment: "Î£Ï…Î½Î­Ï‡ÎµÎ¹Î± ÏƒÏ„Î·Î½ Î Î»Î·ÏÏ‰Î¼Î®",
            paymentTitle: "Î Î»Î·ÏÏ‰Î¼Î®",
            paymentSubtitle: "ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÏƒÏ„Îµ Ï„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î¼Îµ Ï€Î»Î·ÏÏ‰Î¼Î®",
            paymentMethod: "Î¤ÏÏŒÏ€Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚",
            paymentCard: "Î Î¹ÏƒÏ„Ï‰Ï„Î¹ÎºÎ®/Î§ÏÎµÏ‰ÏƒÏ„Î¹ÎºÎ® ÎšÎ¬ÏÏ„Î±",
            paymentCardDesc: "Î Î»Î·ÏÏÏƒÏ„Îµ Î¼Îµ ÎºÎ¬ÏÏ„Î±",
            paymentCash: "ÎœÎµÏ„ÏÎ·Ï„Î¬",
            paymentCashDesc: "Î Î»Î·ÏÏÏƒÏ„Îµ Î¼Îµ Î¼ÎµÏ„ÏÎ·Ï„Î¬",
            paymentTime: "Î§ÏÏŒÎ½Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚",
            payNow: "Î Î»Î·ÏÏ‰Î¼Î® Î¤ÏÏÎ±",
            payNowDesc: "ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÏƒÏ„Îµ Ï„Î·Î½ Ï€Î»Î·ÏÏ‰Î¼Î® Î¬Î¼ÎµÏƒÎ±",
            payLater: "Î Î»Î·ÏÏ‰Î¼Î® Î‘ÏÎ³ÏŒÏ„ÎµÏÎ±",
            payLaterDesc: "Î Î»Î·ÏÏÏƒÏ„Îµ ÏƒÏ„Î¿ Ï„Î±Î¼ÎµÎ¯Î¿ ÏŒÏ„Î±Î½ Ï†ÎµÏÎ³ÎµÏ„Îµ",
            backToCart: "Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿ ÎšÎ±Î»Î¬Î¸Î¹",
            confirmPayment: "Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î Î»Î·ÏÏ‰Î¼Î®Ï‚",
            myOrdersTitle: "ÎŸÎ¹ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚ Î¼Î¿Ï…",
            myOrdersSubtitle: "Î”ÎµÎ¯Ï„Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎµÏ‚ ÎºÎ±Î¹ Ï€Î±Î»Î¹Î­Ï‚ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚ ÏƒÎ±Ï‚",
            newOrder: "ÎÎ­Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±",
            confirmationTitle: "Î— Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± Î•Ï€Î¹Î²ÎµÎ²Î±Î¹ÏÎ¸Î·ÎºÎµ!",
            confirmationMessage: "Î•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ¼Îµ Î³Î¹Î± Ï„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚. Î¤Î¿ Ï†Î±Î³Î·Ï„ÏŒ ÏƒÎ±Ï‚ Î¸Î± ÎµÏ„Î¿Î¹Î¼Î±ÏƒÏ„ÎµÎ¯ ÏƒÏÎ½Ï„Î¿Î¼Î±.",
            viewMyOrders: "Î ÏÎ¿Î²Î¿Î»Î® Ï„Ï‰Î½ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¹ÏÎ½ Î¼Î¿Ï…",
            orderDetails: "Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚",
            totalWithTax: "Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î Î¿ÏƒÏŒ (Î¼Îµ Ï†ÏŒÏÎ¿Ï…Ï‚)",
            paymentInfo: "Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚",
            paymentMethodLabel: "Î¤ÏÏŒÏ€Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚:",
            paymentTimeLabel: "Î§ÏÏŒÎ½Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚:",
            orderStatusLabel: "ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚:",
            estimatedTimeLabel: "Î•ÎºÏ„Î¹Î¼ÏÎ¼ÎµÎ½Î¿Ï‚ Ï‡ÏÏŒÎ½Î¿Ï‚ Ï€ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î±Ï‚:",
            minutes: "Î»ÎµÏ€Ï„Î¬",
            viewFullMenu: "Î ÏÎ¿Î²Î¿Î»Î® Î Î»Î®ÏÎ¿Ï…Ï‚ ÎœÎµÎ½Î¿Ï",
            needHelp: "Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ Î²Î¿Î®Î¸ÎµÎ¹Î±?",
            adminCodeTitle: "Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Î ÏÏŒÏƒÎ²Î±ÏƒÎ· Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®",
            adminCodeSubtitle: "Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î® Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ",
            adminChangeTitle: "Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î‘Î»Î»Î±Î³ÏÎ½",
            adminChangeSubtitle: "Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚ Î³Î¹Î± Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÏ„Îµ Ï„Î¹Ï‚ Î±Î»Î»Î±Î³Î­Ï‚",
            cancel: "Î‘ÎºÏÏÏ‰ÏƒÎ·",
            submit: "Î¥Ï€Î¿Î²Î¿Î»Î®",
            confirm: "Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·"
        },
        en: {
            appTitle: "Restaurant App - PERFECT + SOUNDS",
            loading: "Loading menu...",
            helpButton: "Need help?",
            requestPay: "Request Payment",
            backToAdmin: "Back to Admin",
            myOrdersButton: "My Orders",
            tableInfo: "Scan QR to start",
            scannerTitle: "Scan Table QR",
            scannerSubtitle: "Point your camera at the table QR to begin",
            qrPlaceholder: "QR Scan Area",
            demoTablesInstruction: "For testing, select a table:",
            table1: "Table 1",
            table2: "Table 2",
            table3: "Table 3",
            table4: "Table 4",
            table5: "Table 5",
            vipTable: "VIP Table",
            scannerNote: "Once scanned, you can view the menu and place your order.",
            adminAccessNote: "Admin access only via Admin table QR.",
            menuTitle: "Our Menu",
            menuSubtitle: "Select items to add to your order",
            cartTitle: "Your Order",
            cartSubtitle: "Review your order before payment",
            emptyCart: "Your cart is empty",
            subtotal: "Subtotal (incl. tax)",
            total: "Total",
            backToMenu: "Back to Menu",
            proceedToPayment: "Proceed to Payment",
            paymentTitle: "Payment",
            paymentSubtitle: "Complete your order with payment",
            paymentMethod: "Payment Method",
            paymentCard: "Credit/Debit Card",
            paymentCardDesc: "Pay with card",
            paymentCash: "Cash",
            paymentCashDesc: "Pay with cash",
            paymentTime: "Payment Time",
            payNow: "Pay Now",
            payNowDesc: "Complete payment immediately",
            payLater: "Pay Later",
            payLaterDesc: "Pay at the counter when you leave",
            backToCart: "Back to Cart",
            confirmPayment: "Confirm Payment",
            myOrdersTitle: "My Orders",
            myOrdersSubtitle: "View all your current and past orders",
            newOrder: "New Order",
            confirmationTitle: "Order Confirmed!",
            confirmationMessage: "Thank you for your order. Your food will be prepared shortly.",
            viewMyOrders: "View My Orders",
            orderDetails: "Order Details",
            totalWithTax: "Total Amount (incl. tax)",
            paymentInfo: "Payment Information",
            paymentMethodLabel: "Payment Method:",
            paymentTimeLabel: "Payment Time:",
            orderStatusLabel: "Order Status:",
            estimatedTimeLabel: "Estimated preparation time:",
            minutes: "minutes",
            viewFullMenu: "View Full Menu",
            needHelp: "Need help?",
            adminCodeTitle: "Administrator Access Required",
            adminCodeSubtitle: "Please enter the administrator code to continue",
            adminChangeTitle: "Confirm Changes",
            adminChangeSubtitle: "Please enter the confirmation code to save changes",
            cancel: "Cancel",
            submit: "Submit",
            confirm: "Confirm"
        }
    };

    // ========== FIREBASE INITIALIZATION ==========
    const firebaseConfig = {
        apiKey: "AIzaSyBOYqnY3hDTCjBJv97zn4_LlpfpA6Mnvk0",
        authDomain: "trytobereal-ce3f1.firebaseapp.com",
        projectId: "trytobereal-ce3f1",
        storageBucket: "trytobereal-ce3f1.firebasestorage.app",
        messagingSenderId: "53123319511",
        appId: "1:53123319511:web:78fb36d731b9e94b92d292"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ========== GET BUSINESS ID FROM URL ==========
    const urlParams = new URLSearchParams(window.location.search);
    const businessId = urlParams.get('business') || 'default';

    // ========== HELPER FUNCTIONS FOR BUSINESSâ€‘SPECIFIC COLLECTIONS ==========
    function getSettingsDoc() {
        if (businessId === 'default') return db.collection('settings').doc('restaurantInfo');
        return db.collection(`business_${businessId}_settings`).doc('restaurantInfo');
    }
    function getCategoriesDoc() {
        if (businessId === 'default') return db.collection('settings').doc('categories');
        return db.collection(`business_${businessId}_settings`).doc('categories');
    }
    function getCustomizationDoc() {
        if (businessId === 'default') return db.collection('settings').doc('customization');
        return db.collection(`business_${businessId}_settings`).doc('customization');
    }
    function getSoundEffectsDoc() {
        if (businessId === 'default') return db.collection('settings').doc('soundEffects');
        return db.collection(`business_${businessId}_settings`).doc('soundEffects');
    }
    function getCumulativeStatsDoc() {
        if (businessId === 'default') return db.collection('settings').doc('cumulativeStats');
        return db.collection(`business_${businessId}_settings`).doc('cumulativeStats');
    }
    function getMenuItemsCollection() {
        if (businessId === 'default') return db.collection('menuItems');
        return db.collection(`business_${businessId}_menuItems`);
    }
    function getOrdersCollection() {
        if (businessId === 'default') return db.collection('orders');
        return db.collection(`business_${businessId}_orders`);
    }
    function getHelpRequestsCollection() {
        if (businessId === 'default') return db.collection('helpRequests');
        return db.collection(`business_${businessId}_helpRequests`);
    }
    function getTablesCollection() {
        if (businessId === 'default') return db.collection('tables');
        return db.collection(`business_${businessId}_tables`);
    }
    // NEW: Printer collection
    function getPrintersCollection() {
        if (businessId === 'default') return db.collection('printers');
        return db.collection(`business_${businessId}_printers`);
    }
    // Helper to get the business document (stores adminEmail etc.)
    function getBusinessDoc() {
        return db.collection('businesses').doc(businessId);
    }

    // Update all Firestore save/load functions to use these helpers
    async function saveRestaurantInfo() {
        try {
            await getSettingsDoc().set(state.restaurantInfo);
        } catch (e) {
            console.error('Error saving restaurant info:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function saveMenuItem(item) {
        try {
            await getMenuItemsCollection().doc(item.id.toString()).set(item);
        } catch (e) {
            console.error('Error saving menu item:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function deleteMenuItemFirestore(id) {
        try {
            await getMenuItemsCollection().doc(id.toString()).delete();
        } catch (e) {
            console.error('Error deleting menu item:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function saveCategories() {
        try {
            const sorted = [...state.categories].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            await getCategoriesDoc().set({ list: sorted });
        } catch (e) {
            console.error('Error saving categories:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function saveOrder(order) {
        try {
            await getOrdersCollection().doc(order.orderNumber).set(order);
        } catch (e) {
            console.error('Error saving order:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function deleteOrderFirestore(orderId) {
        try {
            await getOrdersCollection().doc(orderId).delete();
        } catch (e) {
            console.error('Error deleting order:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function saveCustomization() {
        try {
            await getCustomizationDoc().set(state.customization);
        } catch (e) {
            console.error('Error saving customization:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function saveSoundEffects() {
        try {
            await getSoundEffectsDoc().set(state.soundEffects);
        } catch (e) {
            console.error('Error saving sound effects:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function saveHelpRequest(request) {
        try {
            await getHelpRequestsCollection().doc(request.id).set(request);
        } catch (e) {
            console.error('Error saving help request:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function deleteHelpRequestFirestore(id) {
        try {
            await getHelpRequestsCollection().doc(id).delete();
        } catch (e) {
            console.error('Error deleting help request:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function saveCumulativeStats() {
        try {
            await getCumulativeStatsDoc().set(state.cumulativeStats);
        } catch (e) {
            console.error('Error saving cumulative stats:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    // UPDATED: saveTable now expects an object {name, settings}
    async function saveTable(tableObj) {
        try {
            await getTablesCollection().doc(tableObj.name).set(tableObj);
        } catch (e) {
            console.error('Error saving table:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function deleteTableFirestore(tableName) {
        try {
            await getTablesCollection().doc(tableName).delete();
        } catch (e) {
            console.error('Error deleting table:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    // NEW: Printer Firestore functions
    async function savePrinter(printer) {
        try {
            await getPrintersCollection().doc(printer.id).set(printer);
        } catch (e) {
            console.error('Error saving printer:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }
    async function deletePrinterFirestore(id) {
        try {
            await getPrintersCollection().doc(id).delete();
        } catch (e) {
            console.error('Error deleting printer:', e);
            showNotification('Permission denied: ' + e.message);
        }
    }

    // ========== STATE (with obfuscated admin codes) ==========
    const state = {
        currentTable: null,
        cart: [],
        selectedPaymentMethod: null,
        selectedPaymentTime: null,
        currentOrderNumber: null,
        currentLanguage: 'el',
        restaurantInfo: {
            name: "DineEasy",
            taxRate: 8,
            estimatedPrepTime: "15-25",
            logoImage: "",
            welcomeMessage: "",
            adminChangeCode: decodeCode("lele")  // default 6262
        },
        menuItems: [],
        orders: [],
        helpRequests: [],
        tables: [],   // now array of objects { name, settings }
        // NEW: printers array
        printers: [],
        seenHelpRequests: new Set(),
        adminAccessCode: decodeCode("gege"),  // decodes to "3232"
        adminChangeCode: decodeCode("lele"),  // decodes to "6262" (will be overwritten by Firestore)
        categories: [],
        isAdminMode: false,
        pendingAdminAction: null,
        pendingAdminCodeAction: null,
        currentImageUpload: null,
        customization: {
            primary: "#e63946",
            primaryDark: "#c1121f",
            secondary: "#457b9d",
            light: "#f8f9fa",
            dark: "#212529",
            gray: "#6c757d",
            lightGray: "#e9ecef",
            success: "#2a9d8f",
            warning: "#e9c46a",
            danger: "#dc3545",
            shadow: "0 4px 12px rgba(0, 0, 0, 0.08)",
            radius: "12px",
            background: "#fefefe",
            text: "#212529",
            cardBg: "#ffffff",
            headerBg: "#ffffff",
            menuBg: "#ffffff",
            cartBg: "#ffffff",
            paymentBg: "#ffffff",
            buttonText: "#ffffff",
            fontPrimary: "'Poppins', sans-serif",
            fontSecondary: "'Playfair Display', serif",
            backgroundGradient: null,
            backgroundBlur: 0
        },
        currentTheme: "default",
        currentFont: "poppins",
        soundEffects: {
            enabled: true,
            addToCartSound: null,
            checkoutSound: null,
            helpRequestSound: null,
            newOrderSound: null
        },
        helpSoundInterval: null,
        cumulativeStats: { totalOrders: 0, totalRevenue: 0 },
        currentEditOrder: null,
        // Cooldown timestamps per table
        lastHelpRequestTimeByTable: {},
        lastPayRequestTimeByTable: {}
    };

    // ========== DEFAULT DATA (unchanged) ==========
    const defaultMenuItems = [
        { id: 1, name: "Î Î¯Ï„ÏƒÎ± ÎœÎ±ÏÎ³Î±ÏÎ¯Ï„Î±", nameEn: "Margherita Pizza", description: "ÎšÎ»Î±ÏƒÎ¹ÎºÎ® ÏƒÎ¬Î»Ï„ÏƒÎ± Î½Ï„Î¿Î¼Î¬Ï„Î±Ï‚, Ï†ÏÎ­ÏƒÎºÎ¹Î± Î¼Î¿Ï„ÏƒÎ±ÏÎ­Î»Î±, Î²Î±ÏƒÎ¹Î»Î¹ÎºÏŒÏ‚", descriptionEn: "Classic tomato sauce, fresh mozzarella, basil", price: 14.99, category: "pizza", tags: ["Î§Î¿ÏÏ„Î¿Ï†Î±Î³Î¹ÎºÎ®", "Î”Î·Î¼Î¿Ï†Î¹Î»Î®Ï‚"], tagsEn: ["Vegetarian", "Popular"], image: "", options: [] },
        { id: 2, name: "Î Î¯Ï„ÏƒÎ± Î ÎµÏ€ÎµÏÎ¿Î½Î¯", nameEn: "Pepperoni Pizza", description: "Î£Î¬Î»Ï„ÏƒÎ± Î½Ï„Î¿Î¼Î¬Ï„Î±Ï‚, Î¼Î¿Ï„ÏƒÎ±ÏÎ­Î»Î±, Î´Î¹Ï€Î»ÏŒ Ï€ÎµÏ€ÎµÏÏŒÎ½Î¹", descriptionEn: "Tomato sauce, mozzarella, double pepperoni", price: 16.99, category: "pizza", tags: ["Î Î¹ÎºÎ¬Î½Ï„Î¹ÎºÎ·"], tagsEn: ["Spicy"], image: "", options: [] },
        { id: 3, name: "Î£Î±Î»Î¬Ï„Î± ÎšÎ±Î¯ÏƒÎ±ÏÎ±", nameEn: "Caesar Salad", description: "ÎœÎ±ÏÎ¿ÏÎ»Î¹ ÏÏ‰Î¼Î±ÏŠÎºÏŒ, Ï€Î±ÏÎ¼ÎµÎ¶Î¬Î½Î±, ÎºÏÎ¿Ï…Ï„ÏŒÎ½, ÏƒÎ¬Î»Ï„ÏƒÎ± ÎšÎ±Î¯ÏƒÎ±ÏÎ±", descriptionEn: "Romaine lettuce, parmesan, croutons, Caesar dressing", price: 9.99, category: "salads", tags: ["Î§Î¿ÏÏ„Î¿Ï†Î±Î³Î¹ÎºÎ®"], tagsEn: ["Vegetarian"], image: "", options: [] },
        { id: 4, name: "Î§Ï‰ÏÎ¹Î¬Ï„Î¹ÎºÎ· Î£Î±Î»Î¬Ï„Î±", nameEn: "Greek Salad", description: "Î‘Î³Î³Î¿ÏÏÎ¹, Î½Ï„Î¿Î¼Î¬Ï„Î±, ÎµÎ»Î¹Î­Ï‚, Ï†Î­Ï„Î±, ÏÎ¯Î³Î±Î½Î·", descriptionEn: "Cucumber, tomato, olives, feta, oregano", price: 10.99, category: "salads", tags: ["Î§Î¿ÏÏ„Î¿Ï†Î±Î³Î¹ÎºÎ®", "Î¥Î³Î¹ÎµÎ¹Î½Î®"], tagsEn: ["Vegetarian", "Healthy"], image: "", options: [] },
        { id: 5, name: "Î£Ï€Î±Î³Î³Î­Ï„Î¹ ÎšÎ±ÏÎ¼Ï€Î¿Î½Î¬ÏÎ±", nameEn: "Spaghetti Carbonara", description: "Î‘Ï…Î³Î¬, Ï„Ï…ÏÎ¯, Ï€Î±Î½ÏƒÎ­Ï„Î±, Î¼Î±ÏÏÎ¿ Ï€Î¹Ï€Î­ÏÎ¹", descriptionEn: "Eggs, cheese, pancetta, black pepper", price: 13.99, category: "pasta", tags: ["Î”Î·Î¼Î¿Ï†Î¹Î»Î®Ï‚"], tagsEn: ["Popular"], image: "", options: [] },
        { id: 6, name: "Î›Î±Î¶Î¬Î½Î¹Î±", nameEn: "Lasagna", description: "Î£Ï„ÏÏÏƒÎµÎ¹Ï‚ Î¶ÏÎ¼Î·Ï‚, ÎºÎ¹Î¼Î¬Ï‚, Î¼Ï€ÎµÏƒÎ±Î¼Î­Î», Ï€Î±ÏÎ¼ÎµÎ¶Î¬Î½Î±", descriptionEn: "Layered pasta, minced meat, bÃ©chamel, parmesan", price: 15.99, category: "pasta", tags: [], tagsEn: [], image: "", options: [] },
        { id: 7, name: "Î£Î¿Î»Î¿Î¼ÏŒÏ‚ ÏƒÏ„Î· Î£Ï‡Î¬ÏÎ±", nameEn: "Grilled Salmon", description: "Î¦ÏÎ­ÏƒÎºÎ¿ Ï†Î¹Î»Î­Ï„Î¿ ÏƒÎ¿Î»Î¿Î¼Î¿Ï, ÏƒÎ¬Î»Ï„ÏƒÎ± Î»ÎµÎ¼Î¿Î½Î¹Î¿Ï, Î»Î±Ï‡Î±Î½Î¹ÎºÎ¬", descriptionEn: "Fresh salmon fillet, lemon sauce, vegetables", price: 19.99, category: "main", tags: ["Î§Ï‰ÏÎ¯Ï‚ Î³Î»Î¿Ï…Ï„Î­Î½Î·"], tagsEn: ["Gluten-free"], image: "", options: [] },
        { id: 8, name: "ÎœÏ€ÏÎ¹Î¶ÏŒÎ»Î± Ribeye", nameEn: "Ribeye Steak", description: "300Î³Ï. ribeye, ÏƒÏ…Î½Î¿Î´ÎµÏÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï€Î±Ï„Î¬Ï„ÎµÏ‚ ÎºÎ±Î¹ ÏƒÎ±Î»Î¬Ï„Î±", descriptionEn: "300g ribeye, served with potatoes and salad", price: 24.99, category: "main", tags: ["Î”Î·Î¼Î¿Ï†Î¹Î»Î®Ï‚"], tagsEn: ["Popular"], image: "", options: [] },
        { id: 9, name: "Î¤Î¹ÏÎ±Î¼Î¹ÏƒÎ¿Ï", nameEn: "Tiramisu", description: "ÎœÏ€Î¹ÏƒÎºÏŒÏ„Î± Savoiardi ÎµÎ¼Ï€Î¿Ï„Î¹ÏƒÎ¼Î­Î½Î± Î¼Îµ ÎºÎ±Ï†Î­, ÎºÏÎ­Î¼Î± Î¼Î±ÏƒÎºÎ±ÏÏ€ÏŒÎ½Îµ, ÎºÎ±ÎºÎ¬Î¿", descriptionEn: "Savoiardi biscuits soaked in coffee, mascarpone cream, cocoa", price: 7.99, category: "desserts", tags: ["Î§Î¿ÏÏ„Î¿Ï†Î±Î³Î¹ÎºÎ®"], tagsEn: ["Vegetarian"], image: "", options: [] },
        { id: 10, name: "Î¤ÏƒÎ¹Î¶ÎºÎ­Î¹Îº", nameEn: "Cheesecake", description: "ÎÎµÎ¿Ï‹Î¿ÏÎºÎ­Î¶Î¹ÎºÎ¿, ÏƒÎ¬Î»Ï„ÏƒÎ± Î¼Î¿ÏÏÏ‰Î½", descriptionEn: "New York style, berry sauce", price: 6.99, category: "desserts", tags: ["Î§Î¿ÏÏ„Î¿Ï†Î±Î³Î¹ÎºÎ®"], tagsEn: ["Vegetarian"], image: "", options: [] },
        { id: 11, name: "Coca-Cola", nameEn: "Coca-Cola", description: "Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÏŒ 330ml", descriptionEn: "Soft drink 330ml", price: 2.50, category: "beverages", tags: [], tagsEn: [], image: "", options: [] },
        { id: 12, name: "Î¦ÏÎ­ÏƒÎºÎ¿Ï‚ Î§Ï…Î¼ÏŒÏ‚ Î Î¿ÏÏ„Î¿ÎºÎ¬Î»Î¹", nameEn: "Fresh Orange Juice", description: "Î¦ÏÎµÏƒÎºÎ¿ÏƒÏ„Ï…Î¼Î¼Î­Î½Î¿Ï‚", descriptionEn: "Freshly squeezed", price: 3.50, category: "beverages", tags: ["Î¥Î³Î¹ÎµÎ¹Î½Î®"], tagsEn: ["Healthy"], image: "", options: [] }
    ];

    const defaultCategories = [
        { id: "pizza", name: "pizza", displayName: "Î Î¯Ï„ÏƒÎ±", displayNameEn: "Pizza", isDefault: true, displayOrder: 0 },
        { id: "salads", name: "salads", displayName: "Î£Î±Î»Î¬Ï„ÎµÏ‚", displayNameEn: "Salads", isDefault: true, displayOrder: 1 },
        { id: "pasta", name: "pasta", displayName: "Î–Ï…Î¼Î±ÏÎ¹ÎºÎ¬", displayNameEn: "Pasta", isDefault: true, displayOrder: 2 },
        { id: "main", name: "main", displayName: "ÎšÏ…ÏÎ¯Ï‰Ï‚ Î Î¹Î¬Ï„Î±", displayNameEn: "Main Courses", isDefault: true, displayOrder: 3 },
        { id: "desserts", name: "desserts", displayName: "Î•Ï€Î¹Î´ÏŒÏÏ€Î¹Î±", displayNameEn: "Desserts", isDefault: true, displayOrder: 4 },
        { id: "beverages", name: "beverages", displayName: "Î¡Î¿Ï†Î®Î¼Î±Ï„Î±", displayNameEn: "Beverages", isDefault: true, displayOrder: 5 }
    ];

    // ========== THEMES & FONTS (unchanged) ==========
    const themes = {
        default: { name: "Classic Modern", category: "Modern", primary: "#e63946", secondary: "#457b9d", background: "#fefefe", text: "#212529", cardBg: "#ffffff", lightGray: "#e9ecef" },
        midnight: { name: "Midnight Elegance", category: "Modern", primary: "#6c63ff", secondary: "#4cc9f0", background: "#121212", text: "#f5f5f5", cardBg: "#1e1e1e", lightGray: "#2d2d2d" },
        autumn: { name: "Autumn Cozy", category: "Cozy", primary: "#e76f51", secondary: "#f4a261", background: "#fefae0", text: "#283618", cardBg: "#ffffff", lightGray: "#faedcd" },
        coffee: { name: "Coffee Shop", category: "Cozy", primary: "#6f4e37", secondary: "#c19a6b", background: "#f5e9d9", text: "#3e2723", cardBg: "#ffffff", lightGray: "#e6d5c3" },
        forest: { name: "Forest Retreat", category: "Natural", primary: "#2a9d8f", secondary: "#e9c46a", background: "#f1faee", text: "#1d3557", cardBg: "#ffffff", lightGray: "#a8dadc" },
        sage: { name: "Sage Garden", category: "Natural", primary: "#84a98c", secondary: "#52796f", background: "#f8f9fa", text: "#354f52", cardBg: "#ffffff", lightGray: "#cad2c5" },
        citrus: { name: "Citrus Fresh", category: "Vibrant", primary: "#ff9f1c", secondary: "#ffbf69", background: "#f8f9fa", text: "#212529", cardBg: "#ffffff", lightGray: "#ffe8d6" },
        berry: { name: "Berry Bliss", category: "Vibrant", primary: "#9d4edd", secondary: "#c77dff", background: "#f8f9fa", text: "#212529", cardBg: "#ffffff", lightGray: "#e0aaff" },
        ocean: { name: "Ocean Breeze", category: "Calm", primary: "#0077b6", secondary: "#00b4d8", background: "#f8f9fa", text: "#03045e", cardBg: "#ffffff", lightGray: "#caf0f8" },
        lavender: { name: "Lavender Dream", category: "Calm", primary: "#9c89b8", secondary: "#b8bedd", background: "#f8f9fa", text: "#4a4e69", cardBg: "#ffffff", lightGray: "#f0e6ef" },
        gold: { name: "Golden Luxury", category: "Luxury", primary: "#d4af37", secondary: "#f9d976", background: "#1a1a1a", text: "#f5f5f5", cardBg: "#2d2d2d", lightGray: "#3d3d3d" },
        velvet: { name: "Velvet Night", category: "Luxury", primary: "#7209b7", secondary: "#3a0ca3", background: "#0a0a0a", text: "#f5f5f5", cardBg: "#1a1a1a", lightGray: "#2d2d2d" },
        minimalist: { name: "Pure Minimal", category: "Minimalist", primary: "#495057", secondary: "#6c757d", background: "#ffffff", text: "#212529", cardBg: "#f8f9fa", lightGray: "#e9ecef" },
        paper: { name: "Paper White", category: "Minimalist", primary: "#adb5bd", secondary: "#ced4da", background: "#ffffff", text: "#343a40", cardBg: "#f8f9fa", lightGray: "#e9ecef" },
        retro: { name: "Retro Diner", category: "Retro", primary: "#ff6b6b", secondary: "#4ecdc4", background: "#fff9db", text: "#2d3436", cardBg: "#ffffff", lightGray: "#ffeaa7" },
        vintage: { name: "Vintage Charm", category: "Retro", primary: "#dda15e", secondary: "#bc6c25", background: "#fefae0", text: "#283618", cardBg: "#ffffff", lightGray: "#faedcd" },
        corporate: { name: "Corporate Blue", category: "Professional", primary: "#2c3e50", secondary: "#3498db", background: "#ecf0f1", text: "#2c3e50", cardBg: "#ffffff", lightGray: "#bdc3c7" },
        slate: { name: "Slate Professional", category: "Professional", primary: "#34495e", secondary: "#7f8c8d", background: "#f5f7fa", text: "#2c3e50", cardBg: "#ffffff", lightGray: "#dcdde1" },
        candy: { name: "Candy Shop", category: "Playful", primary: "#ff5d8f", secondary: "#ff97b7", background: "#f8f9fa", text: "#212529", cardBg: "#ffffff", lightGray: "#ffcad4" },
        tropical: { name: "Tropical Paradise", category: "Playful", primary: "#06d6a0", secondary: "#118ab2", background: "#f8f9fa", text: "#073b4c", cardBg: "#ffffff", lightGray: "#cbf3f0" }
    };

    const fonts = {
        poppins: { name: "Poppins", primary: "'Poppins', sans-serif", secondary: "'Playfair Display', serif" },
        roboto: { name: "Roboto", primary: "'Roboto', sans-serif", secondary: "'Merriweather', serif" },
        opensans: { name: "Open Sans", primary: "'Open Sans', sans-serif", secondary: "'Merriweather', serif" },
        lato: { name: "Lato", primary: "'Lato', sans-serif", secondary: "'Playfair Display', serif" },
        montserrat: { name: "Montserrat", primary: "'Montserrat', sans-serif", secondary: "'Merriweather', serif" },
        oswald: { name: "Oswald", primary: "'Oswald', sans-serif", secondary: "'PT Sans', sans-serif" },
        raleway: { name: "Raleway", primary: "'Raleway', sans-serif", secondary: "'Merriweather', serif" },
        merriweather: { name: "Merriweather", primary: "'Merriweather', serif", secondary: "'Open Sans', sans-serif" },
        ptsans: { name: "PT Sans", primary: "'PT Sans', sans-serif", secondary: "'Merriweather', serif" },
        nunito: { name: "Nunito", primary: "'Nunito', sans-serif", secondary: "'Playfair Display', serif" },
        quicksand: { name: "Quicksand", primary: "'Quicksand', sans-serif", secondary: "'Merriweather', serif" },
        sourcesans: { name: "Source Sans Pro", primary: "'Source Sans Pro', sans-serif", secondary: "'Merriweather', serif" },
        ubuntu: { name: "Ubuntu", primary: "'Ubuntu', sans-serif", secondary: "'Playfair Display', serif" },
        inter: { name: "Inter", primary: "'Inter', sans-serif", secondary: "'Inter', serif" },
        playfair: { name: "Playfair Display", primary: "'Playfair Display', serif", secondary: "'Poppins', sans-serif" },
        robotoslab: { name: "Roboto Slab", primary: "'Roboto Slab', serif", secondary: "'Roboto', sans-serif" },
        worksans: { name: "Work Sans", primary: "'Work Sans', sans-serif", secondary: "'Merriweather', serif" },
        rubik: { name: "Rubik", primary: "'Rubik', sans-serif", secondary: "'Playfair Display', serif" },
        muli: { name: "Muli", primary: "'Muli', sans-serif", secondary: "'Merriweather', serif" },
        abel: { name: "Abel", primary: "'Abel', sans-serif", secondary: "'Playfair Display', serif" }
    };

    // ========== GRADIENT LIBRARY (60 PREMIUM GRADIENTS) ==========
    const gradientLibrary = [
        // Soft pastels
        { id: 'pastel1', name: 'Soft Peach', gradient: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' },
        { id: 'pastel2', name: 'Mint Breeze', gradient: 'linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%)' },
        { id: 'pastel3', name: 'Lavender Mist', gradient: 'linear-gradient(135deg, #e1bee7 0%, #ba68c8 100%)' },
        { id: 'pastel4', name: 'Buttercream', gradient: 'linear-gradient(135deg, #fff9c4 0%, #fff176 100%)' },
        { id: 'pastel5', name: 'Powder Blue', gradient: 'linear-gradient(135deg, #bbdefb 0%, #64b5f6 100%)' },
        // Rich jewel tones
        { id: 'jewel1', name: 'Sapphire', gradient: 'linear-gradient(135deg, #2c3e50 0%, #3498db 100%)' },
        { id: 'jewel2', name: 'Amethyst', gradient: 'linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%)' },
        { id: 'jewel3', name: 'Emerald', gradient: 'linear-gradient(135deg, #16a085 0%, #27ae60 100%)' },
        { id: 'jewel4', name: 'Ruby', gradient: 'linear-gradient(135deg, #c0392b 0%, #e74c3c 100%)' },
        { id: 'jewel5', name: 'Citrine', gradient: 'linear-gradient(135deg, #f39c12 0%, #f1c40f 100%)' },
        // Warm earth tones
        { id: 'earth1', name: 'Desert Sand', gradient: 'linear-gradient(135deg, #edc9ab 0%, #c38e6b 100%)' },
        { id: 'earth2', name: 'Terra Cotta', gradient: 'linear-gradient(135deg, #cb7e5b 0%, #a75b3a 100%)' },
        { id: 'earth3', name: 'Olive Grove', gradient: 'linear-gradient(135deg, #a8b68a 0%, #7e8d68 100%)' },
        { id: 'earth4', name: 'Cocoa', gradient: 'linear-gradient(135deg, #8b6b4d 0%, #6b4f3a 100%)' },
        { id: 'earth5', name: 'Sienna', gradient: 'linear-gradient(135deg, #e0a07c 0%, #b86b4c 100%)' },
        // Cool moods
        { id: 'cool1', name: 'Arctic Dawn', gradient: 'linear-gradient(135deg, #a8ede0 0%, #80d0c7 100%)' },
        { id: 'cool2', name: 'Frost', gradient: 'linear-gradient(135deg, #d3e0f0 0%, #a0b9d9 100%)' },
        { id: 'cool3', name: 'Stormy Sea', gradient: 'linear-gradient(135deg, #4b6cb0 0%, #182848 100%)' },
        { id: 'cool4', name: 'Glacier', gradient: 'linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%)' },
        { id: 'cool5', name: 'Misty Morning', gradient: 'linear-gradient(135deg, #c9d6ff 0%, #e2e2e2 100%)' },
        // Vibrant hues
        { id: 'vibrant1', name: 'Electric', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
        { id: 'vibrant2', name: 'Fusion', gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
        { id: 'vibrant3', name: 'Coral', gradient: 'linear-gradient(135deg, #f78ca0 0%, #f9748f 100%)' },
        { id: 'vibrant4', name: 'Mango', gradient: 'linear-gradient(135deg, #f5af19 0%, #f12711 100%)' },
        { id: 'vibrant5', name: 'Lime', gradient: 'linear-gradient(135deg, #c6ffdd 0%, #fbd786 100%)' },
        // Elegant neutrals
        { id: 'neutral1', name: 'Pearly White', gradient: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' },
        { id: 'neutral2', name: 'Grey Whisper', gradient: 'linear-gradient(135deg, #e0e0e0 0%, #b0b0b0 100%)' },
        { id: 'neutral3', name: 'Beige Elegance', gradient: 'linear-gradient(135deg, #f4e3d1 0%, #d6c2aa 100%)' },
        { id: 'neutral4', name: 'Stone', gradient: 'linear-gradient(135deg, #b8b8b8 0%, #7a7a7a 100%)' },
        { id: 'neutral5', name: 'Sand Dune', gradient: 'linear-gradient(135deg, #eacda3 0%, #d6ae7b 100%)' },
        // Deep drama
        { id: 'drama1', name: 'Midnight', gradient: 'linear-gradient(135deg, #141e30 0%, #243b55 100%)' },
        { id: 'drama2', name: 'Charcoal', gradient: 'linear-gradient(135deg, #283048 0%, #434343 100%)' },
        { id: 'drama3', name: 'Royal', gradient: 'linear-gradient(135deg, #4b134f 0%, #2c0a2e 100%)' },
        { id: 'drama4', name: 'Deep Purple', gradient: 'linear-gradient(135deg, #673ab7 0%, #512da8 100%)' },
        { id: 'drama5', name: 'Oil Spill', gradient: 'linear-gradient(135deg, #0f2027 0%, #203a43 100%)' },
        // Sunsets
        { id: 'sunset1', name: 'Golden Hour', gradient: 'linear-gradient(135deg, #f6d365 0%, #fda085 100%)' },
        { id: 'sunset2', name: 'Twilight', gradient: 'linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)' },
        { id: 'sunset3', name: 'Sunset Boulevard', gradient: 'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)' },
        { id: 'sunset4', name: 'Dusk', gradient: 'linear-gradient(135deg, #ffd89b 0%, #19547b 100%)' },
        { id: 'sunset5', name: 'Horizon', gradient: 'linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)' },
        // Ocean skies
        { id: 'ocean1', name: 'Pacific', gradient: 'linear-gradient(135deg, #1c92d2 0%, #f2fcfe 100%)' },
        { id: 'ocean2', name: 'Lagoon', gradient: 'linear-gradient(135deg, #00b4db 0%, #0083b0 100%)' },
        { id: 'ocean3', name: 'Deep Blue', gradient: 'linear-gradient(135deg, #0c3483 0%, #6b8cce 100%)' },
        { id: 'ocean4', name: 'Caribbean', gradient: 'linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%)' },
        { id: 'ocean5', name: 'Wave', gradient: 'linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%)' },
        // Forest greens
        { id: 'forest1', name: 'Pine', gradient: 'linear-gradient(135deg, #134e5e 0%, #71b280 100%)' },
        { id: 'forest2', name: 'Moss', gradient: 'linear-gradient(135deg, #4ac29a 0%, #bdfff3 100%)' },
        { id: 'forest3', name: 'Jungle', gradient: 'linear-gradient(135deg, #1d976c 0%, #93f9b9 100%)' },
        { id: 'forest4', name: 'Fern', gradient: 'linear-gradient(135deg, #2c7744 0%, #5fa06d 100%)' },
        { id: 'forest5', name: 'Evergreen', gradient: 'linear-gradient(135deg, #0b3b2c 0%, #2b7a4b 100%)' },
        // Luxurious metallics
        { id: 'metallic1', name: 'Gold', gradient: 'linear-gradient(135deg, #d4af37 0%, #aa8c30 100%)' },
        { id: 'metallic2', name: 'Silver', gradient: 'linear-gradient(135deg, #bdc3c7 0%, #8e9eab 100%)' },
        { id: 'metallic3', name: 'Bronze', gradient: 'linear-gradient(135deg, #cd7f32 0%, #b06d2b 100%)' },
        { id: 'metallic4', name: 'Rose Gold', gradient: 'linear-gradient(135deg, #f7cac9 0%, #d4a5a5 100%)' },
        { id: 'metallic5', name: 'Copper', gradient: 'linear-gradient(135deg, #b87333 0%, #9c5e2b 100%)' },
        // Abstract blends
        { id: 'abstract1', name: 'Neon', gradient: 'linear-gradient(135deg, #00f260 0%, #0575e6 100%)' },
        { id: 'abstract2', name: 'Aurora', gradient: 'linear-gradient(135deg, #4568dc 0%, #b06ab3 100%)' },
        { id: 'abstract3', name: 'Cosmic', gradient: 'linear-gradient(135deg, #ff0080 0%, #ff8c00 100%)' },
        { id: 'abstract4', name: 'Pastel Dream', gradient: 'linear-gradient(135deg, #a8ede0 0%, #fed6e3 100%)' },
        { id: 'abstract5', name: 'Pixel', gradient: 'linear-gradient(135deg, #83a4d4 0%, #b6fbff 100%)' }
    ];
    
    const importantColors = [
        { id: "primary", label: "Primary Color" },
        { id: "secondary", label: "Secondary Color" },
        { id: "background", label: "Background" },
        { id: "text", label: "Text Color" },
        { id: "cardBg", label: "Card Background" },
        { id: "lightGray", label: "Light Gray" }
    ];

    // ========== DOM ELEMENTS (partial) ==========
    const scannerSection = document.getElementById('scannerSection');
    const menuSection = document.getElementById('menuSection');
    const cartSection = document.getElementById('cartSection');
    const paymentSection = document.getElementById('paymentSection');
    const myOrdersSection = document.getElementById('myOrdersSection');
    const confirmationSection = document.getElementById('confirmationSection');
    const adminDashboardSection = document.getElementById('adminDashboardSection');
    const tableInfo = document.getElementById('tableInfo');
    const menuSubtitle = document.getElementById('menuSubtitle');
    const cartSubtitle = document.getElementById('cartSubtitle');
    const myOrdersSubtitle = document.getElementById('myOrdersSubtitle');
    const menuGrid = document.getElementById('menuGrid');
    const categoryTabs = document.getElementById('categoryTabs');
    const cartItems = document.getElementById('cartItems');
    const cartCount = document.getElementById('cartCount');
    const cartFloating = document.getElementById('cartFloating');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    const orderNumberDisplay = document.getElementById('orderNumberDisplay');
    const confirmationTable = document.getElementById('confirmationTable');
    const confirmationItems = document.getElementById('confirmationItems');
    const confirmationTotal = document.getElementById('confirmationTotal');
    const confirmationPaymentMethod = document.getElementById('confirmationPaymentMethod');
    const confirmationPaymentTime = document.getElementById('confirmationPaymentTime');
    const confirmationOrderStatus = document.getElementById('confirmationOrderStatus');
    const headerHelpButton = document.getElementById('headerHelpButton');
    const requestPayBtn = document.getElementById('requestPayBtn');
    const backToAdminBtn = document.getElementById('backToAdminBtn');
    const restaurantName = document.getElementById('restaurantName');
    const menuTitle = document.getElementById('menuTitle');
    const estimatedTime = document.getElementById('estimatedTime');
    const myOrdersButton = document.getElementById('myOrdersButton');
    const ordersList = document.getElementById('ordersList');
    const logoImage = document.getElementById('logoImage');
    const logoIcon = document.getElementById('logoIcon');
    const adminPanel = document.getElementById('adminPanel');
    const adminClose = document.getElementById('adminClose');
    const adminChangePrompt = document.getElementById('adminChangePrompt');
    const adminChangeCodeInput = document.getElementById('adminChangeCodeInput');
    const submitChangeCodeBtn = document.getElementById('submitChangeCodeBtn');
    const cancelChangeBtn = document.getElementById('cancelChangeBtn');
    const optionsModal = document.getElementById('optionsModal');
    const optionsModalContent = document.getElementById('optionsModalContent');
    const adminFloating = document.getElementById('adminFloating');
    const editOrderModal = document.getElementById('editOrderModal');
    const editOrderNumber = document.getElementById('editOrderNumber');
    const editOrderItemsList = document.getElementById('editOrderItemsList');
    const editOrderTotal = document.getElementById('editOrderTotal');
    const cancelEditOrderBtn = document.getElementById('cancelEditOrderBtn');
    const saveEditOrderBtn = document.getElementById('saveEditOrderBtn');

    // NEW login elements
    const adminLoginPrompt = document.getElementById('adminLoginPrompt');
    const adminEmail = document.getElementById('adminEmail');
    const adminPassword = document.getElementById('adminPassword');
    const submitAdminLoginBtn = document.getElementById('submitAdminLoginBtn');
    const cancelAdminLoginBtn = document.getElementById('cancelAdminLoginBtn');
    const loginError = document.getElementById('loginError');

    // Table settings modal
    const tableSettingsModal = document.getElementById('tableSettingsModal');
    const tableSettingsName = document.getElementById('tableSettingsName');
    const tableSettingHelp = document.getElementById('tableSettingHelp');
    const tableSettingPayRequest = document.getElementById('tableSettingPayRequest');
    const tableSettingCard = document.getElementById('tableSettingCard');
    const tableSettingCash = document.getElementById('tableSettingCash');
    const tableSettingPayNow = document.getElementById('tableSettingPayNow');
    const tableSettingPayLater = document.getElementById('tableSettingPayLater');
    const cancelTableSettingsBtn = document.getElementById('cancelTableSettingsBtn');
    const saveTableSettingsBtn = document.getElementById('saveTableSettingsBtn');
    let currentTableForSettings = null;

    // QR scanner elements
    const qrVideo = document.getElementById('qr-video');
    const qrCanvas = document.getElementById('qr-canvas');
    const startCameraBtn = document.getElementById('start-camera-btn');
    const stopCameraBtn = document.getElementById('stop-camera-btn');
    let scanning = false;
    let videoStream = null;

    // New PDF download button
    const downloadOrderPdfBtn = document.getElementById('downloadOrderPdfBtn');

    // ========== LANGUAGE HELPER FUNCTIONS (unchanged) ==========
    function getItemName(item) {
        if (state.currentLanguage === 'en' && item.nameEn && item.nameEn.trim() !== '') {
            return item.nameEn;
        }
        return item.name;
    }
    function getItemDescription(item) {
        if (state.currentLanguage === 'en' && item.descriptionEn && item.descriptionEn.trim() !== '') {
            return item.descriptionEn;
        }
        return item.description;
    }
    function getItemTags(item) {
        if (state.currentLanguage === 'en' && item.tagsEn && item.tagsEn.length > 0) {
            return item.tagsEn;
        }
        return item.tags;
    }
    function getOptionGroupName(group) {
        if (state.currentLanguage === 'en' && group.nameEn && group.nameEn.trim() !== '') {
            return group.nameEn;
        }
        return group.name;
    }
    function getChoiceName(choice) {
        if (state.currentLanguage === 'en' && choice.nameEn && choice.nameEn.trim() !== '') {
            return choice.nameEn;
        }
        return choice.name;
    }
    function getCategoryDisplayName(categoryId) {
        const cat = state.categories.find(c => c.id === categoryId);
        if (!cat) return categoryId;
        if (state.currentLanguage === 'en' && cat.displayNameEn) {
            return cat.displayNameEn;
        }
        return cat.displayName || categoryId;
    }

    // ========== TRANSLATION FUNCTION (unchanged) ==========
    function applyTranslations() {
        const lang = state.currentLanguage;
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.setAttribute('placeholder', translations[lang][key]);
                } else {
                    el.textContent = translations[lang][key];
                }
            }
        });
        if (state.currentTable && !state.isAdminMode) {
            menuSubtitle.textContent = state.cart.length === 0 
                ? (lang === 'el' ? `Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎµÎ¯Î´Î· Î³Î¹Î± Ï„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${state.currentTable}` : `Select items for your order for ${state.currentTable}`)
                : (lang === 'el' ? `Î£Ï…Î½ÎµÏ‡Î¯ÏƒÏ„Îµ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÏ„Îµ ÎµÎ¯Î´Î· ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${state.currentTable}` : `Continue adding items to your order for ${state.currentTable}`);
            cartSubtitle.textContent = lang === 'el' ? `Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${state.currentTable}` : `Your order for ${state.currentTable}`;
        }
        document.getElementById('langToggleText').textContent = lang === 'el' ? 'EN' : 'EL';
    }

    // ========== LANGUAGE TOGGLE (UPDATED TO TRANSLATE CATEGORIES) ==========
    function toggleLanguage() {
        // Remember the currently active category before changing language
        const activeCategory = document.querySelector('.category-tab.active')?.dataset?.category || 'all';
        
        // Toggle language
        state.currentLanguage = state.currentLanguage === 'el' ? 'en' : 'el';
        applyTranslations();
        
        // Rebuild the category tabs with the new language
        updateCategoryTabs();
        
        // Restore the previously active category tab if the menu section is visible
        if (document.querySelector('#menuSection.active-section')) {
            const tabToActivate = document.querySelector(`.category-tab[data-category="${activeCategory}"]`);
            if (tabToActivate) {
                // Remove active class from all tabs and set it on the correct one
                document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                tabToActivate.classList.add('active');
                displayMenuItems(activeCategory);
            } else {
                // Fallback to "all" if the category no longer exists
                document.querySelector('.category-tab[data-category="all"]')?.classList.add('active');
                displayMenuItems('all');
            }
        }
        
        showNotification(`Language switched to ${state.currentLanguage === 'el' ? 'Greek' : 'English'}`);
    }

    // ========== FIRESTORE SAVE / LOAD (now using helpers) ==========
    // (already defined above)

    // ========== INITIAL LOAD (unchanged, but uses helpers and now loads adminChangeCode) ==========
    async function loadInitialData() {
        try {
            const [restDoc, menuSnap, ordersSnap, catDoc, customDoc, soundDoc, helpSnap, statsDoc, tablesSnap, printersSnap] = await Promise.all([
                getSettingsDoc().get(),
                getMenuItemsCollection().get(),
                getOrdersCollection().get(),
                getCategoriesDoc().get(),
                getCustomizationDoc().get(),
                getSoundEffectsDoc().get(),
                getHelpRequestsCollection().get(),
                getCumulativeStatsDoc().get(),
                getTablesCollection().get(),
                getPrintersCollection().get()
            ]);
            if (restDoc.exists) {
                state.restaurantInfo = restDoc.data();
                // Load adminChangeCode from restaurantInfo or fallback to decoded default
                state.adminChangeCode = state.restaurantInfo.adminChangeCode || decodeCode("lele");
            } else {
                state.restaurantInfo.adminChangeCode = decodeCode("lele");
                state.adminChangeCode = decodeCode("lele");
                await getSettingsDoc().set(state.restaurantInfo);
            }
            
            if (menuSnap.empty) {
                state.menuItems = JSON.parse(JSON.stringify(defaultMenuItems));
                await Promise.all(state.menuItems.map(i => saveMenuItem(i)));
            } else {
                state.menuItems = menuSnap.docs.map(doc => {
                    const d = doc.data();
                    if (!d.nameEn) d.nameEn = '';
                    if (!d.descriptionEn) d.descriptionEn = '';
                    if (!d.tagsEn) d.tagsEn = [];
                    if (d.options) {
                        d.options.forEach(grp => {
                            if (!grp.nameEn) grp.nameEn = '';
                            if (grp.choices) {
                                grp.choices.forEach(ch => {
                                    if (!ch.nameEn) ch.nameEn = '';
                                });
                            }
                        });
                    }
                    d.displayOrder = d.displayOrder ?? Number(doc.id) ?? 999;
                    return { id: Number(doc.id), ...d, options: d.options || [] };
                }).sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            }
            
            state.orders = ordersSnap.docs.map(doc => ({ ...doc.data(), orderNumber: doc.id }));
            
            if (catDoc.exists) {
                state.categories = catDoc.data().list || [];
                state.categories.forEach(c => { if (!c.displayNameEn) c.displayNameEn = c.displayName || c.name; });
                state.categories.forEach((c,i)=> { if (c.displayOrder===undefined) c.displayOrder=i; });
                state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            } else {
                state.categories = JSON.parse(JSON.stringify(defaultCategories));
                await getCategoriesDoc().set({ list: state.categories });
            }
            
            if (customDoc.exists) {
                state.customization = customDoc.data();
                // Ensure new properties exist
                if (state.customization.backgroundGradient === undefined) state.customization.backgroundGradient = null;
                if (state.customization.backgroundBlur === undefined) state.customization.backgroundBlur = 0;
            } else {
                await getCustomizationDoc().set(state.customization);
            }
            
            if (soundDoc.exists) {
                state.soundEffects = soundDoc.data();
                if (state.soundEffects.newOrderSound === undefined) state.soundEffects.newOrderSound = null;
            } else {
                await getSoundEffectsDoc().set(state.soundEffects);
            }
            
            if (statsDoc.exists) state.cumulativeStats = statsDoc.data();
            else await getCumulativeStatsDoc().set(state.cumulativeStats);
            
            state.helpRequests = helpSnap.docs.map(doc => {
                const req = { id: doc.id, ...doc.data() };
                if (!req.requestType) req.requestType = 'help';
                state.seenHelpRequests.add(req.id);
                return req;
            });

            // Load tables â€“ now objects with name and settings
            if (tablesSnap.empty) {
                // default tables
                state.tables = [
                    { name: 'Table 1', settings: { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true } },
                    { name: 'Table 2', settings: { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true } },
                    { name: 'Table 3', settings: { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true } },
                    { name: 'VIP Table', settings: { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true } }
                ];
                await Promise.all(state.tables.map(t => saveTable(t)));
            } else {
                // Migrate old string tables to objects
                state.tables = tablesSnap.docs.map(doc => {
                    const data = doc.data();
                    if (typeof data === 'string') {
                        // old format
                        return { name: data, settings: { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true } };
                    } else {
                        // already object
                        return { name: doc.id, ...data };
                    }
                });
            }

            // NEW: Load printers
            if (!printersSnap.empty) {
                state.printers = printersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } else {
                state.printers = [];
            }
            
            determineCurrentTheme();
            determineCurrentFont();
            applyCustomization();
            updateRestaurantUI();
            updateCategoryTabs();
            displayMenuItems('all');
            applyTranslations();
            updatePendingBadges();
            populateTableFilter();
            populateTableFilterModal();
        } catch (e) { console.error("loadInitialData", e); }
    }

    // ========== PLAY SOUND UTILITY (unchanged) ==========
    function playSound(dataUrl) {
        if (!state.soundEffects.enabled || !dataUrl) return;
        try {
            const audio = new Audio(dataUrl);
            audio.volume = 0.6;
            audio.play().catch(e => console.log('Audio play failed:', e));
        } catch(e) { console.error('Sound error:', e); }
    }

    // ========== UPDATE PENDING BADGES (unchanged) ==========
    function updatePendingBadges() {
        const hasPendingOrders = state.orders.some(o => o.status === 'pending');
        const hasPendingHelp = state.helpRequests.some(r => r.status === 'pending');
        
        const orderBadge = document.getElementById('orderPendingBadge');
        const helpBadge = document.getElementById('helpPendingBadge');
        const orderBadgeModal = document.getElementById('orderPendingBadgeModal');
        const helpBadgeModal = document.getElementById('helpPendingBadgeModal');
        
        if (orderBadge) orderBadge.style.display = hasPendingOrders ? 'inline' : 'none';
        if (helpBadge) helpBadge.style.display = hasPendingHelp ? 'inline' : 'none';
        if (orderBadgeModal) orderBadgeModal.style.display = hasPendingOrders ? 'inline' : 'none';
        if (helpBadgeModal) helpBadgeModal.style.display = hasPendingHelp ? 'inline' : 'none';
    }

    // ========== POPULATE TABLE FILTER DROPDOWNS (unchanged) ==========
    function populateTableFilter() {
        const tableFilter = document.getElementById('orderTableFilter');
        if (!tableFilter) return;
        const tables = [...new Set(state.orders.filter(o => o.table && o.table.toLowerCase() !== 'admin').map(o => o.table))].sort();
        tableFilter.innerHTML = '<option value="all">All Tables</option>';
        tables.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            tableFilter.appendChild(opt);
        });
    }

    function populateTableFilterModal() {
        const tableFilter = document.getElementById('orderTableFilterModal');
        if (!tableFilter) return;
        const tables = [...new Set(state.orders.filter(o => o.table && o.table.toLowerCase() !== 'admin').map(o => o.table))].sort();
        tableFilter.innerHTML = '<option value="all">All Tables</option>';
        tables.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            tableFilter.appendChild(opt);
        });
    }

    // ========== REALâ€‘TIME LISTENERS (unchanged, but use helpers) ==========
    function setupListeners() {
        getOrdersCollection().onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === 'added' && state.isAdminMode) {
                    playSound(state.soundEffects.newOrderSound);
                }
            });
            state.orders = snap.docs.map(d => ({ ...d.data(), orderNumber: d.id }));
            updatePendingBadges();
            populateTableFilter();
            populateTableFilterModal();
            if (!state.isAdminMode && document.querySelector('#myOrdersSection.active-section')) loadMyOrders();
            if (state.isAdminMode && document.querySelector('#adminDashboardSection.active-section')) {
                loadOrdersForAdmin();
                populateTableSelect('tableSelectForDelete');
                if (adminPanel.style.display === 'flex') populateTableSelect('tableSelectForDeleteModal');
            }
            updateRequestPayButton();
        });
        getMenuItemsCollection().onSnapshot(snap => {
            const incoming = snap.docs.map(doc => {
                const d = doc.data();
                if (!d.nameEn) d.nameEn = '';
                if (!d.descriptionEn) d.descriptionEn = '';
                if (!d.tagsEn) d.tagsEn = [];
                if (d.options) {
                    d.options.forEach(grp => {
                        if (!grp.nameEn) grp.nameEn = '';
                        if (grp.choices) {
                            grp.choices.forEach(ch => {
                                if (!ch.nameEn) ch.nameEn = '';
                            });
                        }
                    });
                }
                d.displayOrder = d.displayOrder ?? Number(doc.id) ?? 999;
                return { id: Number(doc.id), ...d, options: d.options || [] };
            }).sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            state.menuItems = incoming;
            if (!state.isAdminMode && document.querySelector('#menuSection.active-section')) {
                const activeCat = document.querySelector('.category-tab.active')?.dataset?.category || 'all';
                displayMenuItems(activeCat);
            }
            if (state.isAdminMode && document.querySelector('#adminDashboardSection.active-section')) {
                const activeTab = document.querySelector('#adminDashboardSection .admin-tab.active')?.dataset?.tab;
                if (activeTab === 'menu') loadMenuItemsForAdmin();
                if (activeTab === 'menuEn') loadMenuItemsForAdminEn();
            }
            if (adminPanel.style.display === 'flex') {
                loadMenuItemsForAdminModal();
                loadMenuItemsForAdminModalEn();
            }
        });
        getCategoriesDoc().onSnapshot(doc => {
            if (doc.exists) {
                const catData = doc.data();
                state.categories = catData.list || [];
                state.categories.forEach(c => { if (!c.displayNameEn) c.displayNameEn = c.displayName || c.name; });
                state.categories.forEach((c,i)=> { if (c.displayOrder===undefined) c.displayOrder=i; });
                state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            }
            updateCategoryTabs();
            ['editItemCategory','editItemCategoryEn','editItemCategoryModal'].forEach(id => {
                const sel = document.getElementById(id);
                if (sel) {
                    const cur = sel.value;
                    sel.innerHTML = '';
                    state.categories.forEach(cat => {
                        const opt = document.createElement('option');
                        opt.value = cat.id; opt.textContent = cat.displayName; // Greek in dropdown
                        sel.appendChild(opt);
                    });
                    if (cur && state.categories.some(c=>c.id===cur)) sel.value = cur;
                }
            });
            if (state.isAdminMode && document.querySelector('#adminDashboardSection.active-section')) {
                const activeTab = document.querySelector('#adminDashboardSection .admin-tab.active')?.dataset?.tab;
                if (activeTab === 'categories') loadCategoriesForAdmin();
                if (activeTab === 'categoriesEn') loadCategoriesForAdminEn();
            }
            if (adminPanel.style.display === 'flex') {
                loadCategoriesForAdminModal();
                loadCategoriesForAdminModalEn();
            }
        });
        getHelpRequestsCollection().onSnapshot(snap => {
            snap.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const req = { id: change.doc.id, ...change.doc.data() };
                    if (req.status === 'pending' && !state.seenHelpRequests.has(req.id) && state.isAdminMode) {
                        playSound(state.soundEffects.helpRequestSound);
                    }
                    state.seenHelpRequests.add(req.id);
                }
            });
            state.helpRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            updatePendingBadges();
            if (state.isAdminMode) {
                if (document.querySelector('#adminDashboardSection.active-section')) {
                    const activeTab = document.querySelector('#adminDashboardSection .admin-tab.active')?.dataset?.tab;
                    if (activeTab === 'helpRequests') loadHelpRequestsForAdmin();
                }
                if (adminPanel.style.display === 'flex') {
                    const modalActive = document.querySelector('#adminPanel .admin-tab.active')?.dataset?.tab;
                    if (modalActive === 'helpRequests') loadHelpRequestsForAdminModal();
                }
            }
        });
        getCumulativeStatsDoc().onSnapshot(doc => {
            if (doc.exists) state.cumulativeStats = doc.data();
        });
        getTablesCollection().onSnapshot(snap => {
            // Update tables array
            state.tables = snap.docs.map(doc => {
                const data = doc.data();
                // ensure it's an object
                if (typeof data === 'string') {
                    return { name: data, settings: { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true } };
                } else {
                    return { name: doc.id, ...data };
                }
            });
            if (state.isAdminMode && document.querySelector('#adminDashboardSection.active-section')) {
                const activeTab = document.querySelector('#adminDashboardSection .admin-tab.active')?.dataset?.tab;
                if (activeTab === 'tables') loadTablesForAdmin();
            }
            if (adminPanel.style.display === 'flex') {
                const modalActive = document.querySelector('#adminPanel .admin-tab.active')?.dataset?.tab;
                if (modalActive === 'tablesModal') loadTablesForAdminModal();
            }
        });
        // NEW: Printer listener
        getPrintersCollection().onSnapshot(snap => {
            state.printers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (state.isAdminMode && document.querySelector('#adminDashboardSection.active-section')) {
                const activeTab = document.querySelector('#adminDashboardSection .admin-tab.active')?.dataset?.tab;
                if (activeTab === 'printer') loadPrintersForAdmin();
            }
            if (adminPanel.style.display === 'flex') {
                const modalActive = document.querySelector('#adminPanel .admin-tab.active')?.dataset?.tab;
                if (modalActive === 'printerModal') loadPrintersForAdminModal();
            }
        });
    }

    // ========== UI HELPERS (unchanged) ==========
    function determineCurrentTheme() {
        for (const [id, t] of Object.entries(themes)) {
            if (state.customization.primary === t.primary && state.customization.secondary === t.secondary && state.customization.background === t.background) {
                state.currentTheme = id; return;
            }
        }
        state.currentTheme = "custom";
    }
    function determineCurrentFont() {
        for (const [id, f] of Object.entries(fonts)) {
            if (state.customization.fontPrimary === f.primary) { state.currentFont = id; return; }
        }
        state.currentFont = "poppins";
    }
    function applyCustomization() {
        const root = document.documentElement;
        Object.keys(state.customization).forEach(k => {
            if (k === 'fontPrimary' || k === 'fontSecondary') root.style.setProperty(`--${k}`, state.customization[k]);
            else root.style.setProperty(`--${k}`, state.customization[k]);
        });
        
        // Background gradient & blur
        let styleEl = document.getElementById('dynamic-bg-style');
        if (!styleEl) {
            styleEl = document.createElement('style');
            styleEl.id = 'dynamic-bg-style';
            document.head.appendChild(styleEl);
        }
        const gradient = state.customization.backgroundGradient;
        const blur = state.customization.backgroundBlur || 0;
        if (gradient) {
            styleEl.textContent = `
                body::before {
                    content: '';
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: ${gradient};
                    filter: blur(${blur}px);
                    pointer-events: none;
                    z-index: -1;
                }
                body {
                    background: transparent;
                }
            `;
        } else {
            styleEl.textContent = `
                body::before {
                    content: '';
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: var(--background);
                    filter: blur(${blur}px);
                    pointer-events: none;
                    z-index: -1;
                }
            `;
        }
        
        const previewName = document.getElementById('previewRestaurantName');
        if (previewName) { previewName.style.color = state.customization.primary; previewName.style.fontFamily = state.customization.fontSecondary; }
    }
    function updateRestaurantUI() {
        restaurantName.textContent = state.restaurantInfo.name;
        menuTitle.textContent = state.restaurantInfo.name + " Menu";
        estimatedTime.textContent = state.restaurantInfo.estimatedPrepTime;
        if (state.restaurantInfo.logoImage) { logoImage.src = state.restaurantInfo.logoImage; logoImage.style.display = 'block'; logoIcon.style.display = 'none'; }
        else { logoImage.style.display = 'none'; logoIcon.style.display = 'block'; }
    }
    function updateCategoryTabs() {
        if (!categoryTabs) return;
        categoryTabs.innerHTML = '';
        const sorted = [...state.categories].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
        const all = document.createElement('button');
        all.className = 'category-tab active'; all.setAttribute('data-category', 'all'); all.textContent = 'ÎŒÎ»Î±';
        all.addEventListener('click', function() { document.querySelectorAll('.category-tab').forEach(t=>t.classList.remove('active')); this.classList.add('active'); displayMenuItems('all'); });
        categoryTabs.appendChild(all);
        sorted.forEach(cat => {
            const tab = document.createElement('button');
            tab.className = 'category-tab'; tab.setAttribute('data-category', cat.id); tab.textContent = getCategoryDisplayName(cat.id); // use language-aware display
            tab.addEventListener('click', function() { document.querySelectorAll('.category-tab').forEach(t=>t.classList.remove('active')); this.classList.add('active'); displayMenuItems(cat.id); });
            categoryTabs.appendChild(tab);
        });
    }
    function displayMenuItems(category) {
        if (!menuGrid) return;
        menuGrid.innerHTML = '';
        const filtered = category === 'all' ? [...state.menuItems].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)) : state.menuItems.filter(i=>i.category===category).sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
        if (filtered.length === 0) { 
            menuGrid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--gray);"><i class="fas fa-utensils" style="font-size:50px; margin-bottom:15px; opacity:0.5;"></i><p>${state.currentLanguage === 'el' ? 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎ¯Î´Î· ÏƒÎµ Î±Ï…Ï„Î® Ï„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î±ÎºÏŒÎ¼Î±.' : 'No items in this category yet.'}</p></div>`; 
            return; 
        }
        filtered.forEach(item => {
            const el = document.createElement('div'); el.className = 'menu-item';  // cursor:pointer added in CSS
            const imgStyle = item.image ? `background-image: url('${item.image}')` : 'background-color: var(--light-gray)';
            let optInd = '';
            if (item.options && item.options.length) optInd = `<div class="item-options-indicator"><i class="fas fa-sliders-h"></i> ${state.currentLanguage === 'el' ? 'ÎœÎµ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚' : 'With options'}</div>`;
            const itemName = getItemName(item);
            const itemDesc = getItemDescription(item);
            const itemTags = getItemTags(item);
            el.innerHTML = `<div class="item-image" style="${imgStyle}"></div><div class="item-content"><div class="item-header"><div class="item-name">${itemName}</div><div class="item-price">$${item.price.toFixed(2)}</div></div><div class="item-description">${itemDesc}</div>${optInd}<div class="item-footer"><div class="item-tags">${itemTags.map(t=>`<span class="item-tag">${t}</span>`).join('')}</div><button class="add-to-cart" data-id="${item.id}"><i class="fas fa-plus"></i></button></div></div>`;
            el.addEventListener('click', function(e) {
                if (e.target.closest('.add-to-cart')) return;
                addToCart(item.id);
            });
            const btn = el.querySelector('.add-to-cart');
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                addToCart(item.id);
            });
            menuGrid.appendChild(el);
        });
    }

    // ========== CART FUNCTIONS (unchanged, with added animation) ==========
    function addToCart(itemId) {
        if (state.isAdminMode && (!state.currentTable || state.currentTable === "Admin")) return;
        const item = state.menuItems.find(i=>i.id===itemId);
        if (!item) return;
        if (item.options && item.options.length) openOptionsModal(item);
        else addToCartWithOptions(itemId, []);
    }
    function addToCartWithOptions(itemId, selectedOptions = []) {
        if (state.isAdminMode && (!state.currentTable || state.currentTable === "Admin")) return;
        const menuItem = state.menuItems.find(i=>i.id===itemId);
        if (!menuItem) return;
        const itemPrice = menuItem.price + selectedOptions.reduce((sum,o)=>sum+(o.price||0),0);
        const cartItem = {
            id: menuItem.id,
            name: getItemName(menuItem),
            basePrice: menuItem.price,
            price: itemPrice,
            quantity: 1,
            selectedOptions: selectedOptions.map(o=>({
                groupName: o.groupName,
                choiceName: o.choiceName,
                price: o.price||0,
                isComment: o.isComment||false
            }))
        };
        const idx = state.cart.findIndex(i=> i.id===cartItem.id && JSON.stringify(i.selectedOptions.filter(x=>!x.isComment)) === JSON.stringify(cartItem.selectedOptions.filter(x=>!x.isComment)));
        if (idx !== -1) {
            const sameComments = JSON.stringify(state.cart[idx].selectedOptions.filter(x=>x.isComment)) === JSON.stringify(cartItem.selectedOptions.filter(x=>x.isComment));
            if (sameComments) state.cart[idx].quantity += 1;
            else state.cart.push(cartItem);
        } else state.cart.push(cartItem);
        updateCart();
        animateCart(); // <-- ADD ANIMATION HERE
        showNotification(state.currentLanguage === 'el' ? `Î¤Î¿ ${getItemName(menuItem)} Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ ÎºÎ±Î»Î¬Î¸Î¹` : `${getItemName(menuItem)} added to cart`);
        playSound(state.soundEffects.addToCartSound);
    }

    // ========== CART ANIMATION FUNCTION ==========
    function animateCart() {
        const cartEl = document.getElementById('cartFloating');
        if (!cartEl) return;
        const rect = cartEl.getBoundingClientRect();
        const anim = document.createElement('div');
        anim.className = 'cart-animation';
        anim.textContent = '+1';
        anim.style.left = (rect.left + rect.width/2 - 20) + 'px';
        anim.style.top = (rect.top + rect.height/2 - 20) + 'px';
        document.body.appendChild(anim);
        setTimeout(() => {
            anim.remove();
        }, 800);
    }

    function openOptionsModal(item) {
        let html = `<h3 class="options-modal-title">${getItemName(item)}</h3><div class="options-modal-price">$${item.price.toFixed(2)}</div><div class="item-description" style="margin-bottom:20px;">${getItemDescription(item)}</div>`;
        item.options.forEach((g, gi) => {
            if (g.type === 'text') {
                // Add maxlength="150" to the comment textarea
                html += `<div class="option-group"><div class="option-group-title"><i class="fas fa-comment"></i> ${getOptionGroupName(g)}</div><div class="comment-field"><textarea class="admin-textarea" maxlength="150" placeholder="${state.currentLanguage === 'el' ? 'Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿ ÏƒÏ‡ÏŒÎ»Î¹ÏŒ ÏƒÎ±Ï‚ ÎµÎ´Ï...' : 'Enter your comment here...'}" id="comment_${g.id||gi}"></textarea></div></div>`;
            } else {
                html += `<div class="option-group"><div class="option-group-title"><i class="fas fa-tag"></i> ${getOptionGroupName(g)} ${g.type==='radio'?`<span style="font-size:12px; color:var(--gray);">(${state.currentLanguage === 'el' ? 'ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î­Î½Î±' : 'choose one'})</span>`:`<span style="font-size:12px; color:var(--gray);">(${state.currentLanguage === 'el' ? 'ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ' : 'choose any'})</span>`}</div><div class="${g.type==='radio'?'option-group-radio':'option-group-checkbox'}">`;
                g.choices.forEach((c, ci) => {
                    let priceText = ''; let priceClass = '';
                    if (c.price>0) { priceText = `+$${c.price.toFixed(2)}`; priceClass = 'choice-price-positive'; }
                    else if (c.price<0) { priceText = `-$${Math.abs(c.price).toFixed(2)}`; priceClass = 'choice-price-negative'; }
                    const choiceName = getChoiceName(c);
                    if (g.type==='radio') html += `<div class="choice-item"><label class="choice-label"><input type="radio" name="group_${g.id||gi}" value="${c.name}" data-price="${c.price}" data-group-name="${g.name}" data-choice-name="${choiceName}"> <span class="choice-name">${choiceName}</span></label><span class="choice-price ${priceClass}">${priceText}</span></div>`;
                    else html += `<div class="choice-item"><label class="choice-label"><input type="checkbox" name="group_${g.id||gi}" value="${c.name}" data-price="${c.price}" data-group-name="${g.name}" data-choice-name="${choiceName}"> <span class="choice-name">${choiceName}</span></label><span class="choice-price ${priceClass}">${priceText}</span></div>`;
                });
                html += `</div></div>`;
            }
        });
        html += `<div class="options-total"><span>${state.currentLanguage === 'el' ? 'Î£ÏÎ½Î¿Î»Î¿:' : 'Total:'}</span><span class="options-total-amount" id="optionsTotalAmount">$${item.price.toFixed(2)}</span></div><div class="options-modal-actions"><button class="btn btn-secondary" id="cancelOptionsBtn"><i class="fas fa-times"></i> ${state.currentLanguage === 'el' ? 'Î‘ÎºÏÏÏ‰ÏƒÎ·' : 'Cancel'}</button><button class="btn btn-primary" id="confirmOptionsBtn"><i class="fas fa-check"></i> ${state.currentLanguage === 'el' ? 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¿ ÎšÎ±Î»Î¬Î¸Î¹' : 'Add to Cart'}</button></div>`;
        optionsModalContent.innerHTML = html;
        optionsModal.style.display = 'flex';
        const inputs = optionsModal.querySelectorAll('input[type="radio"], input[type="checkbox"]');
        const updateTotal = () => {
            let extra = 0;
            inputs.forEach(i => { if ((i.type==='radio'||i.type==='checkbox') && i.checked) extra += parseFloat(i.dataset.price||0); });
            document.getElementById('optionsTotalAmount').textContent = `$${(item.price + extra).toFixed(2)}`;
        };
        inputs.forEach(i => i.addEventListener('change', updateTotal));
        document.getElementById('cancelOptionsBtn').addEventListener('click', ()=> { optionsModal.style.display = 'none'; });
        document.getElementById('confirmOptionsBtn').addEventListener('click', ()=> {
            let selected = [];
            inputs.forEach(i => { if (i.checked) selected.push({ groupName: i.dataset.groupName, choiceName: i.dataset.choiceName, price: parseFloat(i.dataset.price||0), isComment: false }); });
            item.options.forEach((g,gi) => {
                if (g.type === 'text') {
                    const cf = document.getElementById(`comment_${g.id||gi}`);
                    if (cf && cf.value.trim() !== '') selected.push({ groupName: g.name, choiceName: cf.value.trim(), price: 0, isComment: true });
                }
            });
            addToCartWithOptions(item.id, selected);
            optionsModal.style.display = 'none';
        });
    }
    function updateCart() {
        if (state.isAdminMode && (!state.currentTable || state.currentTable === "Admin")) {
            cartFloating.style.display = 'none';
            return;
        } else {
            cartFloating.style.display = 'flex';
        }
        const totalItems = state.cart.reduce((s,i)=>s+i.quantity,0);
        cartCount.textContent = totalItems;
        if (state.cart.length === 0) cartItems.innerHTML = `<div class="empty-cart" style="text-align: center; padding: 40px; color: var(--gray);"><i class="fas fa-shopping-cart" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i><p>${state.currentLanguage === 'el' ? 'Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÏƒÎ±Ï‚ ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿' : 'Your cart is empty'}</p></div>`;
        else {
            cartItems.innerHTML = '';
            state.cart.forEach(item => {
                const el = document.createElement('div'); el.className = 'cart-item';
                let optHtml = '';
                if (item.selectedOptions && item.selectedOptions.length) {
                    optHtml = '<div style="font-size:12px; color:var(--gray); margin-top:5px;">';
                    item.selectedOptions.forEach(o => {
                        if (o.isComment) optHtml += `<div><i class="fas fa-comment"></i> ${o.groupName}: "${o.choiceName}"</div>`;
                        else optHtml += `<div>â€¢ ${o.groupName}: ${o.choiceName} ${o.price>0 ? `+$${o.price.toFixed(2)}` : o.price<0 ? `-$${Math.abs(o.price).toFixed(2)}` : ''}</div>`;
                    });
                    optHtml += '</div>';
                }
                el.innerHTML = `<div class="cart-item-info"><div class="cart-item-name">${item.name}</div>${optHtml}<div class="cart-item-price">$${item.price.toFixed(2)}</div></div><div class="cart-item-controls"><div class="quantity-control"><button class="quantity-btn decrease" data-id="${item.id}" data-options='${JSON.stringify(item.selectedOptions)}'><i class="fas fa-minus"></i></button><span class="quantity">${item.quantity}</span><button class="quantity-btn increase" data-id="${item.id}" data-options='${JSON.stringify(item.selectedOptions)}'><i class="fas fa-plus"></i></button></div><div class="remove-item" data-id="${item.id}" data-options='${JSON.stringify(item.selectedOptions)}'><i class="fas fa-trash"></i></div></div>`;
                cartItems.appendChild(el);
            });
            document.querySelectorAll('.decrease').forEach(b => b.addEventListener('click', function() { updateCartItemQuantity(parseInt(this.dataset.id), JSON.parse(this.dataset.options||'[]'), -1); }));
            document.querySelectorAll('.increase').forEach(b => b.addEventListener('click', function() { updateCartItemQuantity(parseInt(this.dataset.id), JSON.parse(this.dataset.options||'[]'), 1); }));
            document.querySelectorAll('.remove-item').forEach(b => b.addEventListener('click', function() { removeFromCart(parseInt(this.dataset.id), JSON.parse(this.dataset.options||'[]')); }));
        }
        updateCartSummary();
    }
    function updateCartItemQuantity(id, opts, delta) {
        const idx = state.cart.findIndex(i => i.id===id && JSON.stringify(i.selectedOptions)===JSON.stringify(opts));
        if (idx !== -1) {
            state.cart[idx].quantity += delta;
            if (state.cart[idx].quantity <= 0) state.cart.splice(idx,1);
            updateCart();
        }
    }
    function removeFromCart(id, opts) {
        const idx = state.cart.findIndex(i => i.id===id && JSON.stringify(i.selectedOptions)===JSON.stringify(opts));
        if (idx !== -1) { const item = state.cart[idx]; state.cart.splice(idx,1); updateCart(); showNotification(state.currentLanguage === 'el' ? `Î¤Î¿ ${item.name} Î±Ï†Î±Î¹ÏÎ­Î¸Î·ÎºÎµ Î±Ï€ÏŒ Ï„Î¿ ÎºÎ±Î»Î¬Î¸Î¹` : `${item.name} removed from cart`); }
    }
    function calculateSubtotal() { return state.cart.reduce((s,i)=>s + i.price * i.quantity, 0); }
    function calculateTotal() { return calculateSubtotal(); }
    function updateCartSummary() {
        const sub = calculateSubtotal(); const tot = calculateTotal();
        document.getElementById('subtotal').textContent = `$${sub.toFixed(2)}`;
        document.getElementById('total').textContent = `$${tot.toFixed(2)}`;
    }
    function updatePaymentSummary() {
        const sub = calculateSubtotal(); const tot = calculateTotal();
        document.getElementById('paymentSubtotal').textContent = `$${sub.toFixed(2)}`;
        document.getElementById('paymentTotal').textContent = `$${tot.toFixed(2)}`;
    }
    function generateOrderNumber() { return `ORD-${Math.floor(1000+Math.random()*9000)}`; }
    function showOrderConfirmation(order) {
        orderNumberDisplay.textContent = order.orderNumber;
        confirmationTable.textContent = `${state.currentLanguage === 'el' ? 'Î¤ÏÎ±Ï€Î­Î¶Î¹:' : 'Table:'} ${order.table}`;
        confirmationItems.innerHTML = '';
        order.items.forEach(i => {
            let opt = '';
            if (i.selectedOptions && i.selectedOptions.length) {
                opt = '<div style="font-size:12px; color:var(--gray);">' + i.selectedOptions.map(o => o.isComment ? `${o.groupName}: "${o.choiceName}"` : `${o.groupName}: ${o.choiceName}`).join(', ') + '</div>';
            }
            confirmationItems.innerHTML += `<div class="order-item"><div class="order-item-name"><div class="order-item-quantity">${i.quantity}</div><div>${i.name}${opt}</div></div><div class="order-item-price">$${(i.price*i.quantity).toFixed(2)}</div></div>`;
        });
        confirmationTotal.textContent = `$${order.total.toFixed(2)}`;
        confirmationPaymentMethod.textContent = order.paymentMethod === 'card' ? (state.currentLanguage === 'el' ? 'Î Î¹ÏƒÏ„Ï‰Ï„Î¹ÎºÎ®/Î§ÏÎµÏ‰ÏƒÏ„Î¹ÎºÎ® ÎšÎ¬ÏÏ„Î±' : 'Credit/Debit Card') : (state.currentLanguage === 'el' ? 'ÎœÎµÏ„ÏÎ·Ï„Î¬' : 'Cash');
        confirmationPaymentTime.textContent = order.paymentTime === 'now' ? (state.currentLanguage === 'el' ? 'Î Î»Î·ÏÏ‰Î¼Î® Î¤ÏÏÎ±' : 'Pay Now') : (state.currentLanguage === 'el' ? 'Î Î»Î·ÏÏ‰Î¼Î® Î‘ÏÎ³ÏŒÏ„ÎµÏÎ±' : 'Pay Later');
        confirmationOrderStatus.textContent = order.status === 'pending' ? (state.currentLanguage === 'el' ? 'Î•ÎºÎºÏÎµÎ¼ÎµÎ¯' : 'Pending') : (order.status.charAt(0).toUpperCase() + order.status.slice(1));
    }
    function resetCart() { state.cart = []; updateCart(); }
    function resetOrder() {
        state.cart = []; state.selectedPaymentMethod = null; state.selectedPaymentTime = null; state.currentOrderNumber = null; state.currentTable = null;
        updateCart(); document.querySelectorAll('.option-card').forEach(c=>c.classList.remove('selected'));
        tableInfo.innerHTML = `<i class="fas fa-qrcode"></i> ${state.currentLanguage === 'el' ? 'Î£Î±ÏÏÏƒÏ„Îµ QR Î³Î¹Î± Î­Î½Î±ÏÎ¾Î·' : 'Scan QR to start'}`;
        menuSubtitle.textContent = state.currentLanguage === 'el' ? 'Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎµÎ¯Î´Î· Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚' : 'Select items to add to your order';
        myOrdersButton.style.display = 'none';
        adminFloating.style.display = 'none';
    }
    function showNotification(msg) { notificationText.textContent = msg; notification.classList.add('show'); setTimeout(()=>notification.classList.remove('show'),3000); }
    function showSection(id) {
        document.querySelectorAll('.app-section, .admin-dashboard-section').forEach(s=>{ s.classList.remove('active-section'); s.style.display='none'; });
        const sec = document.getElementById(id);
        if (sec) { sec.style.display = 'block'; setTimeout(()=>sec.classList.add('active-section'),10); }
        if (id==='cartSection' && state.currentTable && !state.isAdminMode) cartSubtitle.textContent = state.currentLanguage === 'el' ? `Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${state.currentTable}` : `Your order for ${state.currentTable}`;
        if (id==='menuSection' && state.currentTable && !state.isAdminMode) menuSubtitle.textContent = state.cart.length===0 ? (state.currentLanguage === 'el' ? `Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎµÎ¯Î´Î· Î³Î¹Î± Ï„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${state.currentTable}` : `Select items for your order for ${state.currentTable}`) : (state.currentLanguage === 'el' ? `Î£Ï…Î½ÎµÏ‡Î¯ÏƒÏ„Îµ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÏ„Îµ ÎµÎ¯Î´Î· ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${state.currentTable}` : `Continue adding items to your order for ${state.currentTable}`);
        if (id==='myOrdersSection' && state.currentTable && !state.isAdminMode) loadMyOrders();
        if (state.isAdminMode && state.currentTable && state.currentTable !== "Admin") {
            cartFloating.style.display = 'flex';
        } else if (!state.isAdminMode && id !== 'scannerSection') {
            cartFloating.style.display = 'flex';
        } else {
            cartFloating.style.display = 'none';
        }
        updateRequestPayButton();
    }
    function loadMyOrders() {
        if (!state.currentTable || state.isAdminMode) { 
            ordersList.innerHTML = `<div class="no-orders-message"><i class="fas fa-clipboard-list"></i><h3>${state.currentLanguage === 'el' ? 'Î”ÎµÎ½ ÎµÏ€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ Ï„ÏÎ±Ï€Î­Î¶Î¹' : 'No table selected'}</h3><p>${state.currentLanguage === 'el' ? 'Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏÏÏ„Î± Î­Î½Î± Ï„ÏÎ±Ï€Î­Î¶Î¹ Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î¹Ï‚ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚ ÏƒÎ±Ï‚.' : 'Please select a table first to view your orders.'}</p></div>`; 
            return; 
        }
        const tableOrders = state.orders.filter(o=>o.table===state.currentTable);
        if (tableOrders.length===0) { 
            ordersList.innerHTML = `<div class="no-orders-message"><i class="fas fa-clipboard-list"></i><h3>${state.currentLanguage === 'el' ? 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚ Î±ÎºÏŒÎ¼Î±' : 'No orders yet'}</h3><p>${state.currentLanguage === 'el' ? 'Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÎºÎ¬Î½ÎµÎ¹ Î±ÎºÏŒÎ¼Î· ÎºÎ±Î¼Î¯Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±. ÎÎµÎºÎ¹Î½Î®ÏƒÏ„Îµ ÎµÏ€Î¹Î»Î­Î³Î¿Î½Ï„Î±Ï‚ ÎµÎ¯Î´Î· Î±Ï€ÏŒ Ï„Î¿ Î¼ÎµÎ½Î¿Ï.' : 'You haven\'t placed any orders yet. Start by selecting items from the menu.'}</p></div>`; 
            return; 
        }
        tableOrders.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
        ordersList.innerHTML = '';
        tableOrders.forEach(o => {
            const card = document.createElement('div'); card.className = 'order-card';
            const date = new Date(o.timestamp).toLocaleString(state.currentLanguage === 'el' ? 'el-GR' : 'en-US');
            let badge = ''; 
            switch(o.status) { 
                case 'pending': badge=`<span class="order-status-badge status-pending">${state.currentLanguage === 'el' ? 'Î•ÎºÎºÏÎµÎ¼ÎµÎ¯' : 'Pending'}</span>`; break; 
                case 'preparing': badge=`<span class="order-status-badge status-preparing">${state.currentLanguage === 'el' ? 'Î•Ï„Î¿Î¹Î¼Î¬Î¶ÎµÏ„Î±Î¹' : 'Preparing'}</span>`; break; 
                case 'ready': badge=`<span class="order-status-badge status-ready">${state.currentLanguage === 'el' ? 'ÎˆÏ„Î¿Î¹Î¼Î¿' : 'Ready'}</span>`; break; 
                case 'served': badge=`<span class="order-status-badge status-served">${state.currentLanguage === 'el' ? 'Î£ÎµÏÎ²Î¹ÏÎ¯ÏƒÏ„Î·ÎºÎµ' : 'Served'}</span>`; break; 
                case 'cancelled': badge=`<span class="order-status-badge status-cancelled">${state.currentLanguage === 'el' ? 'Î‘ÎºÏ…ÏÏÎ¸Î·ÎºÎµ' : 'Cancelled'}</span>`;
                case 'payed': badge=`<span class="order-status-badge status-payed">${state.currentLanguage === 'el' ? 'Î Î»Î·ÏÏ‰Î¼Î­Î½Î¿' : 'Payed'}</span>`;
            }
            let itemsSum = '';
            if (o.items.length<=3) itemsSum = o.items.map(i=>`<div class="order-item-summary"><div class="order-item-summary-name"><div class="order-item-summary-quantity">${i.quantity}</div><div>${i.name}</div></div><div>$${(i.price*i.quantity).toFixed(2)}</div></div>`).join('');
            else {
                const first = o.items.slice(0,3); const rem = o.items.length-3;
                itemsSum = first.map(i=>`<div class="order-item-summary"><div class="order-item-summary-name"><div class="order-item-summary-quantity">${i.quantity}</div><div>${i.name}</div></div><div>$${(i.price*i.quantity).toFixed(2)}</div></div>`).join('');
                itemsSum += `<div class="order-item-summary"><div class="order-item-summary-name" style="margin-left: 10px; font-style: italic;">+${rem} ${state.currentLanguage === 'el' ? 'Î±ÎºÏŒÎ¼Î±' : 'more'} ${rem>1 ? (state.currentLanguage === 'el' ? 'ÎµÎ¯Î´Î·' : 'items') : (state.currentLanguage === 'el' ? 'ÎµÎ¯Î´Î¿Ï‚' : 'item')}</div><div></div></div>`;
            }
            card.innerHTML = `<div class="order-card-header"><div><div class="order-card-title">${state.currentLanguage === 'el' ? 'Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±' : 'Order'} #${o.orderNumber}</div><div class="order-card-time">${date}</div></div><div>${badge}</div></div><div class="order-card-body"><div class="order-items-summary">${itemsSum}</div><div style="margin-top:15px;"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${state.currentLanguage === 'el' ? 'Î¤ÏÏŒÏ€Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚:' : 'Payment Method:'}</span><span>${o.paymentMethod==='card' ? (state.currentLanguage === 'el' ? 'ÎšÎ¬ÏÏ„Î±' : 'Card') : (state.currentLanguage === 'el' ? 'ÎœÎµÏ„ÏÎ·Ï„Î¬' : 'Cash')}</span></div><div style="display:flex; justify-content:space-between;"><span>${state.currentLanguage === 'el' ? 'Î§ÏÏŒÎ½Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚:' : 'Payment Time:'}</span><span>${o.paymentTime==='now' ? (state.currentLanguage === 'el' ? 'Î Î»Î·ÏÏ‰Î¼Î® Î¤ÏÏÎ±' : 'Pay Now') : (state.currentLanguage === 'el' ? 'Î Î»Î·ÏÏ‰Î¼Î® Î‘ÏÎ³ÏŒÏ„ÎµÏÎ±' : 'Pay Later')}</span></div></div></div><div class="order-card-footer"><div class="order-total-summary">${state.currentLanguage === 'el' ? 'Î£ÏÎ½Î¿Î»Î¿:' : 'Total:'} $${o.total.toFixed(2)}</div><div style="font-size:14px; color:var(--gray);">${o.status==='pending' ? (state.currentLanguage === 'el' ? 'Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î¬Î¶ÎµÏ„Î±Î¹' : 'Your order is being processed') : o.status==='preparing' ? (state.currentLanguage === 'el' ? 'Î¤Î¿ Ï†Î±Î³Î·Ï„ÏŒ ÏƒÎ±Ï‚ ÎµÏ„Î¿Î¹Î¼Î¬Î¶ÎµÏ„Î±Î¹' : 'Your food is being prepared') : o.status==='ready' ? (state.currentLanguage === 'el' ? 'Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ ÎµÎ¯Î½Î±Î¹ Î­Ï„Î¿Î¹Î¼Î·' : 'Your order is ready') : o.status==='served' ? (state.currentLanguage === 'el' ? 'Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ ÏƒÎµÏÎ²Î¹ÏÎ¯ÏƒÏ„Î·ÎºÎµ' : 'Your order has been served') : o.status==='payed' ? (state.currentLanguage === 'el' ? 'Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Ï€Î»Î·ÏÏÎ¸Î·ÎºÎµ' : 'Your order is payed') : (state.currentLanguage === 'el' ? 'Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î±ÎºÏ…ÏÏÎ¸Î·ÎºÎµ' : 'Your order was cancelled')}</div></div>`;
            ordersList.appendChild(card);
        });
        myOrdersSubtitle.textContent = state.currentLanguage === 'el' ? `ÎˆÏ‡ÎµÏ„Îµ ${tableOrders.length} Ï€Î±ÏÎ±Î³Î³ÎµÎ»${tableOrders.length!==1?'Î¯ÎµÏ‚':'Î¯Î±'} Î³Î¹Î± ${state.currentTable}` : `You have ${tableOrders.length} order${tableOrders.length!==1?'s':''} for ${state.currentTable}`;
    }

    // ========== SELECT TABLE ==========
    function selectTable(name, isAutoLogin = false) {
        state.currentTable = name;
        tableInfo.innerHTML = `<i class="fas fa-chair"></i> ${name}`;
        menuSubtitle.textContent = state.currentLanguage === 'el' ? `Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎµÎ¯Î´Î· Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${name}` : `Select items to add to your order for ${name}`;
        cartSubtitle.textContent = state.currentLanguage === 'el' ? `Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${name}` : `Your order for ${name}`;
        localStorage.setItem('dineEasyTable', name);
        showNotification(state.currentLanguage === 'el' ? `Î¤Î¿ Ï„ÏÎ±Ï€Î­Î¶Î¹ ${name} ÎµÏ€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ. ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸Î±Ï„Îµ!` : `Table ${name} selected. Welcome!`);
        resetCart();
        updateCategoryTabs();
        displayMenuItems('all');
        
        // Hide "My Orders" button if table name contains "take away" (case-insensitive)
        if (name.toLowerCase().includes('take away')) {
            myOrdersButton.style.display = 'none';
        } else {
            myOrdersButton.style.display = 'flex';
        }
        
        showSection('menuSection');
        if (name.toLowerCase() === "admin") {
            adminFloating.style.display = 'flex';
        } else {
            adminFloating.style.display = 'none';
        }
        updateRequestPayButton();
        
        // Apply per-table button visibility
        applyTableSettings();
    }

    // NEW: apply table settings to UI (hide buttons if disabled)
    function applyTableSettings() {
        if (!state.currentTable || state.currentTable === "Admin" || state.isAdminMode) return;
        const tableObj = state.tables.find(t => t.name === state.currentTable);
        if (!tableObj) return;
        const settings = tableObj.settings || { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true };
        
        // Help button
        const helpBtn = document.getElementById('headerHelpButton');
        if (helpBtn) helpBtn.style.display = settings.help ? 'flex' : 'none';
        
        // Payment request button (visibility also depends on active orders)
        updateRequestPayButton(); // will check settings inside
        
        // Payment method cards in payment section
        const cardOption = document.querySelector('.option-card[data-payment="card"]');
        const cashOption = document.querySelector('.option-card[data-payment="cash"]');
        if (cardOption) cardOption.style.display = settings.card ? 'block' : 'none';
        if (cashOption) cashOption.style.display = settings.cash ? 'block' : 'none';
        
        const payNowOption = document.querySelector('.option-card[data-time="now"]');
        const payLaterOption = document.querySelector('.option-card[data-time="later"]');
        if (payNowOption) payNowOption.style.display = settings.payNow ? 'block' : 'none';
        if (payLaterOption) payLaterOption.style.display = settings.payLater ? 'block' : 'none';
    }

    // ========== AUTO-LOGIN FROM URL (FIXED: NO DEFAULT TABLE) ==========
    function autoLoginFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const tableParam = urlParams.get('table');
        if (tableParam) {
            const tableName = decodeURIComponent(tableParam);
            selectTable(tableName, true);
        }
        // No default table - stay on scanner if no table parameter
    }

    // ========== QR SCANNER FUNCTIONS ==========
    async function startCamera() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            qrVideo.srcObject = videoStream;
            qrVideo.style.display = 'block';
            qrVideo.play();
            startCameraBtn.style.display = 'none';
            stopCameraBtn.style.display = 'inline-block';
            document.getElementById('qr-placeholder').style.display = 'none';
            scanning = true;
            requestAnimationFrame(scanQR);
        } catch (err) {
            console.error("Camera error:", err);
            showNotification(state.currentLanguage === 'el' ? 'Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î·Î½ ÎºÎ¬Î¼ÎµÏÎ±.' : 'Could not access camera.');
        }
    }

    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        qrVideo.style.display = 'none';
        startCameraBtn.style.display = 'inline-block';
        stopCameraBtn.style.display = 'none';
        document.getElementById('qr-placeholder').style.display = 'flex';
        scanning = false;
    }

    function scanQR() {
        if (!scanning || !qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
            if (scanning) requestAnimationFrame(scanQR);
            return;
        }
        const canvas = qrCanvas;
        const context = canvas.getContext('2d');
        canvas.width = qrVideo.videoWidth;
        canvas.height = qrVideo.videoHeight;
        context.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code) {
            const url = code.data;
            try {
                const urlObj = new URL(url);
                const tableParam = urlObj.searchParams.get('table');
                if (tableParam) {
                    stopCamera();
                    const tableName = decodeURIComponent(tableParam);
                    selectTable(tableName, true);
                    return;
                }
            } catch (e) {
                // Not a valid URL
            }
        }
        requestAnimationFrame(scanQR);
    }

    // ========== REQUEST PAY BUTTON (UPDATED LOGIC) ==========
    function updateRequestPayButton() {
        if (!state.currentTable || state.currentTable === "Admin" || state.isAdminMode) {
            requestPayBtn.style.display = 'none';
            return;
        }
        const tableObj = state.tables.find(t => t.name === state.currentTable);
        if (!tableObj || !tableObj.settings.payRequest) {
            requestPayBtn.style.display = 'none';
            return;
        }
        const activeOrders = state.orders.filter(o => 
            o.table === state.currentTable && 
            o.paymentTime === 'later' && 
            o.status !== 'payed' && 
            o.status !== 'cancelled'
        );
        if (activeOrders.length > 0) {
            requestPayBtn.style.display = 'flex';
        } else {
            requestPayBtn.style.display = 'none';
        }
    }

    // UPDATED requestPay with per-table cooldown & pending check
    async function requestPay() {
        if (!state.currentTable || state.currentTable === "Admin" || state.isAdminMode) return;
        
        // Check if there's already a pending payment request for this table
        const hasPendingPay = state.helpRequests.some(r => r.table === state.currentTable && r.requestType === 'payment' && r.status === 'pending');
        if (hasPendingPay) {
            showNotification(state.currentLanguage === 'el' ? 'Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÎµÎºÎºÏÎµÎ¼Î­Ï‚ Î±Î¯Ï„Î·Î¼Î± Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Ï„ÏÎ±Ï€Î­Î¶Î¹.' : 'There is already a pending payment request for this table.');
            return;
        }
        
        // Cooldown check (2 minutes = 120000 ms) per table
        const now = Date.now();
        const last = state.lastPayRequestTimeByTable[state.currentTable] || 0;
        if (now - last < 120000) {
            const remaining = Math.ceil((120000 - (now - last)) / 1000);
            showNotification(state.currentLanguage === 'el' ? `Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ ${remaining} Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î± Ï€ÏÎ¹Î½ Î¾Î±Î½Î±ÏƒÏ„ÎµÎ¯Î»ÎµÏ„Îµ Î±Î¯Ï„Î·Î¼Î± Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚.` : `Please wait ${remaining} seconds before sending another payment request.`);
            return;
        }
        state.lastPayRequestTimeByTable[state.currentTable] = now;
        
        const requestId = 'pay_' + Date.now() + '_' + Math.random().toString(36).substring(2);
        const payRequest = {
            id: requestId,
            table: state.currentTable,
            timestamp: new Date().toISOString(),
            status: 'pending',
            requestType: 'payment'
        };
        state.helpRequests.push(payRequest);
        await saveHelpRequest(payRequest);
        showNotification(state.currentLanguage === 'el' ? `Î‘Î¯Ï„Î·Î¼Î± Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ Î³Î¹Î± ${state.currentTable} ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ.` : `Payment request for ${state.currentTable} sent.`);
        playSound(state.soundEffects.helpRequestSound);
    }

    // ========== HELP REQUEST (UPDATED) ==========
    async function requestHelp() {
        if (!state.currentTable || state.isAdminMode) {
            showNotification(state.currentLanguage === 'el' ? 'Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏÏÏ„Î± Î­Î½Î± Ï„ÏÎ±Ï€Î­Î¶Î¹.' : 'Please select a table first.');
            return;
        }
        
        // Check if there's already a pending help request for this table
        const hasPendingHelp = state.helpRequests.some(r => r.table === state.currentTable && r.requestType === 'help' && r.status === 'pending');
        if (hasPendingHelp) {
            showNotification(state.currentLanguage === 'el' ? 'Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÎµÎºÎºÏÎµÎ¼Î­Ï‚ Î±Î¯Ï„Î·Î¼Î± Î²Î¿Î®Î¸ÎµÎ¹Î±Ï‚ Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Ï„ÏÎ±Ï€Î­Î¶Î¹.' : 'There is already a pending help request for this table.');
            return;
        }
        
        // Cooldown check (2 minutes = 120000 ms) per table
        const now = Date.now();
        const last = state.lastHelpRequestTimeByTable[state.currentTable] || 0;
        if (now - last < 120000) {
            const remaining = Math.ceil((120000 - (now - last)) / 1000);
            showNotification(state.currentLanguage === 'el' ? `Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ ${remaining} Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î± Ï€ÏÎ¹Î½ Î¾Î±Î½Î±ÏƒÏ„ÎµÎ¯Î»ÎµÏ„Îµ Î±Î¯Ï„Î·Î¼Î± Î²Î¿Î®Î¸ÎµÎ¹Î±Ï‚.` : `Please wait ${remaining} seconds before sending another help request.`);
            return;
        }
        state.lastHelpRequestTimeByTable[state.currentTable] = now;
        
        playSound(state.soundEffects.helpRequestSound);
        const requestId = 'help_' + Date.now() + '_' + Math.random().toString(36).substring(2);
        const helpRequest = {
            id: requestId,
            table: state.currentTable,
            timestamp: new Date().toISOString(),
            status: 'pending',
            requestType: 'help'
        };
        state.helpRequests.push(helpRequest);
        await saveHelpRequest(helpRequest);
        showNotification(state.currentLanguage === 'el' ? `Î‘Î¯Ï„Î·Î¼Î± Î²Î¿Î®Î¸ÎµÎ¹Î±Ï‚ Î³Î¹Î± ${state.currentTable}. ÎˆÎ½Î±Ï‚ ÏƒÎµÏÎ²Î¹Ï„ÏŒÏÎ¿Ï‚ Î¸Î± ÏƒÎ±Ï‚ ÎµÎ¾Ï…Ï€Î·ÏÎµÏ„Î®ÏƒÎµÎ¹ ÏƒÏÎ½Ï„Î¿Î¼Î±.` : `Help request for ${state.currentTable}. A waiter will assist you shortly.`);
    }
    function showHelpNotification() { 
        if (state.currentTable) { requestHelp(); } 
        else { showNotification(state.currentLanguage === 'el' ? 'ÎˆÎ½Î±Ï‚ ÏƒÎµÏÎ²Î¹Ï„ÏŒÏÎ¿Ï‚ Î¸Î± ÏƒÎ±Ï‚ ÎµÎ¾Ï…Ï€Î·ÏÎµÏ„Î®ÏƒÎµÎ¹ ÏƒÏÎ½Ï„Î¿Î¼Î±.' : 'A waiter will assist you shortly.'); }
    }

    // ========== ADMIN MODE ==========
    function startHelpSoundInterval() {
        if (state.helpSoundInterval) clearInterval(state.helpSoundInterval);
        state.helpSoundInterval = setInterval(() => {
            const hasPending = state.helpRequests.some(r => r.status === 'pending');
            if (hasPending) { playSound(state.soundEffects.helpRequestSound); }
        }, 60000);
    }
    function enterAdminMode() {
        if (state.isAdminMode) return;
        state.isAdminMode = true; state.currentTable = "Admin";
        document.body.classList.add('admin-mode');
        document.querySelector('.header-center').innerHTML = '<div class="admin-badge"><i class="fas fa-shield-alt"></i> Administrator Mode</div><button class="language-toggle" id="languageToggleBtn"><i class="fas fa-language"></i> <span id="langToggleText">EN</span></button>';
        document.querySelector('.header-right').innerHTML = '<button class="logout-button" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</button>';
        document.getElementById('logoutButton').addEventListener('click', exitAdminMode);
        cartFloating.style.display = 'none';
        showSection('adminDashboardSection');
        loadAdminDashboardData();
        localStorage.setItem('dineEasyAdminMode', 'true');
        playSound(state.soundEffects.helpRequestSound);
        showNotification("Admin mode activated. Full administrative access granted.");
        startHelpSoundInterval();
        requestPayBtn.style.display = 'none';
    }
    function exitAdminMode() {
        state.isAdminMode = false; state.currentTable = null;
        document.body.classList.remove('admin-mode');
        document.querySelector('.header-center').innerHTML = '<button class="request-pay-button" id="requestPayBtn" style="display:none;"><i class="fas fa-credit-card"></i> <span data-i18n="requestPay">Î‘Î¯Ï„Î·Î¼Î± Î Î»Î·ÏÏ‰Î¼Î®Ï‚</span></button><button class="help-button" id="headerHelpButton"><i class="fas fa-headset"></i> <span data-i18n="helpButton">Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ Î²Î¿Î®Î¸ÎµÎ¹Î±?</span></button><button class="language-toggle" id="languageToggleBtn"><i class="fas fa-language"></i> <span id="langToggleText">EN</span></button><button class="back-to-admin" id="backToAdminBtn" style="display:none;"><i class="fas fa-arrow-left"></i> <span data-i18n="backToAdmin">Î Î¯ÏƒÏ‰ ÏƒÏ„Î¿Î½ Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®</span></button>';
        document.querySelector('.header-right').innerHTML = '<button class="my-orders-button" id="myOrdersButton" style="display: none;"><i class="fas fa-clipboard-list"></i> <span data-i18n="myOrdersButton">ÎŸÎ¹ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚ Î¼Î¿Ï…</span></button><div class="table-info" id="tableInfo"><i class="fas fa-qrcode"></i> <span data-i18n="tableInfo">Î£Î±ÏÏÏƒÏ„Îµ QR Î³Î¹Î± Î­Î½Î±ÏÎ¾Î·</span></div>';
        document.getElementById('headerHelpButton').addEventListener('click', showHelpNotification);
        document.getElementById('languageToggleBtn').addEventListener('click', toggleLanguage);
        document.getElementById('requestPayBtn').addEventListener('click', requestPay);
        cartFloating.style.display = 'flex';
        showSection('scannerSection');
        localStorage.removeItem('dineEasyAdminMode');
        adminFloating.style.display = 'none';
        auth.signOut(); // Sign out from Firebase
        showNotification("Logged out of admin mode.");
        if (state.helpSoundInterval) { clearInterval(state.helpSoundInterval); state.helpSoundInterval = null; }
        applyTranslations();
        updateRequestPayButton();
    }

    auth.onAuthStateChanged(async user => {
        console.log('Auth state changed:', user ? user.email : 'null');
        // If user is logged in and current table is Admin, and not already in admin mode, verify business email
        if (user && state.currentTable && state.currentTable.toLowerCase() === "admin" && !state.isAdminMode) {
            try {
                const businessDoc = await getBusinessDoc().get();
                if (!businessDoc.exists) {
                    console.error('Business document not found');
                    showNotification('Business configuration missing. Please contact support.');
                    await auth.signOut();
                    return;
                }
                const businessData = businessDoc.data();
                if (businessData.adminEmail !== user.email) {
                    console.error('User email not authorized for this business');
                    showNotification('Your email is not authorized for this business.');
                    await auth.signOut();
                    return;
                }
                // If authorized, enter admin mode
                enterAdminMode();
            } catch (e) {
                console.error('Error verifying business admin:', e);
                showNotification('Error verifying authorization. Please try again.');
                await auth.signOut();
            }
        }
    });

    // ========== DRAG AND DROP (unchanged) ==========
    async function makeAdminGridDraggable(gridId) {
        const grid = document.getElementById(gridId); if (!grid) return;
        let dragged = null;
        grid.addEventListener('dragstart', e => {
            const card = e.target.classList.contains('admin-card')?e.target:e.target.closest('.admin-card');
            if (card) { dragged = card; card.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', card.dataset.itemId||''); }
        });
        grid.addEventListener('dragend', e => { if (dragged) { dragged.classList.remove('dragging'); dragged=null; } });
        grid.addEventListener('dragover', e => e.preventDefault());
        grid.addEventListener('drop', async function(e) {
            e.preventDefault(); if (!dragged) return;
            const target = e.target.classList.contains('admin-card')?e.target:e.target.closest('.admin-card');
            if (!target || target===dragged) return;
            const items = Array.from(grid.children).filter(c=>c.classList.contains('admin-card'));
            const dragIdx = items.indexOf(dragged), targetIdx = items.indexOf(target);
            if (dragIdx===-1 || targetIdx===-1) return;
            if (dragIdx<targetIdx) grid.insertBefore(dragged, target.nextSibling);
            else grid.insertBefore(dragged, target);
            const updated = Array.from(grid.children).filter(c=>c.classList.contains('admin-card'));
            updated.forEach((c, idx) => {
                const id = parseInt(c.dataset.itemId);
                const mi = state.menuItems.find(m => m.id === id);
                if (mi) mi.displayOrder = idx;
            });
            state.menuItems.sort((a,b) => (a.displayOrder||0) - (b.displayOrder||0));
            await Promise.all(state.menuItems.map(item => saveMenuItem(item)));
            showNotification("Menu order updated");
            loadMenuItemsForAdmin();
            loadMenuItemsForAdminEn();
            displayMenuItems(document.querySelector('.category-tab.active')?.dataset?.category || 'all');
        });
    }
    function makeCategoriesDraggable(containerId) {
        const c = document.getElementById(containerId); if (!c) return;
        let dragged = null;
        c.addEventListener('dragstart', e => {
            const item = e.target.classList.contains('category-item')?e.target:e.target.closest('.category-item');
            if (item) { dragged = item; item.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', item.dataset.categoryId||''); }
        });
        c.addEventListener('dragend', e => { if (dragged) { dragged.classList.remove('dragging'); dragged=null; } });
        c.addEventListener('dragover', e => e.preventDefault());
        c.addEventListener('drop', async function(e) {
            e.preventDefault(); if (!dragged) return;
            const target = e.target.classList.contains('category-item')?e.target:e.target.closest('.category-item');
            if (!target || target===dragged) return;
            const items = Array.from(c.children).filter(el=>el.classList.contains('category-item'));
            const dragIdx = items.indexOf(dragged), targetIdx = items.indexOf(target);
            if (dragIdx===-1 || targetIdx===-1) return;
            if (dragIdx<targetIdx) c.insertBefore(dragged, target.nextSibling);
            else c.insertBefore(dragged, target);
            const updated = Array.from(c.children).filter(el=>el.classList.contains('category-item'));
            updated.forEach((el, i) => {
                const catId = el.dataset.categoryId;
                const cat = state.categories.find(ca=>ca.id===catId);
                if (cat) cat.displayOrder = i;
            });
            state.categories.sort((a,b) => (a.displayOrder||0) - (b.displayOrder||0));
            await saveCategories();
            updateCategoryTabs();
        });
    }

    // ========== DELETE ORDERS BY TABLE (unchanged) ==========
    function populateTableSelect(selectId) {
        const sel = document.getElementById(selectId); if (!sel) return;
        const tables = [...new Set(state.orders.filter(o=>o.table&&o.table.toLowerCase()!=='admin').map(o=>o.table))].sort();
        sel.innerHTML = '';
        if (tables.length===0) sel.innerHTML = '<option value="">-- No tables with orders --</option>';
        else {
            const def = document.createElement('option'); def.value = ''; def.textContent = '-- Select a table --'; sel.appendChild(def);
            tables.forEach(t => {
                const opt = document.createElement('option'); opt.value = t; opt.textContent = t + ` (${state.orders.filter(o=>o.table===t).length} orders)`;
                sel.appendChild(opt);
            });
        }
    }
    async function deleteOrdersForTable(tableName) {
        if (!tableName) { showNotification('Please select a table.'); return; }
        const toDelete = state.orders.filter(o=>o.table===tableName);
        if (toDelete.length===0) { showNotification(`No orders for table "${tableName}".`); return; }
        if (!confirm(`Delete ALL orders for table "${tableName}"?`)) return;
        state.orders = state.orders.filter(o=>o.table!==tableName);
        updatePendingBadges();
        populateTableFilter();
        populateTableFilterModal();
        loadOrdersForAdmin();
        if (adminPanel.style.display === 'flex') loadOrdersForAdminModal();
        populateTableSelect('tableSelectForDelete');
        populateTableSelect('tableSelectForDeleteModal');
        showNotification(`Deleted ${toDelete.length} orders. Stats remain unchanged.`);
        await Promise.all(toDelete.map(o=>deleteOrderFirestore(o.orderNumber)));
    }

    // ========== DELETE SINGLE ORDER (NEW) ==========
    async function deleteSingleOrder(orderId) {
        if (!confirm(`Are you sure you want to delete order #${orderId}?`)) return;
        
        // Remove from local state
        state.orders = state.orders.filter(o => o.orderNumber !== orderId);
        
        // Update UI
        updatePendingBadges();
        populateTableFilter();
        populateTableFilterModal();
        loadOrdersForAdmin();
        if (adminPanel.style.display === 'flex') loadOrdersForAdminModal();
        if (state.currentTable && !state.isAdminMode) loadMyOrders();
        
        // Remove from Firestore
        await deleteOrderFirestore(orderId);
        
        // Recalculate cumulative stats (optional)
        recalcCumulativeStats();
        
        showNotification(`Order #${orderId} deleted.`);
    }

    // ========== PDF DOWNLOAD FUNCTION ==========
    function downloadOrderPdf(order) {
        const lang = state.currentLanguage;
        const restaurantName = state.restaurantInfo.name || 'Restaurant';
    
        // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï€Î¯Î½Î±ÎºÎ± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½ Î³Î¹Î± Ï„Î¿ pdfmake
        const body = [
            [
                { text: lang === 'el' ? 'Î ÏÎ¿ÏŠÏŒÎ½' : 'Item', style: 'tableHeader' },
                { text: lang === 'el' ? 'Î Î¿Ïƒ.' : 'Qty', style: 'tableHeader' },
                { text: lang === 'el' ? 'Î¤Î¹Î¼Î®' : 'Price', style: 'tableHeader' }
            ]
        ];
    
        order.items.forEach(item => {
            // Î ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ Ï„Î·Î½ ÎºÏÏÎ¹Î± Î³ÏÎ±Î¼Î¼Î® Ï„Î¿Ï… Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚
            const itemRow = [
                item.name,
                item.quantity.toString(),
                `$${(item.price * item.quantity).toFixed(2)}`
            ];
            body.push(itemRow);
    
            // Î‘Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚, Ï„Î¹Ï‚ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ Ï‰Ï‚ Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î­Ï‚ Î³ÏÎ±Î¼Î¼Î­Ï‚ (Ï‡Ï‰ÏÎ¯Ï‚ Ï€Î¿ÏƒÏŒÏ„Î·Ï„Î±/Ï„Î¹Î¼Î®)
            if (item.selectedOptions && item.selectedOptions.length) {
                item.selectedOptions.forEach(opt => {
                    let optText = opt.isComment
                        ? `${opt.groupName}: "${opt.choiceName}"`
                        : `${opt.groupName}: ${opt.choiceName} ${opt.price ? (opt.price > 0 ? `+$${opt.price.toFixed(2)}` : opt.price < 0 ? `-$${Math.abs(opt.price).toFixed(2)}` : '') : ''}`;
                    body.push([
                        { text: optText, fontSize: 10, color: '#666666', margin: [10, 0, 0, 0] },
                        '',
                        ''
                    ]);
                });
            }
        });
    
        // ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï„Î¿Ï… ÎµÎ³Î³ÏÎ¬Ï†Î¿Ï…
        const docDefinition = {
            content: [
                // Î¤Î¯Ï„Î»Î¿Ï‚ ÎµÏƒÏ„Î¹Î±Ï„Î¿ÏÎ¯Î¿Ï…
                { text: restaurantName, style: 'header', alignment: 'center' },
                { text: '\n' },
                // Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚
                { text: `${lang === 'el' ? 'Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±' : 'Order'} #${order.orderNumber}`, style: 'subheader' },
                { text: `${lang === 'el' ? 'Î¤ÏÎ±Ï€Î­Î¶Î¹:' : 'Table:'} ${order.table}`, style: 'normal' },
                { text: `${lang === 'el' ? 'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±:' : 'Date:'} ${new Date(order.timestamp).toLocaleString(lang === 'el' ? 'el-GR' : 'en-US')}`, style: 'normal' },
                { text: '\n' },
                // Î Î¯Î½Î±ÎºÎ±Ï‚ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½
                {
                    style: 'itemsTable',
                    table: {
                        headerRows: 1,
                        widths: ['*', 'auto', 'auto'],
                        body: body
                    },
                    layout: 'lightHorizontalLines'
                },
                { text: '\n' },
                // Î£ÏÎ½Î¿Î»Î¿
                {
                    columns: [
                        { width: '*', text: '' },
                        { width: 'auto', text: lang === 'el' ? 'Î£ÏÎ½Î¿Î»Î¿:' : 'Total:', style: 'totalLabel' },
                        { width: 'auto', text: `$${order.total.toFixed(2)}`, style: 'totalValue' }
                    ]
                },
                { text: '\n' },
                // Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚
                {
                    columns: [
                        { width: '*', text: '' },
                        { width: 'auto', text: `${lang === 'el' ? 'Î¤ÏÏŒÏ€Î¿Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚:' : 'Payment method:'} ${order.paymentMethod === 'card' ? (lang === 'el' ? 'ÎšÎ¬ÏÏ„Î±' : 'Card') : (lang === 'el' ? 'ÎœÎµÏ„ÏÎ·Ï„Î¬' : 'Cash')}`, style: 'paymentInfo' },
                    ]
                },
                {
                    columns: [
                        { width: '*', text: '' },
                        { width: 'auto', text: `${lang === 'el' ? 'Î§ÏÏŒÎ½Î¿Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚:' : 'Payment time:'} ${order.paymentTime === 'now' ? (lang === 'el' ? 'Î Î»Î·ÏÏ‰Î¼Î® Ï„ÏÏÎ±' : 'Pay now') : (lang === 'el' ? 'Î Î»Î·ÏÏ‰Î¼Î® Î±ÏÎ³ÏŒÏ„ÎµÏÎ±' : 'Pay later')}`, style: 'paymentInfo' },
                    ]
                }
            ],
            styles: {
                header: { fontSize: 20, bold: true, color: '#e63946', margin: [0, 0, 0, 10] },
                subheader: { fontSize: 14, bold: true, margin: [0, 5, 0, 5] },
                normal: { fontSize: 12, margin: [0, 2, 0, 2] },
                tableHeader: { bold: true, fontSize: 12, fillColor: '#f2f2f2' },
                totalLabel: { bold: true, fontSize: 14, margin: [0, 5, 5, 5] },
                totalValue: { bold: true, fontSize: 14, color: '#e63946', margin: [0, 5, 0, 5] },
                paymentInfo: { fontSize: 11, margin: [0, 2, 0, 2] }
            },
            defaultStyle: {
                font: 'Roboto' // Î— Roboto Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ Î•Î»Î»Î·Î½Î¹ÎºÎ¬
            }
        };
    
        // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ±Î¹ Î»Î®ÏˆÎ· PDF
        pdfMake.createPdf(docDefinition).download(`order-${order.orderNumber}.pdf`);
        showNotification(lang === 'el' ? 'Î¤Î¿ PDF Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ.' : 'PDF generated.');
    }

    // ========== QR CODE PDF GENERATOR (include business param) ==========
    function generateTableQRCodePDF(tableNamesArray) {
        if (!tableNamesArray || tableNamesArray.length === 0) {
            showNotification("Please enter at least one table name.");
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
        const baseUrl = window.location.origin + window.location.pathname;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        const qrSize = 50;
        const cols = 2;
        const rowsPerPage = 3;
        const cellWidth = (pageWidth - 2 * margin) / cols;
        const cellHeight = (pageHeight - 2 * margin) / rowsPerPage;
        let index = 0;
        tableNamesArray.forEach((tableName, i) => {
            if (i > 0 && i % (cols * rowsPerPage) === 0) { doc.addPage(); }
            const col = i % cols;
            const row = Math.floor((i % (cols * rowsPerPage)) / cols);
            const x = margin + col * cellWidth;
            const y = margin + row * cellHeight;
            const qr = qrcode(0, 'M');
            // Include business parameter if not default
            let url = baseUrl + '?table=' + encodeURIComponent(tableName);
            if (businessId !== 'default') {
                url += '&business=' + encodeURIComponent(businessId);
            }
            qr.addData(url);
            qr.make();
            const qrCanvas = document.createElement('canvas');
            qrCanvas.width = qr.getModuleCount() * 5;
            qrCanvas.height = qr.getModuleCount() * 5;
            const ctx = qrCanvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, qrCanvas.width, qrCanvas.height);
            ctx.fillStyle = '#000000';
            for (let r = 0; r < qr.getModuleCount(); r++) {
                for (let c = 0; c < qr.getModuleCount(); c++) {
                    if (qr.isDark(r, c)) { ctx.fillRect(c * 5, r * 5, 5, 5); }
                }
            }
            const qrDataURL = qrCanvas.toDataURL('image/png');
            doc.addImage(qrDataURL, 'PNG', x, y, qrSize, qrSize);
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(tableName, x + qrSize/2, y + qrSize + 8, { align: 'center' });
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Scan to order', x + qrSize/2, y + qrSize + 16, { align: 'center' });
        });
        doc.save('restaurant-table-qrcodes.pdf');
        showNotification(`PDF generated with ${tableNamesArray.length} QR code(s).`);
    }

    // ========== OPEN VERTICAL ORDERS VIEW (FIXED PERMISSIONS) ==========
    function openVerticalOrdersView() {
        const winHtml = `<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Vertical Orders Viewer</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
            body { font-family: "Poppins", sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
            .container { max-width: 1200px; margin: 0 auto; }
            h2 { color: #e63946; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-top: 0; }
            .toolbar { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
            .toolbar select { padding: 8px; border-radius: 6px; border: 1px solid #ced4da; flex: 0 0 200px; }
            button { padding: 8px 16px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; background: #e63946; color: white; transition: 0.2s; }
            button:hover { background: #c1121f; }
            button.secondary { background: #6c757d; }
            button.secondary:hover { background: #495057; }
            .orders-list { display: flex; flex-direction: column; gap: 20px; }
            .order-card { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 20px; border-left: 4px solid #e63946; }
            .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
            .order-title { font-size: 18px; font-weight: 600; color: #212529; }
            .order-time { font-size: 14px; color: #6c757d; }
            .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; }
            .status-pending { background: #fff3cd; color: #856404; }
            .status-preparing { background: #d1ecf1; color: #0c5460; }
            .status-ready { background: #d4edda; color: #155724; }
            .status-served { background: #cce5ff; color: #004085; }
            .status-cancelled { background: #f8d7da; color: #721c24; }
            .status-payed { background: #cce5ff; color: #004085; }
            .order-body { margin-bottom: 15px; }
            .order-actions { margin-top: 15px; display: flex; gap: 10px; align-items: center; }
            .order-actions select { padding: 6px; border-radius: 4px; border: 1px solid #ced4da; }
            .order-actions button { background: #457b9d; }
            .order-actions button:hover { background: #2c5a7a; }
            .no-orders { text-align: center; padding: 60px 20px; color: #6c757d; }
            .no-orders i { font-size: 60px; margin-bottom: 20px; opacity: 0.5; }
        </style>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"><\/script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"><\/script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"><\/script>
    </head>
    <body>
        <div class="container">
            <h2><i class="fas fa-list-ul"></i> Vertical Orders Viewer</h2>
            <div class="toolbar">
                <select id="statusFilter">
                    <option value="all">All Orders</option>
                    <option value="pending">Pending</option>
                    <option value="preparing">Preparing</option>
                    <option value="ready">Ready</option>
                    <option value="served">Served</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="payed">Payed</option>
                </select>
                <select id="tableFilter">
                    <option value="all">All Tables</option>
                </select>
                <button id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button class="secondary" onclick="window.close()"><i class="fas fa-times"></i> Close</button>
            </div>
            <div id="ordersList" class="orders-list">
                <div class="no-orders"><i class="fas fa-spinner fa-pulse"></i><p>Loading orders...</p></div>
            </div>
        </div>

        <script>
            // Initialize Firebase (Only needed for Reading/Listening)
            const firebaseConfig = {
                apiKey: "AIzaSyBOYqnY3hDTCjBJv97zn4_LlpfpA6Mnvk0",
                authDomain: "trytobereal-ce3f1.firebaseapp.com",
                projectId: "trytobereal-ce3f1",
                storageBucket: "trytobereal-ce3f1.firebasestorage.app",
                messagingSenderId: "53123319511",
                appId: "1:53123319511:web:78fb36d731b9e94b92d292"
            };
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();

            const businessId = '${businessId}';
            const ordersCollection = businessId === 'default' ? db.collection('orders') : db.collection(\`business_\${businessId}_orders\`);

            function formatDate(iso) {
                const d = new Date(iso);
                return d.toLocaleString();
            }

            // --- UPDATED: DELEGATE TO PARENT WINDOW ---
            // This uses the functions from the main Admin dashboard which is already logged in
            function updateOrderStatus(orderId, newStatus) {
                if (window.opener && !window.opener.closed && typeof window.opener.updateOrderStatusOptimistic === 'function') {
                    window.opener.updateOrderStatusOptimistic(orderId, newStatus);
                } else {
                    alert("Error: Main Admin window is closed. Cannot update status.");
                }
            }

            function deleteOrder(orderId) {
                if (!confirm("Delete this order?")) return;
                
                if (window.opener && !window.opener.closed && typeof window.opener.deleteSingleOrder === 'function') {
                    window.opener.deleteSingleOrder(orderId);
                } else {
                    alert("Error: Main Admin window is closed. Cannot delete order.");
                }
            }
            // ------------------------------------------

            let allOrders = [];

            function populateTableFilter(orders) {
                const tableFilter = document.getElementById("tableFilter");
                const currentSelection = tableFilter.value;
                const tables = [...new Set(orders.filter(o => o.table && o.table.toLowerCase() !== "admin").map(o => o.table))].sort();
                
                tableFilter.innerHTML = "<option value='all'>All Tables</option>";
                tables.forEach(t => {
                    const opt = document.createElement("option");
                    opt.value = t;
                    opt.textContent = t;
                    tableFilter.appendChild(opt);
                });
                tableFilter.value = currentSelection;
            }

            function renderOrders() {
                const list = document.getElementById("ordersList");
                const statusFilter = document.getElementById("statusFilter").value;
                const tableFilter = document.getElementById("tableFilter").value;
                let filtered = allOrders;
                if (statusFilter !== "all") {
                    filtered = filtered.filter(o => o.status === statusFilter);
                }
                if (tableFilter !== "all") {
                    filtered = filtered.filter(o => o.table === tableFilter);
                }
                if (filtered.length === 0) {
                    list.innerHTML = '<div class="no-orders"><i class="fas fa-clipboard-list"></i><p>No orders found.</p></div>';
                    return;
                }
                filtered.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                let html = "";
                filtered.forEach(o => {
                    let badgeClass = "";
                    let badgeText = o.status.charAt(0).toUpperCase() + o.status.slice(1);
                    switch(o.status) {
                        case "pending": badgeClass = "status-pending"; break;
                        case "preparing": badgeClass = "status-preparing"; break;
                        case "ready": badgeClass = "status-ready"; break;
                        case "served": badgeClass = "status-served"; break;
                        case "cancelled": badgeClass = "status-cancelled"; break;
                        case "payed": badgeClass = "status-payed"; break;
                    }
                    let itemsHtml = "";
                    o.items.forEach(item => {
                        itemsHtml += \`<div><strong>\${item.quantity}Ã— \${item.name}</strong> $\${(item.price * item.quantity).toFixed(2)}</div>\`;
                        if (item.selectedOptions && item.selectedOptions.length) {
                            item.selectedOptions.forEach(opt => {
                                if (opt.isComment) itemsHtml += \`<div style="margin-left:20px; font-size:12px; color:#666;"><i class="fas fa-comment"></i> \${opt.groupName}: "\${opt.choiceName}"</div>\`;
                                else itemsHtml += \`<div style="margin-left:20px; font-size:12px; color:#666;">â€¢ \${opt.groupName}: \${opt.choiceName} \${opt.price>0? \`(+$\${opt.price.toFixed(2)})\` : opt.price<0? \`(-$\${Math.abs(opt.price).toFixed(2)})\` : ""}</div>\`;
                            });
                        }
                    });
                    html += \`
                        <div class="order-card">
                            <div class="order-header">
                                <div>
                                    <span class="order-title">Order #\${o.orderNumber}</span>
                                    <span class="order-time">\${formatDate(o.timestamp)}</span>
                                </div>
                                <span class="status-badge \${badgeClass}">\${badgeText}</span>
                            </div>
                            <div class="order-body">
                                <p><strong>Table:</strong> \${o.table}</p>
                                <div>\${itemsHtml}</div>
                                <p><strong>Total:</strong> $\${o.total.toFixed(2)}</p>
                            </div>
                            <div class="order-actions">
                                <select id="status_sel_\${o.orderNumber}">
                                    <option value="pending" \${o.status==="pending"?"selected":""}>Pending</option>
                                    <option value="preparing" \${o.status==="preparing"?"selected":""}>Preparing</option>
                                    <option value="ready" \${o.status==="ready"?"selected":""}>Ready</option>
                                    <option value="served" \${o.status==="served"?"selected":""}>Served</option>
                                    <option value="cancelled" \${o.status==="cancelled"?"selected":""}>Cancelled</option>
                                    <option value="payed" \${o.status==="payed"?"selected":""}>Payed</option>
                                </select>
                                <button onclick="updateOrderStatus('\${o.orderNumber}', document.getElementById('status_sel_\${o.orderNumber}').value)" style="background: #2a9d8f;"><i class="fas fa-sync"></i> Update</button>
                                <button onclick="deleteOrder('\${o.orderNumber}')" style="background: #dc3545;"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        </div>
                    \`;
                });
                list.innerHTML = html;
            }

            function loadOrders() {
                ordersCollection.onSnapshot(snap => {
                    allOrders = snap.docs.map(doc => ({ orderNumber: doc.id, ...doc.data() }));
                    populateTableFilter(allOrders);
                    renderOrders();
                }, err => {
                    console.error("Firestore error", err);
                    // If permission denied error occurs on read, show appropriate message
                    if (err.code === 'permission-denied') {
                         document.getElementById("ordersList").innerHTML = '<div class="no-orders"><i class="fas fa-lock"></i><p>Permission Denied. Please ensure you are logged in on the main window.</p></div>';
                    }
                });
            }

            document.getElementById("statusFilter").addEventListener("change", renderOrders);
            document.getElementById("tableFilter").addEventListener("change", renderOrders);
            document.getElementById("refreshBtn").addEventListener("click", loadOrders);

            loadOrders();
        <\/script>
    </body>
    </html>`;

        // Try to open the window
        const win = window.open('', '_blank', 'width=900,height=600,scrollbars=yes,resizable=yes');
        if (win) {
            win.document.write(winHtml);
            win.document.close();
        } else {
            showNotification('Popâ€‘up blocked. Please allow popâ€‘ups for this site.');
        }
    }

    // ========== OPEN VERTICAL HELP REQUESTS VIEW (unchanged) ==========
    function openHelpVerticalView() {
        const winHtml = '<!DOCTYPE html>' +
        '<html>' +
        '<head>' +
            '<meta charset="UTF-8">' +
            '<title>Vertical Help Requests View</title>' +
            '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">' +
            '<style>' +
                'body { font-family: "Poppins", sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }' +
                '.container { max-width: 1200px; margin: 0 auto; }' +
                'h2 { color: #e63946; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-top: 0; }' +
                '.toolbar { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }' +
                '.toolbar select { padding: 8px; border-radius: 6px; border: 1px solid #ced4da; flex: 0 0 200px; }' +
                'button { padding: 8px 16px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; background: #e63946; color: white; transition: 0.2s; }' +
                'button:hover { background: #c1121f; }' +
                'button.secondary { background: #6c757d; }' +
                'button.secondary:hover { background: #495057; }' +
                '.requests-list { display: flex; flex-direction: column; gap: 20px; }' +
                '.request-card { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 20px; border-left: 4px solid #e63946; }' +
                '.request-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }' +
                '.request-title { font-size: 18px; font-weight: 600; color: #212529; }' +
                '.request-time { font-size: 14px; color: #6c757d; }' +
                '.status-badge { padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; }' +
                '.status-pending { background: #fff3cd; color: #856404; }' +
                '.status-resolved { background: #d4edda; color: #155724; }' +
                '.request-body { margin-bottom: 15px; }' +
                '.request-actions { margin-top: 15px; display: flex; gap: 10px; align-items: center; }' +
                '.request-actions button { background: #457b9d; }' +
                '.request-actions button:hover { background: #2c5a7a; }' +
                '.no-requests { text-align: center; padding: 60px 20px; color: #6c757d; }' +
                '.no-requests i { font-size: 60px; margin-bottom: 20px; opacity: 0.5; }' +
            '</style>' +
            '<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"><\/script>' +
            '<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"><\/script>' +
        '</head>' +
        '<body>' +
            '<div class="container">' +
                '<h2><i class="fas fa-headset"></i> Vertical Help Requests View</h2>' +
                '<div class="toolbar">' +
                    '<select id="statusFilter">' +
                        '<option value="all">All Requests</option>' +
                        '<option value="pending">Pending</option>' +
                        '<option value="resolved">Resolved</option>' +
                    '</select>' +
                    '<button id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>' +
                    '<button class="secondary" onclick="window.close()"><i class="fas fa-times"></i> Close</button>' +
                '</div>' +
                '<div id="requestsList" class="requests-list">' +
                    '<div class="no-requests"><i class="fas fa-spinner fa-pulse"></i><p>Loading requests...</p></div>' +
                '</div>' +
            '</div>' +
            '<script>' +
                'const firebaseConfig = {' +
                    'apiKey: "AIzaSyBOYqnY3hDTCjBJv97zn4_LlpfpA6Mnvk0",'+
                    'authDomain: "trytobereal-ce3f1.firebaseapp.com",'+
                    'projectId: "trytobereal-ce3f1",'+
                    'storageBucket: "trytobereal-ce3f1.firebasestorage.app",'+
                    'messagingSenderId: "53123319511",'+
                    'appId: "1:53123319511:web:78fb36d731b9e94b92d292"'+
                '};' +
                'firebase.initializeApp(firebaseConfig);' +
                'const db = firebase.firestore();' +
                '' +
                'const businessId = \'' + businessId + '\';' + // embed businessId
                'const helpRequestsCollection = businessId === \'default\' ? db.collection(\'helpRequests\') : db.collection(`business_${businessId}_helpRequests`);' +
                '' +
                'function formatDate(iso) {' +
                    'const d = new Date(iso);' +
                    'return d.toLocaleString();' +
                '}' +
                '' +
                'async function updateRequestStatus(requestId, newStatus) {' +
                    'try {' +
                        'await helpRequestsCollection.doc(requestId).update({ status: newStatus });' +
                    '} catch (err) {' +
                        'console.error("Error updating request:", err);' +
                        'alert("Failed to update request status.");' +
                    '}' +
                '}' +
                '' +
                'async function deleteRequest(requestId) {' +
                    'if (!confirm("Delete this help request?")) return;' +
                    'try {' +
                        'await helpRequestsCollection.doc(requestId).delete();' +
                    '} catch (err) {' +
                        'console.error("Error deleting request:", err);' +
                        'alert("Failed to delete request.");' +
                    '}' +
                '}' +
                '' +
                'let allRequests = [];' +
                '' +
                'function renderRequests() {' +
                    'const list = document.getElementById("requestsList");' +
                    'const statusFilter = document.getElementById("statusFilter").value;' +
                    'let filtered = allRequests;' +
                    'if (statusFilter !== "all") {' +
                        'filtered = filtered.filter(r => r.status === statusFilter);' +
                    '}' +
                    'if (filtered.length === 0) {' +
                        'list.innerHTML = "<div class=\\"no-requests\\"><i class=\\"fas fa-headset\\"></i><p>No help requests found.</p></div>";' +
                        'return;' +
                    '}' +
                    'filtered.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));' +
                    'let html = "";' +
                    'filtered.forEach(r => {' +
                        'let badgeClass = r.status === "pending" ? "status-pending" : "status-resolved";' +
                        'let badgeText = r.status.charAt(0).toUpperCase() + r.status.slice(1);' +
                        'let icon = r.requestType === "payment" ? "ğŸ’°" : "ğŸ†˜";' +
                        '' +
                        'html += "<div class=\\"request-card\\">"' +
                            '+ "<div class=\\"request-header\\"><div><span class=\\"request-title\\">" + icon + " " + r.table + "</span> <span class=\\"request-time\\">" + formatDate(r.timestamp) + "</span></div><span class=\\"status-badge " + badgeClass + "\\">" + badgeText + "</span></div>"' +
                            '+ "<div class=\\"request-body\\">"' +
                                '+ (r.requestType === "payment" ? "<p><i class=\\"fas fa-credit-card\\"></i> Payment request</p>" : "<p><i class=\\"fas fa-question-circle\\"></i> Help request</p>")' +
                            '+ "</div>"' +
                            '+ "<div class=\\"request-actions\\">"' +
                                '+ (r.status === "pending" ? "<button onclick=\\"updateRequestStatus(\'" + r.id + "\', \'resolved\')\\" style=\\"background: #2a9d8f;\\"><i class=\\"fas fa-check\\"></i> Resolve</button>" : "")' +
                                '+ "<button onclick=\\"deleteRequest(\'" + r.id + "\')\\" style=\\"background: #dc3545;\\"><i class=\\"fas fa-trash\\"></i> Delete</button>"' +
                            '+ "</div>"' +
                        '+ "</div>";' +
                    '});' +
                    'list.innerHTML = html;' +
                '}' +
                '' +
                'function loadRequests() {' +
                    'helpRequestsCollection.onSnapshot(snap => {' +
                        'allRequests = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));' +
                        'renderRequests();' +
                    '}, err => {' +
                        'console.error("Firestore error", err);' +
                        'document.getElementById("requestsList").innerHTML = "<div class=\\"no-requests\\"><i class=\\"fas fa-exclamation-triangle\\"></i><p>Error loading requests.</p></div>";' +
                    '});' +
                '}' +
                '' +
                'document.getElementById("statusFilter").addEventListener("change", renderRequests);' +
                'document.getElementById("refreshBtn").addEventListener("click", () => { loadRequests(); });' +
                '' +
                'loadRequests();' +
            '<\/script>' +
        '</body>' +
        '</html>';
        const win = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
        if (win) {
            win.document.write(winHtml);
            win.document.close();
        } else {
            showNotification('Popâ€‘up blocked. Please allow popâ€‘ups for this site.');
        }
    }

    // ========== OPEN CUSTOMER ORDER VIEW (unchanged) ==========
    function openCustomerOrderView() {
        const winHtml = '<!DOCTYPE html>' +
        '<html>' +
        '<head>' +
            '<meta charset="UTF-8">' +
            '<title>Take Away Order View</title>' +
            '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">' +
            '<style>' +
                'body { font-family: "Poppins", sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }' +
                '.container { max-width: 1200px; margin: 0 auto; }' +
                'h2 { color: #e63946; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-top: 0; }' +
                '.columns { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }' +
                '.column.preparing-column { background: #e6f7ff; }' +  /* light blue for preparing */
                '.column.ready-column { background: #f0fff0; }' +     /* light green for ready */
                '.column { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 20px; }' +
                '.column h3 { margin-top: 0; color: var(--secondary); border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }' +
                '.order-card { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #e63946; }' +
                '.order-card h4 { margin: 0 0 5px; color: #212529; }' +
                '.order-card .time { font-size: 12px; color: #6c757d; }' +
                '.order-card .items { margin: 10px 0; font-size: 14px; }' +
                '.order-card .total { font-weight: 600; color: #e63946; }' +
                '.no-orders { text-align: center; color: #6c757d; padding: 40px; }' +
                '.toolbar { margin-bottom: 20px; display: flex; gap: 10px; }' +
                'button { padding: 8px 16px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; background: #e63946; color: white; }' +
                'button.secondary { background: #6c757d; }' +
                'button:hover { opacity: 0.9; }' +
            '</style>' +
            '<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"><\/script>' +
            '<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"><\/script>' +
        '</head>' +
        '<body>' +
            '<div class="container">' +
                '<h2><i class="fas fa-shopping-bag"></i> Take Away Order Status</h2>' +
                '<div class="toolbar">' +
                    '<button id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>' +
                    '<button class="secondary" onclick="window.close()"><i class="fas fa-times"></i> Close</button>' +
                '</div>' +
                '<div class="columns">' +
                    '<div class="column preparing-column">' +
                        '<h3><i class="fas fa-fire"></i> Preparing</h3>' +
                        '<div id="preparingColumn">' +
                            '<div class="no-orders">Loading preparing orders...</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="column ready-column">' +
                        '<h3><i class="fas fa-check-circle"></i> Ready</h3>' +
                        '<div id="readyColumn">' +
                            '<div class="no-orders">Loading ready orders...</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            '<script>' +
                'const firebaseConfig = {' +
                    'apiKey: "AIzaSyBOYqnY3hDTCjBJv97zn4_LlpfpA6Mnvk0",'+
                    'authDomain: "trytobereal-ce3f1.firebaseapp.com",'+
                    'projectId: "trytobereal-ce3f1",'+
                    'storageBucket: "trytobereal-ce3f1.firebasestorage.app",'+
                    'messagingSenderId: "53123319511",'+
                    'appId: "1:53123319511:web:78fb36d731b9e94b92d292"'+
                '};' +
                'firebase.initializeApp(firebaseConfig);' +
                'const db = firebase.firestore();' +
                '' +
                'const businessId = \'' + businessId + '\';' + // embed businessId
                'const ordersCollection = businessId === \'default\' ? db.collection(\'orders\') : db.collection(`business_${businessId}_orders`);' +
                '' +
                'function formatDate(iso) {' +
                    'const d = new Date(iso);' +
                    'return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });' +
                '}' +
                '' +
                'function renderOrders(orders) {' +
                    'const takeaway = orders.filter(o => o.table && o.table.toLowerCase().includes("take away"));' +
                    'const preparing = takeaway.filter(o => o.status === "preparing");' +
                    'const ready = takeaway.filter(o => o.status === "ready");' +
                    '' +
                    'const prepCol = document.getElementById("preparingColumn");' +
                    'const readyCol = document.getElementById("readyColumn");' +
                    '' +
                    'if (preparing.length === 0) {' +
                        'prepCol.innerHTML = "<div class=\\"no-orders\\">No takeâ€‘away orders preparing.</div>";' +
                    '} else {' +
                        'let html = "";' +
                        'preparing.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).forEach(o => {' +
                            'let itemsHtml = "";' +
                            'o.items.forEach(item => {' +
                                'itemsHtml += `<div>${item.quantity}Ã— ${item.name}</div>`;' +
                            '});' +
                            'html += `<div class="order-card">' +
                                '<h4>Order #${o.orderNumber}</h4>' +
                                '<div class="time">${formatDate(o.timestamp)}</div>' +
                                '<div class="items">${itemsHtml}</div>' +
                                
                            '</div>`;' +
                        '});' +
                        'prepCol.innerHTML = html;' +
                    '}' +
                    '' +
                    'if (ready.length === 0) {' +
                        'readyCol.innerHTML = "<div class=\\"no-orders\\">No takeâ€‘away orders ready.</div>";' +
                    '} else {' +
                        'let html = "";' +
                        'ready.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).forEach(o => {' +
                            'let itemsHtml = "";' +
                            'o.items.forEach(item => {' +
                                'itemsHtml += `<div>${item.quantity}Ã— ${item.name}</div>`;' +
                            '});' +
                            'html += `<div class="order-card">' +
                                '<h4>Order #${o.orderNumber}</h4>' +
                                '<div class="time">${formatDate(o.timestamp)}</div>' +
                                '<div class="items">${itemsHtml}</div>' +
                                
                            '</div>`;' +
                        '});' +
                        'readyCol.innerHTML = html;' +
                    '}' +
                '}' +
                '' +
                'function loadOrders() {' +
                    'ordersCollection.onSnapshot(snap => {' +
                        'const orders = snap.docs.map(doc => ({ orderNumber: doc.id, ...doc.data() }));' +
                        'renderOrders(orders);' +
                    '}, err => {' +
                        'console.error("Firestore error", err);' +
                        'document.getElementById("preparingColumn").innerHTML = "<div class=\\"no-orders\\">Error loading orders.</div>";' +
                        'document.getElementById("readyColumn").innerHTML = "<div class=\\"no-orders\\">Error loading orders.</div>";' +
                    '});' +
                '}' +
                '' +
                'document.getElementById("refreshBtn").addEventListener("click", loadOrders);' +
                '' +
                'loadOrders();' +
            '<\/script>' +
        '</body>' +
        '</html>';
        const win = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
        if (win) {
            win.document.write(winHtml);
            win.document.close();
        } else {
            showNotification('Popâ€‘up blocked. Please allow popâ€‘ups for this site.');
        }
    }

    // ========== TABLE MANAGEMENT FUNCTIONS (UPDATED with Settings and latest order status) ==========
    function loadTablesForAdmin() {
        const container = document.getElementById('tablesListContainer');
        if (!container) return;
        container.innerHTML = '';
        if (state.tables.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">No tables added yet.</p>';
            return;
        }
        state.tables.sort((a,b) => a.name.localeCompare(b.name)).forEach(tableObj => {
            const tableName = tableObj.name;
            const settings = tableObj.settings || { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true };
            
            // Get latest order for this table
            const tableOrders = state.orders.filter(o => o.table === tableName);
            let latestOrderStatus = null;
            if (tableOrders.length > 0) {
                // Sort by timestamp descending
                const sorted = [...tableOrders].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                latestOrderStatus = sorted[0].status;
            }
            
            // Create status badge HTML
            let statusBadge = '';
            if (latestOrderStatus) {
                let statusClass = '';
                let statusText = latestOrderStatus.charAt(0).toUpperCase() + latestOrderStatus.slice(1);
                switch(latestOrderStatus) {
                    case 'pending': statusClass = 'status-pending'; break;
                    case 'preparing': statusClass = 'status-preparing'; break;
                    case 'ready': statusClass = 'status-ready'; break;
                    case 'served': statusClass = 'status-served'; break;
                    case 'cancelled': statusClass = 'status-cancelled'; break;
                    case 'payed': statusClass = 'status-payed'; break;
                    default: statusClass = 'status-pending';
                }
                statusBadge = `<span class="order-status-badge ${statusClass}" style="margin-left:10px;">${statusText}</span>`;
            } else {
                statusBadge = '<span style="margin-left:10px; font-size:12px; color:var(--gray);">No orders</span>';
            }
            
            const el = document.createElement('div'); el.className = 'category-item';
            el.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-chair"></i>
                    <span class="category-item-name">${tableName} ${statusBadge}</span>
                </div>
                <div class="admin-card-actions">
                    <button class="admin-small-btn btn-info table-settings" data-table="${tableName}"><i class="fas fa-cog"></i> Settings</button>
                    <button class="admin-small-btn btn-success order-for-table" data-table="${tableName}"><i class="fas fa-shopping-cart"></i> Order</button>
                    <button class="admin-small-btn btn-danger delete-table" data-table="${tableName}"><i class="fas fa-trash"></i></button>
                </div>
            `;
            container.appendChild(el);
        });
        document.querySelectorAll('.order-for-table').forEach(btn => {
            btn.addEventListener('click', function() {
                const table = this.dataset.table;
                state.currentTable = table;
                tableInfo.innerHTML = `<i class="fas fa-chair"></i> ${table}`;
                menuSubtitle.textContent = state.currentLanguage === 'el' ? `Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎµÎ¯Î´Î· Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${table}` : `Select items to add to your order for ${table}`;
                cartSubtitle.textContent = state.currentLanguage === 'el' ? `Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${table}` : `Your order for ${table}`;
                resetCart();
                updateCategoryTabs();
                displayMenuItems('all');
                myOrdersButton.style.display = 'flex';
                showSection('menuSection');
                backToAdminBtn.style.display = 'flex';
                applyTableSettings();
            });
        });
        document.querySelectorAll('.delete-table').forEach(btn => {
            btn.addEventListener('click', function() {
                const table = this.dataset.table;
                if (confirm(`Delete table "${table}"?`)) {
                    state.tables = state.tables.filter(t => t.name !== table);
                    deleteTableFirestore(table);
                    loadTablesForAdmin();
                    if (adminPanel.style.display === 'flex') loadTablesForAdminModal();
                    showNotification(`Table "${table}" deleted.`);
                }
            });
        });
        document.querySelectorAll('.table-settings').forEach(btn => {
            btn.addEventListener('click', function() {
                const tableName = this.dataset.table;
                const tableObj = state.tables.find(t => t.name === tableName);
                if (!tableObj) return;
                openTableSettings(tableObj);
            });
        });
    }

    function loadTablesForAdminModal() {
        const container = document.getElementById('tablesListContainerModal');
        if (!container) return;
        container.innerHTML = '';
        if (state.tables.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">No tables added yet.</p>';
            return;
        }
        state.tables.sort((a,b) => a.name.localeCompare(b.name)).forEach(tableObj => {
            const tableName = tableObj.name;
            const settings = tableObj.settings || { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true };
            
            // Get latest order for this table
            const tableOrders = state.orders.filter(o => o.table === tableName);
            let latestOrderStatus = null;
            if (tableOrders.length > 0) {
                const sorted = [...tableOrders].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                latestOrderStatus = sorted[0].status;
            }
            
            let statusBadge = '';
            if (latestOrderStatus) {
                let statusClass = '';
                let statusText = latestOrderStatus.charAt(0).toUpperCase() + latestOrderStatus.slice(1);
                switch(latestOrderStatus) {
                    case 'pending': statusClass = 'status-pending'; break;
                    case 'preparing': statusClass = 'status-preparing'; break;
                    case 'ready': statusClass = 'status-ready'; break;
                    case 'served': statusClass = 'status-served'; break;
                    case 'cancelled': statusClass = 'status-cancelled'; break;
                    case 'payed': statusClass = 'status-payed'; break;
                    default: statusClass = 'status-pending';
                }
                statusBadge = `<span class="order-status-badge ${statusClass}" style="margin-left:10px;">${statusText}</span>`;
            } else {
                statusBadge = '<span style="margin-left:10px; font-size:12px; color:var(--gray);">No orders</span>';
            }
            
            const el = document.createElement('div'); el.className = 'category-item';
            el.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-chair"></i>
                    <span class="category-item-name">${tableName} ${statusBadge}</span>
                </div>
                <div class="admin-card-actions">
                    <button class="admin-small-btn btn-info table-settings-modal" data-table="${tableName}"><i class="fas fa-cog"></i> Settings</button>
                    <button class="admin-small-btn btn-success order-for-table-modal" data-table="${tableName}"><i class="fas fa-shopping-cart"></i> Order</button>
                    <button class="admin-small-btn btn-danger delete-table-modal" data-table="${tableName}"><i class="fas fa-trash"></i></button>
                </div>
            `;
            container.appendChild(el);
        });
        document.querySelectorAll('.order-for-table-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                const table = this.dataset.table;
                state.currentTable = table;
                tableInfo.innerHTML = `<i class="fas fa-chair"></i> ${table}`;
                menuSubtitle.textContent = state.currentLanguage === 'el' ? `Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎµÎ¯Î´Î· Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÏ„Îµ ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${table}` : `Select items to add to your order for ${table}`;
                cartSubtitle.textContent = state.currentLanguage === 'el' ? `Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚ Î³Î¹Î± ${table}` : `Your order for ${table}`;
                resetCart();
                updateCategoryTabs();
                displayMenuItems('all');
                myOrdersButton.style.display = 'flex';
                showSection('menuSection');
                backToAdminBtn.style.display = 'flex';
                adminPanel.style.display = 'none';
                applyTableSettings();
            });
        });
        document.querySelectorAll('.delete-table-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                const table = this.dataset.table;
                if (confirm(`Delete table "${table}"?`)) {
                    state.tables = state.tables.filter(t => t.name !== table);
                    deleteTableFirestore(table);
                    loadTablesForAdmin();
                    loadTablesForAdminModal();
                    showNotification(`Table "${table}" deleted.`);
                }
            });
        });
        document.querySelectorAll('.table-settings-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                const tableName = this.dataset.table;
                const tableObj = state.tables.find(t => t.name === tableName);
                if (!tableObj) return;
                openTableSettings(tableObj);
            });
        });
    }

    function openTableSettings(tableObj) {
        currentTableForSettings = tableObj;
        tableSettingsName.textContent = tableObj.name;
        const s = tableObj.settings || { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true };
        tableSettingHelp.checked = s.help;
        tableSettingPayRequest.checked = s.payRequest;
        tableSettingCard.checked = s.card;
        tableSettingCash.checked = s.cash;
        tableSettingPayNow.checked = s.payNow;
        tableSettingPayLater.checked = s.payLater;
        tableSettingsModal.style.display = 'flex';
    }

    async function saveTableSettings() {
        if (!currentTableForSettings) return;
        const newSettings = {
            help: tableSettingHelp.checked,
            payRequest: tableSettingPayRequest.checked,
            card: tableSettingCard.checked,
            cash: tableSettingCash.checked,
            payNow: tableSettingPayNow.checked,
            payLater: tableSettingPayLater.checked
        };
        currentTableForSettings.settings = newSettings;
        await saveTable(currentTableForSettings);
        tableSettingsModal.style.display = 'none';
        currentTableForSettings = null;
        showNotification(`Settings saved for table.`);
        if (state.currentTable && state.currentTable === currentTableForSettings?.name) {
            applyTableSettings();
        }
    }

    function cancelTableSettings() {
        tableSettingsModal.style.display = 'none';
        currentTableForSettings = null;
    }

    async function addTable() {
        const input = document.getElementById('newTableName');
        const name = input.value.trim();
        if (!name) {
            showNotification('Please enter a table name.');
            return;
        }
        if (state.tables.some(t => t.name === name)) {
            showNotification('Table already exists.');
            return;
        }
        const newTable = {
            name,
            settings: { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true }
        };
        state.tables.push(newTable);
        await saveTable(newTable);
        input.value = '';
        loadTablesForAdmin();
        if (adminPanel.style.display === 'flex') loadTablesForAdminModal();
        showNotification(`Table "${name}" added.`);
    }

    async function addTableModal() {
        const input = document.getElementById('newTableNameModal');
        const name = input.value.trim();
        if (!name) {
            showNotification('Please enter a table name.');
            return;
        }
        if (state.tables.some(t => t.name === name)) {
            showNotification('Table already exists.');
            return;
        }
        const newTable = {
            name,
            settings: { help: true, payRequest: true, card: true, cash: true, payNow: true, payLater: true }
        };
        state.tables.push(newTable);
        await saveTable(newTable);
        input.value = '';
        loadTablesForAdmin();
        loadTablesForAdminModal();
        showNotification(`Table "${name}" added.`);
    }

    // ========== NEW PRINTER FUNCTIONS ==========
    function loadPrintersForAdmin() {
        const container = document.getElementById('printersListContainer');
        if (!container) return;
        container.innerHTML = '';
        if (state.printers.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">No printers added yet.</p>';
            return;
        }
        state.printers.sort((a,b) => (a.name || '').localeCompare(b.name || '')).forEach(printer => {
            const el = document.createElement('div'); el.className = 'category-item';
            el.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-print"></i>
                    <span class="category-item-name">${printer.name} (${printer.ip}${printer.port ? ':'+printer.port : ''})</span>
                </div>
                <div class="admin-card-actions">
                    <button class="admin-small-btn btn-primary test-printer" data-id="${printer.id}" data-ip="${printer.ip}" data-port="${printer.port || 9100}"><i class="fas fa-play"></i> Test</button>
                    <button class="admin-small-btn btn-danger delete-printer" data-id="${printer.id}"><i class="fas fa-trash"></i></button>
                </div>
            `;
            container.appendChild(el);
        });
        document.querySelectorAll('.test-printer').forEach(btn => {
            btn.addEventListener('click', function() {
                const ip = this.dataset.ip;
                const port = this.dataset.port;
                // Simple test: try to fetch a simple page (only works if printer has HTTP interface)
                showNotification(`Testing printer at ${ip}:${port}...`);
                fetch(`http://${ip}:${port}`, { mode: 'no-cors' })
                    .then(() => showNotification(`Printer at ${ip}:${port} responded.`))
                    .catch(() => showNotification(`Printer at ${ip}:${port} did not respond (might still work for printing).`));
            });
        });
        document.querySelectorAll('.delete-printer').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                if (confirm('Delete this printer?')) {
                    state.printers = state.printers.filter(p => p.id !== id);
                    deletePrinterFirestore(id);
                    loadPrintersForAdmin();
                    if (adminPanel.style.display === 'flex') loadPrintersForAdminModal();
                    showNotification('Printer deleted.');
                }
            });
        });
    }

    function loadPrintersForAdminModal() {
        const container = document.getElementById('printersListContainerModal');
        if (!container) return;
        container.innerHTML = '';
        if (state.printers.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">No printers added yet.</p>';
            return;
        }
        state.printers.sort((a,b) => (a.name || '').localeCompare(b.name || '')).forEach(printer => {
            const el = document.createElement('div'); el.className = 'category-item';
            el.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-print"></i>
                    <span class="category-item-name">${printer.name} (${printer.ip}${printer.port ? ':'+printer.port : ''})</span>
                </div>
                <div class="admin-card-actions">
                    <button class="admin-small-btn btn-danger delete-printer-modal" data-id="${printer.id}"><i class="fas fa-trash"></i></button>
                </div>
            `;
            container.appendChild(el);
        });
        document.querySelectorAll('.delete-printer-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                if (confirm('Delete this printer?')) {
                    state.printers = state.printers.filter(p => p.id !== id);
                    deletePrinterFirestore(id);
                    loadPrintersForAdmin();
                    loadPrintersForAdminModal();
                    showNotification('Printer deleted.');
                }
            });
        });
    }

    async function addPrinter() {
        const name = document.getElementById('newPrinterName').value.trim();
        const ip = document.getElementById('newPrinterIp').value.trim();
        const port = parseInt(document.getElementById('newPrinterPort').value) || 9100;
        if (!name || !ip) {
            showNotification('Please enter both printer name and IP address.');
            return;
        }
        const id = 'printer_' + Date.now() + '_' + Math.random().toString(36).substring(2);
        const printer = { id, name, ip, port };
        state.printers.push(printer);
        await savePrinter(printer);
        document.getElementById('newPrinterName').value = '';
        document.getElementById('newPrinterIp').value = '';
        document.getElementById('newPrinterPort').value = '9100';
        loadPrintersForAdmin();
        if (adminPanel.style.display === 'flex') loadPrintersForAdminModal();
        showNotification(`Printer "${name}" added.`);
    }

    async function addPrinterModal() {
        const name = document.getElementById('newPrinterNameModal').value.trim();
        const ip = document.getElementById('newPrinterIpModal').value.trim();
        const port = parseInt(document.getElementById('newPrinterPortModal').value) || 9100;
        if (!name || !ip) {
            showNotification('Please enter both printer name and IP address.');
            return;
        }
        const id = 'printer_' + Date.now() + '_' + Math.random().toString(36).substring(2);
        const printer = { id, name, ip, port };
        state.printers.push(printer);
        await savePrinter(printer);
        document.getElementById('newPrinterNameModal').value = '';
        document.getElementById('newPrinterIpModal').value = '';
        document.getElementById('newPrinterPortModal').value = '9100';
        loadPrintersForAdmin();
        loadPrintersForAdminModal();
        showNotification(`Printer "${name}" added.`);
    }

    // NEW: Network printer scan function
    async function scanNetworkPrinters() {
        const rangeInput = document.getElementById('scanRange').value;
        // Parse range like "192.168.1.1-254"
        const match = rangeInput.match(/^(\d+\.\d+\.\d+)\.(\d+)-(\d+)$/);
        if (!match) {
            showNotification('Invalid range format. Use e.g., 192.168.1.1-254');
            return;
        }
        const base = match[1];
        const start = parseInt(match[2]);
        const end = parseInt(match[3]);
        if (start < 1 || end > 254 || start > end) {
            showNotification('Invalid IP range.');
            return;
        }
        showNotification(`Scanning ${base}.${start}-${end} ... this may take a while.`);
        const ports = [80, 443, 9100]; // common printer ports
        const found = [];
        for (let i = start; i <= end; i++) {
            const ip = `${base}.${i}`;
            for (const port of ports) {
                try {
                    const response = await fetch(`http://${ip}:${port}`, { mode: 'no-cors', signal: AbortSignal.timeout(1000) });
                    // If we get here (even with error), it means the host responded
                    found.push({ ip, port });
                    // Add to printers if not already present
                    if (!state.printers.some(p => p.ip === ip && p.port === port)) {
                        const name = `Printer ${ip}`;
                        const id = 'printer_' + Date.now() + '_' + Math.random().toString(36).substring(2);
                        const printer = { id, name, ip, port };
                        state.printers.push(printer);
                        await savePrinter(printer);
                    }
                    break; // stop scanning other ports for this IP
                } catch (err) {
                    // no response, continue
                }
            }
            // Update UI periodically
            if (i % 10 === 0) {
                loadPrintersForAdmin();
                if (adminPanel.style.display === 'flex') loadPrintersForAdminModal();
            }
        }
        loadPrintersForAdmin();
        if (adminPanel.style.display === 'flex') loadPrintersForAdminModal();
        showNotification(`Scan complete. Found ${found.length} device(s).`);
    }

    function printTestPage() {
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            showNotification('Pop-up blocked. Please allow pop-ups to print.');
            return;
        }
        const html = `
            <html>
            <head><title>Test Page</title></head>
            <body>
                <h1>Restaurant Printer Test</h1>
                <p>If you see this, your system default printer is working.</p>
                <p>Date: ${new Date().toLocaleString()}</p>
            </body>
            </html>
        `;
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        // No need to close; user can close after printing
    }

    // ========== EDIT ORDER FUNCTIONS (unchanged) ==========
    function openEditOrderModal(order) {
        state.currentEditOrder = JSON.parse(JSON.stringify(order));
        editOrderNumber.textContent = order.orderNumber;
        renderEditOrderItems();
        editOrderModal.style.display = 'flex';
    }

    function renderEditOrderItems() {
        if (!state.currentEditOrder) return;
        const list = editOrderItemsList;
        list.innerHTML = '';
        let total = 0;
        state.currentEditOrder.items.forEach((item, index) => {
            total += item.price * item.quantity;
            const div = document.createElement('div'); div.className = 'edit-order-item';
            let optionsHtml = '';
            if (item.selectedOptions && item.selectedOptions.length) {
                optionsHtml = '<div class="edit-order-item-options">';
                item.selectedOptions.forEach(opt => {
                    if (opt.isComment) optionsHtml += `<div><i class="fas fa-comment"></i> ${opt.groupName}: "${opt.choiceName}"</div>`;
                    else optionsHtml += `<div>â€¢ ${opt.groupName}: ${opt.choiceName} ${opt.price>0?`(+$${opt.price.toFixed(2)})`:opt.price<0?`(-$${Math.abs(opt.price).toFixed(2)})`:''}</div>`;
                });
                optionsHtml += '</div>';
            }
            div.innerHTML = `
                <div class="edit-order-item-info">
                    <div class="edit-order-item-name">${item.name}</div>
                    ${optionsHtml}
                </div>
                <div class="edit-order-item-controls">
                    <button class="quantity-btn decrease-edit" data-index="${index}"><i class="fas fa-minus"></i></button>
                    <span class="edit-order-item-quantity">${item.quantity}</span>
                    <button class="quantity-btn increase-edit" data-index="${index}"><i class="fas fa-plus"></i></button>
                    <button class="remove-item" data-index="${index}"><i class="fas fa-trash"></i></button>
                </div>
                <div class="edit-order-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
            `;
            list.appendChild(div);
        });
        editOrderTotal.textContent = total.toFixed(2);

        list.querySelectorAll('.decrease-edit').forEach(btn => {
            btn.addEventListener('click', function() {
                const idx = parseInt(this.dataset.index);
                if (state.currentEditOrder.items[idx].quantity > 1) {
                    state.currentEditOrder.items[idx].quantity--;
                } else {
                    state.currentEditOrder.items.splice(idx, 1);
                }
                renderEditOrderItems();
            });
        });
        list.querySelectorAll('.increase-edit').forEach(btn => {
            btn.addEventListener('click', function() {
                const idx = parseInt(this.dataset.index);
                state.currentEditOrder.items[idx].quantity++;
                renderEditOrderItems();
            });
        });
        list.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const idx = parseInt(this.dataset.index);
                state.currentEditOrder.items.splice(idx, 1);
                renderEditOrderItems();
            });
        });
    }

    async function saveEditedOrder() {
        if (!state.currentEditOrder) return;
        const newTotal = state.currentEditOrder.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
        state.currentEditOrder.total = newTotal;
        const idx = state.orders.findIndex(o => o.orderNumber === state.currentEditOrder.orderNumber);
        if (idx !== -1) {
            state.orders[idx] = state.currentEditOrder;
            await saveOrder(state.currentEditOrder);
            recalcCumulativeStats();
            loadOrdersForAdmin();
            if (adminPanel.style.display === 'flex') loadOrdersForAdminModal();
            showNotification(`Order #${state.currentEditOrder.orderNumber} updated.`);
        }
        editOrderModal.style.display = 'none';
        state.currentEditOrder = null;
    }

    function recalcCumulativeStats() {
        const totalOrders = state.orders.length;
        const totalRevenue = state.orders.reduce((sum, o) => sum + o.total, 0);
        state.cumulativeStats = { totalOrders, totalRevenue };
        saveCumulativeStats();
    }

    // ========== ADMIN DASHBOARD (unchanged, except added button for vertical orders viewer) ==========
    function loadAdminDashboardData() {
        document.getElementById('adminRestaurantName').value = state.restaurantInfo.name;
        document.getElementById('adminTaxRate').value = state.restaurantInfo.taxRate;
        document.getElementById('adminPrepTime').value = state.restaurantInfo.estimatedPrepTime;
        document.getElementById('adminWelcomeMessage').value = state.restaurantInfo.welcomeMessage || '';
        // NEW: set adminChangeCode field
        document.getElementById('adminChangeCode').value = state.adminChangeCode;
        updateLogoPreview();
        loadMenuItemsForAdmin();
        loadMenuItemsForAdminEn();
        loadCategoriesForAdmin();
        loadCategoriesForAdminEn(); // new
        loadOrdersForAdmin();
        loadSystemStats();
        loadCustomizationSettings();
        loadSoundSettingsUI();
        loadHelpRequestsForAdmin();
        loadTablesForAdmin();
        // NEW: load printers
        loadPrintersForAdmin();

        document.querySelectorAll('#adminDashboardSection .admin-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tid = this.dataset.tab;
                document.querySelectorAll('#adminDashboardSection .admin-tab').forEach(t=>t.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('#adminDashboardSection .admin-content').forEach(c=>c.classList.remove('active'));
                document.getElementById(tid+'Tab').classList.add('active');
                if (tid==='customization') setTimeout(initializeCustomizationTab,100);
                if (tid==='categories') setTimeout(()=>makeCategoriesDraggable('categoriesListContainer'),200);
                if (tid==='categoriesEn') setTimeout(loadCategoriesForAdminEn,100);
                if (tid==='orders') { loadOrdersForAdmin(); populateTableSelect('tableSelectForDelete'); }
                if (tid==='helpRequests') { loadHelpRequestsForAdmin(); }
                if (tid==='sound') setTimeout(loadSoundSettingsUI,50);
                if (tid==='menuEn') setTimeout(()=>{ loadMenuItemsForAdminEn(); makeAdminGridDraggable('menuItemsListEn'); },50);
                if (tid==='tables') setTimeout(loadTablesForAdmin,50);
                if (tid==='printer') setTimeout(loadPrintersForAdmin,50); // NEW
            });
        });
        document.getElementById('uploadLogoBtn').addEventListener('click', ()=>document.getElementById('logoUpload').click());
        document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
        document.getElementById('removeLogoBtn').addEventListener('click', removeLogo);
        document.getElementById('saveRestaurantSettings').addEventListener('click', ()=> showAdminChangePrompt(saveRestaurantSettingsOptimistic));
        document.getElementById('addMenuItemBtn').addEventListener('click', ()=> openEditMenuItemForm(null));
        document.getElementById('addMenuItemEnBtn').addEventListener('click', ()=> openEditMenuItemFormEn(null));
        document.getElementById('addCategoryBtn').addEventListener('click', ()=> showAdminChangePrompt(addCategoryOptimistic));
        document.getElementById('orderStatusFilter').addEventListener('change', loadOrdersForAdmin);
        document.getElementById('orderTableFilter').addEventListener('change', loadOrdersForAdmin);
        document.getElementById('clearOrdersBtn').addEventListener('click', ()=> showAdminChangePrompt(clearAllOrdersOptimistic));
        document.getElementById('resetMenuBtn').addEventListener('click', ()=> showAdminChangePrompt(async function() { 
            if (confirm("Reset menu to default?")) { 
                state.menuItems = JSON.parse(JSON.stringify(defaultMenuItems)); 
                await Promise.all(state.menuItems.map(i=>saveMenuItem(i))); 
                loadMenuItemsForAdmin();
                loadMenuItemsForAdminEn();
                displayMenuItems('all'); 
                showNotification("Menu reset."); 
            } 
        }));
        document.getElementById('exportDataBtn').addEventListener('click', exportData);
        document.getElementById('importDataBtn').addEventListener('click', ()=> document.getElementById('importDataInput').click());
        document.getElementById('importDataInput').addEventListener('change', (e)=> showAdminChangePrompt(()=>importData(e)));
        document.getElementById('deleteOrdersForTableBtn').addEventListener('click', function() {
            const sel = document.getElementById('tableSelectForDelete');
            if (sel.value) {
                state.pendingAdminCodeAction = async () => { await deleteOrdersForTable(sel.value); };
                showAdminChangePrompt(); // uses the numeric code modal
            } else {
                showNotification('Please select a table.');
            }
        });
        document.getElementById('generateQRPDFBtn').addEventListener('click', function() {
            const textarea = document.getElementById('tableNamesForQR');
            const tableNames = textarea.value.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            generateTableQRCodePDF(tableNames);
        });
        document.getElementById('helpRequestStatusFilter').addEventListener('change', loadHelpRequestsForAdmin);
        document.getElementById('deleteAllResolvedHelpBtn').addEventListener('click', async function() {
            if (!confirm('Delete all resolved help requests?')) return;
            const resolved = state.helpRequests.filter(r => r.status === 'resolved');
            state.helpRequests = state.helpRequests.filter(r => r.status !== 'resolved');
            await Promise.all(resolved.map(r => deleteHelpRequestFirestore(r.id)));
            loadHelpRequestsForAdmin();
            showNotification('All resolved help requests deleted.');
            updatePendingBadges();
        });
        document.getElementById('openHelpVerticalBtn').addEventListener('click', openHelpVerticalView);
        document.getElementById('openCustomerOrderViewBtn').addEventListener('click', openCustomerOrderView);
        // NEW: Vertical Orders Viewer button
        document.getElementById('openVerticalOrdersViewBtn').addEventListener('click', openVerticalOrdersView);
        document.getElementById('addTableBtn').addEventListener('click', ()=> showAdminChangePrompt(addTable));
        // NEW: Add Printer button and scan button
        document.getElementById('addPrinterBtn').addEventListener('click', ()=> showAdminChangePrompt(addPrinter));
        document.getElementById('scanPrintersBtn').addEventListener('click', ()=> showAdminChangePrompt(scanNetworkPrinters));
        document.getElementById('printTestPageBtn').addEventListener('click', printTestPage);
        backToAdminBtn.addEventListener('click', function() {
            state.currentTable = null;
            showSection('adminDashboardSection');
            backToAdminBtn.style.display = 'none';
            cartFloating.style.display = 'none';
            updateRequestPayButton();
        });

        adminDashboardSection.addEventListener('click', e => {
            if (e.target.classList.contains('update-status') || e.target.closest('.update-status')) {
                const btn = e.target.classList.contains('update-status')?e.target:e.target.closest('.update-status');
                const oid = btn.dataset.orderId;
                const sel = document.querySelector(`select[data-order-id="${oid}"]`);
                if (sel && oid) updateOrderStatusOptimistic(oid, sel.value);
            }
            if (e.target.classList.contains('resolve-help-btn') || e.target.closest('.resolve-help-btn')) {
                const btn = e.target.classList.contains('resolve-help-btn')?e.target:e.target.closest('.resolve-help-btn');
                const requestId = btn.dataset.requestId;
                updateHelpRequestStatus(requestId, 'resolved');
            }
            if (e.target.classList.contains('edit-order-btn') || e.target.closest('.edit-order-btn')) {
                const btn = e.target.classList.contains('edit-order-btn')?e.target:e.target.closest('.edit-order-btn');
                const orderId = btn.dataset.orderId;
                const order = state.orders.find(o => o.orderNumber === orderId);
                if (order) openEditOrderModal(order);
            }
            // NEW: Delete single order button handler
            if (e.target.classList.contains('delete-order-btn') || e.target.closest('.delete-order-btn')) {
                const btn = e.target.classList.contains('delete-order-btn') ? e.target : e.target.closest('.delete-order-btn');
                const orderId = btn.dataset.orderId;
                deleteSingleOrder(orderId);
            }
            // NEW: Print order button handler
            if (e.target.classList.contains('print-order-btn') || e.target.closest('.print-order-btn')) {
                const btn = e.target.classList.contains('print-order-btn') ? e.target : e.target.closest('.print-order-btn');
                const orderId = btn.dataset.orderId;
                printOrderToPrinter(orderId);
            }
        });
        setTimeout(()=>{ 
            makeAdminGridDraggable('menuItemsList'); 
            makeAdminGridDraggable('menuItemsListEn');
            makeCategoriesDraggable('categoriesListContainer'); 
            makeCategoriesDraggable('categoriesListContainerEn'); // new
            populateTableSelect('tableSelectForDelete'); 
        },500);
    }

    // ========== PRINT ORDER FUNCTION (MODIFIED â€“ NO PRICES, NO RESTAURANT, ONLY TABLE, ORDER#, TIME, ITEMS WITH OPTIONS) ==========
    function printOrderToPrinter(orderId) {
        const order = state.orders.find(o => o.orderNumber === orderId);
        if (!order) {
            showNotification('Order not found.');
            return;
        }

        // Format the time nicely
        const orderTime = new Date(order.timestamp).toLocaleString();

        // Build HTML for the print window â€“ only table, order number, time, items with subcategories/comments
        const printContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Order #${order.orderNumber}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h2 { margin-bottom: 5px; }
                    .order-info { margin-bottom: 20px; }
                    .item { margin-bottom: 15px; }
                    .item-name { font-weight: bold; }
                    .options { margin-left: 20px; font-size: 0.9em; color: #555; }
                    .comment { margin-left: 20px; font-size: 0.9em; color: #2a7f62; font-style: italic; }
                    hr { border: 0; border-top: 1px solid #ccc; margin: 15px 0; }
                </style>
            </head>
            <body>
                <div class="order-info">
                    <h2>Order #${order.orderNumber}</h2>
                    <p><strong>Table:</strong> ${order.table}</p>
                    <p><strong>Time:</strong> ${orderTime}</p>
                </div>
                <hr>
                ${order.items.map(item => {
                    // Start with the main item line (quantity + name)
                    let itemHtml = `<div class="item"><div class="item-name">${item.quantity} Ã— ${item.name}</div>`;
                    // Add subcategories/options if they exist
                    if (item.selectedOptions && item.selectedOptions.length) {
                        itemHtml += '<div class="options">';
                        item.selectedOptions.forEach(opt => {
                            if (opt.isComment) {
                                itemHtml += `<div class="comment">ğŸ“ ${opt.groupName}: "${opt.choiceName}"</div>`;
                            } else {
                                itemHtml += `<div>â€¢ ${opt.groupName}: ${opt.choiceName}</div>`;
                            }
                        });
                        itemHtml += '</div>';
                    }
                    itemHtml += '</div>';
                    return itemHtml;
                }).join('')}
                <hr>
            </body>
            </html>
        `;

        // Open a new window with the print content
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        if (printWindow) {
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            // Automatically open the print dialog after a short delay
            setTimeout(() => {
                printWindow.print();
            }, 500);
        } else {
            showNotification('Popâ€‘up blocked. Please allow popâ€‘ups for printing.');
            return;
        }

        // Mark as printed if not already
        if (!order.printed) {
            order.printed = true;
            saveOrder(order);  // Firestore update
            // Refresh admin lists to show green icon
            loadOrdersForAdmin();
            if (adminPanel.style.display === 'flex') loadOrdersForAdminModal();
        }

        showNotification(`Print dialog opened for order #${order.orderNumber}.`);
    }

    function updateLogoPreview() {
        const p = document.getElementById('logoPreview'); const p2 = document.getElementById('logoPreviewModal');
        if (state.restaurantInfo.logoImage) { p.innerHTML = `<img src="${state.restaurantInfo.logoImage}" alt="Restaurant Logo">`; if (p2) p2.innerHTML = `<img src="${state.restaurantInfo.logoImage}" alt="Restaurant Logo">`; }
        else { p.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-image"></i><p>No logo uploaded</p></div>'; if (p2) p2.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-image"></i><p>No logo uploaded</p></div>'; }
    }
    function handleLogoUpload(e) {
        const file = e.target.files[0]; if (!file || !file.type.match('image.*')) return;
        const reader = new FileReader();
        reader.onload = function(ev) { state.restaurantInfo.logoImage = ev.target.result; updateLogoPreview(); updateRestaurantUI(); showNotification("Logo uploaded. Don't forget to save."); };
        reader.readAsDataURL(file);
    }
    function removeLogo() { state.restaurantInfo.logoImage = ""; updateLogoPreview(); updateRestaurantUI(); showNotification("Logo removed. Don't forget to save."); }
    async function saveRestaurantSettingsOptimistic() {
        // NEW: read and validate admin change code
        const newCode = document.getElementById('adminChangeCode').value.trim();
        if (newCode && !/^\d{4}$/.test(newCode)) {
            showNotification('Change code must be exactly 4 digits.');
            return;
        }
        if (newCode) {
            state.adminChangeCode = newCode;
            state.restaurantInfo.adminChangeCode = newCode;
        }

        state.restaurantInfo.name = document.getElementById('adminRestaurantName').value;
        state.restaurantInfo.taxRate = parseFloat(document.getElementById('adminTaxRate').value);
        state.restaurantInfo.estimatedPrepTime = document.getElementById('adminPrepTime').value;
        state.restaurantInfo.welcomeMessage = document.getElementById('adminWelcomeMessage').value;
        updateRestaurantUI();
        showNotification("Restaurant settings saved.");
        await saveRestaurantInfo();
    }

    // --- MENU ADMIN (Greek) (unchanged) ---
    function loadMenuItemsForAdmin() {
        const list = document.getElementById('menuItemsList'); list.innerHTML = '';
        if (state.menuItems.length===0) { list.innerHTML = '<p style="text-align: center; color: var(--gray);">No menu items found.</p>'; return; }
        const sorted = [...state.menuItems].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
        sorted.forEach(item => {
            const card = document.createElement('div'); card.className = 'admin-card'; card.setAttribute('draggable','true'); card.dataset.itemId = item.id;
            const img = item.image ? `<div style="height:120px; background-image:url('${item.image}'); background-size:cover; background-position:center; border-radius:8px; margin-bottom:10px;"></div>` : `<div style="height:120px; background-color:var(--light-gray); border-radius:8px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; color:var(--gray);"><i class="fas fa-utensils"></i></div>`;
            card.innerHTML = `<div style="display:flex; align-items:center; margin-bottom:5px;"><i class="fas fa-grip-vertical drag-handle"></i></div>${img}<div class="admin-card-header"><div class="admin-card-title">${item.name}</div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-item" data-id="${item.id}"><i class="fas fa-edit"></i></button><button class="admin-small-btn btn-secondary duplicate-item" data-id="${item.id}"><i class="fas fa-copy"></i></button><button class="admin-small-btn btn-danger delete-item" data-id="${item.id}"><i class="fas fa-trash"></i></button></div></div><p style="margin-bottom:10px; font-size:14px;">${item.description}</p><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:600; color:var(--primary);">$${item.price.toFixed(2)}</span><span style="font-size:12px; color:var(--gray);">${getCategoryDisplayName(item.category)}</span></div><div class="tag-display">${item.tags.map(t=>`<span class="tag-item">${t}</span>`).join('')}</div>`;
            if (item.options?.length) card.innerHTML += `<div style="margin-top:10px; font-size:12px; color:var(--secondary);"><i class="fas fa-tasks"></i> ${item.options.length} option group(s)</div>`;
            list.appendChild(card);
        });
        document.querySelectorAll('.edit-item').forEach(b=> b.addEventListener('click', function() { openEditMenuItemForm(parseInt(this.dataset.id)); }));
        document.querySelectorAll('.duplicate-item').forEach(b=> b.addEventListener('click', function() { duplicateMenuItemOptimistic(parseInt(this.dataset.id)); }));
        document.querySelectorAll('.delete-item').forEach(b=> b.addEventListener('click', function() { const id = parseInt(this.dataset.id); showAdminChangePrompt(()=>deleteMenuItemOptimistic(id)); }));
        makeAdminGridDraggable('menuItemsList');
    }
    async function duplicateMenuItemOptimistic(id) {
        const orig = state.menuItems.find(i=>i.id===id); if (!orig) return;
        const newId = state.menuItems.length ? Math.max(...state.menuItems.map(i=>i.id))+1 : 1;
        const maxOrder = state.menuItems.reduce((m,i)=>Math.max(m,i.displayOrder||0),0);
        const newItem = { ...orig, id: newId, name: `${orig.name} (copy)`, displayOrder: maxOrder+1 };
        state.menuItems.push(newItem);
        state.menuItems.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
        loadMenuItemsForAdmin();
        loadMenuItemsForAdminEn();
        displayMenuItems('all');
        showNotification(`"${newItem.name}" duplicated.`);
        await saveMenuItem(newItem);
    }
    function openEditMenuItemForm(id) {
        const form = document.getElementById('editMenuItemForm'); const list = document.getElementById('menuItemsList'); const catSel = document.getElementById('editItemCategory');
        catSel.innerHTML = '';
        state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)).forEach(c=> { const o = document.createElement('option'); o.value=c.id; o.textContent=c.displayName; catSel.appendChild(o); });
        const oldOpt = document.getElementById('adminOptionsSection'); if (oldOpt) oldOpt.remove();
        if (id) {
            const item = state.menuItems.find(i=>i.id===id);
            if (item) {
                document.getElementById('editItemName').value = item.name;
                document.getElementById('editItemDescription').value = item.description;
                document.getElementById('editItemPrice').value = item.price;
                document.getElementById('editItemCategory').value = item.category;
                document.getElementById('editItemTags').value = item.tags.join(', ');
                updateItemImagePreview(item.image);
                form.dataset.itemId = id;
                buildOptionsAdminUI(item.options||[]);
            }
        } else {
            document.getElementById('editItemName').value = '';
            document.getElementById('editItemDescription').value = '';
            document.getElementById('editItemPrice').value = '';
            document.getElementById('editItemCategory').value = state.categories[0]?.id || '';
            document.getElementById('editItemTags').value = '';
            updateItemImagePreview('');
            form.dataset.itemId = '';
            buildOptionsAdminUI([]);
        }
        document.getElementById('uploadItemImageBtn').addEventListener('click', ()=>document.getElementById('itemImageUpload').click());
        document.getElementById('itemImageUpload').addEventListener('change', handleItemImageUpload);
        document.getElementById('removeItemImageBtn').addEventListener('click', ()=>{ updateItemImagePreview(''); state.currentImageUpload = null; });
        list.style.display = 'none'; form.style.display = 'block';
        document.getElementById('cancelEditBtn').onclick = function() { form.style.display = 'none'; list.style.display = 'block'; };
        document.getElementById('saveMenuItemBtn').onclick = function() { showAdminChangePrompt(saveMenuItemOptimistic); };
    }
    function buildOptionsAdminUI(options) {
        const form = document.getElementById('editMenuItemForm');
        const sec = document.createElement('div'); sec.id = 'adminOptionsSection'; sec.className = 'admin-options-section';
        sec.innerHTML = `<h4 style="margin-bottom:15px;"><i class="fas fa-tasks"></i> Options / Subcategories (EL)</h4><div id="optionsGroupsContainer"></div><button type="button" class="btn btn-secondary" id="addOptionGroupBtn"><i class="fas fa-plus"></i> Add Option Group</button>`;
        const tagsGrp = document.querySelector('.admin-form-group:has(#editItemTags)');
        if (tagsGrp) tagsGrp.parentNode.insertBefore(sec, tagsGrp.nextSibling);
        else form.appendChild(sec);
        const container = document.getElementById('optionsGroupsContainer');
        function render() {
            container.innerHTML = '';
            options.forEach((g, gi) => {
                const grp = document.createElement('div'); grp.className = 'admin-option-group';
                grp.innerHTML = `<div class="admin-option-group-header"><div class="admin-option-group-title"><i class="fas fa-layer-group"></i> <input type="text" class="admin-input" style="width:150px;" placeholder="Group name" value="${g.name}" id="group_name_${gi}"><select class="admin-select" style="width:140px;" id="group_type_${gi}"><option value="radio" ${g.type==='radio'?'selected':''}>Single choice</option><option value="checkbox" ${g.type==='checkbox'?'selected':''}>Multiple choice</option><option value="text" ${g.type==='text'?'selected':''}>Comment field</option></select></div><button class="admin-small-btn btn-danger remove-group" data-index="${gi}"><i class="fas fa-trash"></i></button></div><div id="choices_${gi}" class="choices-container"></div>${g.type!=='text'?'<button class="btn btn-secondary add-choice-btn" data-group-index="'+gi+'"><i class="fas fa-plus"></i> Add Choice</button>':''}`;
                container.appendChild(grp);
                if (g.type !== 'text') {
                    const chc = document.getElementById(`choices_${gi}`);
                    g.choices.forEach((c, ci) => {
                        const row = document.createElement('div'); row.className = 'admin-choice-item';
                        row.innerHTML = `<input type="text" class="admin-input admin-choice-input" placeholder="Choice name" value="${c.name||''}" id="choice_name_${gi}_${ci}"><input type="number" class="admin-input admin-choice-price" placeholder="Price adj." step="0.01" value="${c.price||0}" id="choice_price_${gi}_${ci}"><button class="admin-small-btn btn-danger remove-choice" data-group="${gi}" data-choice="${ci}"><i class="fas fa-times"></i></button>`;
                        chc.appendChild(row);
                        row.querySelector(`#choice_name_${gi}_${ci}`).addEventListener('input', e=> { if (!options[gi].choices[ci]) options[gi].choices[ci] = {}; options[gi].choices[ci].name = e.target.value; });
                        row.querySelector(`#choice_price_${gi}_${ci}`).addEventListener('input', e=> { if (!options[gi].choices[ci]) options[gi].choices[ci] = {}; options[gi].choices[ci].price = parseFloat(e.target.value)||0; });
                        row.querySelector('.remove-choice').addEventListener('click', ()=> { options[gi].choices.splice(ci,1); render(); });
                    });
                    grp.querySelector('.add-choice-btn').addEventListener('click', ()=> { options[gi].choices.push({ name: '', price: 0 }); render(); });
                }
                grp.querySelector('.remove-group').addEventListener('click', ()=> { options.splice(gi,1); render(); });
                grp.querySelector(`#group_name_${gi}`).addEventListener('input', e=> { options[gi].name = e.target.value; });
                grp.querySelector(`#group_type_${gi}`).addEventListener('change', e=> { options[gi].type = e.target.value; if (options[gi].type==='text') options[gi].choices = []; else if (!options[gi].choices) options[gi].choices = []; render(); });
            });
        }
        render();
        document.getElementById('addOptionGroupBtn').addEventListener('click', ()=> { options.push({ id: Date.now()+Math.random(), name: 'New Group', type: 'radio', choices: [] }); render(); });
    }
    function updateItemImagePreview(data) {
        const pv = document.getElementById('itemImagePreview');
        if (data) { pv.innerHTML = `<img src="${data}" alt="Menu Item Image">`; state.currentImageUpload = data; }
        else { pv.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-utensils"></i><p>No image uploaded</p></div>'; state.currentImageUpload = null; }
    }
    function handleItemImageUpload(e) {
        const file = e.target.files[0]; if (!file || !file.type.match('image.*')) return;
        const reader = new FileReader();
        reader.onload = ev => { updateItemImagePreview(ev.target.result); showNotification("Image uploaded. Don't forget to save."); };
        reader.readAsDataURL(file);
    }
    async function saveMenuItemOptimistic() {
        const id = document.getElementById('editMenuItemForm').dataset.itemId;
        const name = document.getElementById('editItemName').value;
        const desc = document.getElementById('editItemDescription').value;
        const price = parseFloat(document.getElementById('editItemPrice').value);
        const cat = document.getElementById('editItemCategory').value;
        const tags = document.getElementById('editItemTags').value.split(',').map(t=>t.trim()).filter(t=>t);
        if (!name||!desc||!price||!cat) { showNotification("Please fill all required fields."); return; }
        let options = [];
        const optSec = document.getElementById('adminOptionsSection');
        if (optSec) {
            const grps = optSec.querySelectorAll('.admin-option-group');
            grps.forEach((g,gi)=> {
                const gn = g.querySelector(`#group_name_${gi}`)?.value;
                const gt = g.querySelector(`#group_type_${gi}`)?.value;
                if (!gn) return;
                const choices = [];
                if (gt !== 'text') {
                    const rows = g.querySelectorAll('.admin-choice-item');
                    rows.forEach((r,ci)=> {
                        const n = r.querySelector(`#choice_name_${gi}_${ci}`)?.value?.trim();
                        const p = parseFloat(r.querySelector(`#choice_price_${gi}_${ci}`)?.value) || 0;
                        if (n) choices.push({ name: n, price: p });
                    });
                }
                if (gn.trim() && (gt==='text' || choices.length>0)) options.push({ id: 'opt_'+Date.now()+'_'+gi, name: gn.trim(), type: gt, choices });
            });
        }
        if (id) {
            const idx = state.menuItems.findIndex(i=>i.id===parseInt(id));
            if (idx!==-1) {
                state.menuItems[idx] = { ...state.menuItems[idx], name, description: desc, price, category: cat, image: state.currentImageUpload||state.menuItems[idx].image, tags, options };
            }
        } else {
            const newId = state.menuItems.length ? Math.max(...state.menuItems.map(i=>i.id))+1 : 1;
            const maxOrder = state.menuItems.reduce((m,i)=>Math.max(m,i.displayOrder||0),0);
            state.menuItems.push({ id: newId, name, description: desc, price, category: cat, image: state.currentImageUpload||'', tags, options, displayOrder: maxOrder+1 });
        }
        state.menuItems.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
        document.getElementById('editMenuItemForm').style.display = 'none';
        document.getElementById('menuItemsList').style.display = 'block';
        state.currentImageUpload = null;
        loadMenuItemsForAdmin();
        loadMenuItemsForAdminEn();
        displayMenuItems('all');
        showNotification(id ? "Menu item updated." : "Menu item added.");
        if (id) { const it = state.menuItems.find(i=>i.id===parseInt(id)); if (it) await saveMenuItem(it); }
        else { const newItem = state.menuItems[state.menuItems.length-1]; await saveMenuItem(newItem); }
    }
    async function deleteMenuItemOptimistic(id) {
        if (!confirm("Delete this menu item?")) return;
        const item = state.menuItems.find(i=>i.id===id);
        state.menuItems = state.menuItems.filter(i=>i.id!==id);
        loadMenuItemsForAdmin();
        loadMenuItemsForAdminEn();
        displayMenuItems('all');
        showNotification(`"${item?.name}" deleted.`);
        await deleteMenuItemFirestore(id);
    }

    // --- MENU ADMIN (English) (unchanged) ---
    function loadMenuItemsForAdminEn() {
        const list = document.getElementById('menuItemsListEn'); if (!list) return;
        list.innerHTML = '';
        if (state.menuItems.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--gray);">No menu items found.</p>';
            return;
        }
        const sorted = [...state.menuItems].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
        sorted.forEach(item => {
            const card = document.createElement('div'); card.className = 'admin-card'; card.setAttribute('draggable','true'); card.dataset.itemId = item.id;
            const img = item.image ? `<div style="height:120px; background-image:url('${item.image}'); background-size:cover; background-position:center; border-radius:8px; margin-bottom:10px;"></div>` : `<div style="height:120px; background-color:var(--light-gray); border-radius:8px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; color:var(--gray);"><i class="fas fa-utensils"></i></div>`;
            card.innerHTML = `<div style="display:flex; align-items:center; margin-bottom:5px;"><i class="fas fa-grip-vertical drag-handle"></i></div>${img}<div class="admin-card-header"><div class="admin-card-title">${item.nameEn || '(no English name)'}</div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-item-en" data-id="${item.id}"><i class="fas fa-edit"></i></button><button class="admin-small-btn btn-secondary duplicate-item-en" data-id="${item.id}"><i class="fas fa-copy"></i></button><button class="admin-small-btn btn-danger delete-item-en" data-id="${item.id}"><i class="fas fa-trash"></i></button></div></div><p style="margin-bottom:10px; font-size:14px;">${item.descriptionEn || ''}</p><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:600; color:var(--primary);">$${item.price.toFixed(2)}</span><span style="font-size:12px; color:var(--gray);">${getCategoryDisplayName(item.category)}</span></div><div class="tag-display">${(item.tagsEn || []).map(t=>`<span class="tag-item">${t}</span>`).join('')}</div>`;
            if (item.options?.length) card.innerHTML += `<div style="margin-top:10px; font-size:12px; color:var(--secondary);"><i class="fas fa-tasks"></i> ${item.options.length} option group(s)</div>`;
            list.appendChild(card);
        });
        document.querySelectorAll('.edit-item-en').forEach(b => b.addEventListener('click', function() { openEditMenuItemFormEn(parseInt(this.dataset.id)); }));
        document.querySelectorAll('.duplicate-item-en').forEach(b => b.addEventListener('click', function() { duplicateMenuItemOptimisticEn(parseInt(this.dataset.id)); }));
        document.querySelectorAll('.delete-item-en').forEach(b => b.addEventListener('click', function() { const id = parseInt(this.dataset.id); showAdminChangePrompt(()=>deleteMenuItemOptimisticEn(id)); }));
        makeAdminGridDraggable('menuItemsListEn');
    }
    function openEditMenuItemFormEn(id) {
        const form = document.getElementById('editMenuItemFormEn');
        const list = document.getElementById('menuItemsListEn');
        const catSel = document.getElementById('editItemCategoryEn');
        catSel.innerHTML = '';
        state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)).forEach(c => {
            const o = document.createElement('option');
            o.value = c.id;
            o.textContent = c.displayName;
            catSel.appendChild(o);
        });
        if (id) {
            const item = state.menuItems.find(i => i.id === id);
            if (item) {
                document.getElementById('editItemNameEn').value = item.nameEn || '';
                document.getElementById('editItemDescriptionEn').value = item.descriptionEn || '';
                document.getElementById('editItemPriceEn').value = item.price;
                document.getElementById('editItemCategoryEn').value = item.category;
                document.getElementById('editItemTagsEn').value = (item.tagsEn || []).join(', ');
                updateItemImagePreviewEn(item.image || '');
                form.dataset.itemId = id;
                buildOptionsAdminUIEn(item.options || []);
            }
        } else {
            document.getElementById('editItemNameEn').value = '';
            document.getElementById('editItemDescriptionEn').value = '';
            document.getElementById('editItemPriceEn').value = '0.00';
            catSel.value = state.categories[0]?.id || '';
            document.getElementById('editItemTagsEn').value = '';
            updateItemImagePreviewEn('');
            form.dataset.itemId = '';
            buildOptionsAdminUIEn([]);
        }
        list.style.display = 'none';
        form.style.display = 'block';
        document.getElementById('cancelEditBtnEn').onclick = function() {
            form.style.display = 'none';
            list.style.display = 'block';
        };
        document.getElementById('saveMenuItemBtnEn').onclick = function() {
            showAdminChangePrompt(saveMenuItemOptimisticEn);
        };
    }
    function updateItemImagePreviewEn(src) {
        const pv = document.getElementById('itemImagePreviewEn');
        if (src) { pv.innerHTML = `<img src="${src}" alt="Menu Item Image">`; }
        else { pv.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-utensils"></i><p>No image uploaded</p></div>'; }
    }
    function buildOptionsAdminUIEn(options) {
        const container = document.getElementById('optionsGroupsContainerEn');
        if (!container) return;
        container.innerHTML = '';
        function render() {
            container.innerHTML = '';
            options.forEach((g, gi) => {
                const grp = document.createElement('div'); grp.className = 'admin-option-group';
                grp.innerHTML = `
                    <div class="admin-option-group-header">
                        <div class="admin-option-group-title">
                            <i class="fas fa-layer-group"></i> 
                            <input type="text" class="admin-input" style="width:150px;" placeholder="Group name (EN)" value="${g.nameEn || ''}" id="group_name_en_${gi}">
                            <span style="margin-left:10px; font-size:12px; color:var(--gray);">(${g.type})</span>
                        </div>
                        <!-- No delete button in EN mode -->
                    </div>
                    <div id="choices_en_${gi}" class="choices-container"></div>
                `;
                container.appendChild(grp);
                if (g.type !== 'text') {
                    const chc = document.getElementById(`choices_en_${gi}`);
                    g.choices.forEach((c, ci) => {
                        const row = document.createElement('div'); row.className = 'admin-choice-item';
                        row.innerHTML = `
                            <input type="text" class="admin-input admin-choice-input" placeholder="Choice name (EN)" value="${c.nameEn || ''}" id="choice_name_en_${gi}_${ci}">
                            <span class="admin-choice-price" style="width:100px;">Price: $${(c.price || 0).toFixed(2)}</span>
                            <!-- No delete button -->
                        `;
                        chc.appendChild(row);
                        row.querySelector(`#choice_name_en_${gi}_${ci}`).addEventListener('input', e => {
                            if (!options[gi].choices[ci]) options[gi].choices[ci] = {};
                            options[gi].choices[ci].nameEn = e.target.value;
                        });
                    });
                    // No add choice button
                }
                grp.querySelector(`#group_name_en_${gi}`).addEventListener('input', e => {
                    options[gi].nameEn = e.target.value;
                });
            });
        }
        render();
        // No Add Option Group button in EN mode
    }
    async function saveMenuItemOptimisticEn() {
        const form = document.getElementById('editMenuItemFormEn');
        const id = form.dataset.itemId;
        const nameEn = document.getElementById('editItemNameEn').value.trim();
        const descriptionEn = document.getElementById('editItemDescriptionEn').value.trim();
        const tagsEn = document.getElementById('editItemTagsEn').value.split(',').map(t=>t.trim()).filter(t=>t);
        let options = [];
        const optSec = document.getElementById('adminOptionsSectionEn');
        if (optSec) {
            const grps = optSec.querySelectorAll('.admin-option-group');
            grps.forEach((g, gi) => {
                const nameEnVal = g.querySelector(`#group_name_en_${gi}`)?.value;
                if (!nameEnVal) return;
                const type = g.dataset.type || 'radio'; // not editable
                const choices = [];
                if (type !== 'text') {
                    const rows = g.querySelectorAll('.admin-choice-item');
                    rows.forEach((r, ci) => {
                        const n = r.querySelector(`#choice_name_en_${gi}_${ci}`)?.value?.trim();
                        if (n) choices.push({ name: '', nameEn: n, price: 0 });
                    });
                }
                options.push({
                    id: 'opt_' + Date.now() + '_' + gi,
                    name: '',
                    nameEn: nameEnVal,
                    type: type,
                    choices: choices
                });
            });
        }
        if (id) {
            const idx = state.menuItems.findIndex(i => i.id === parseInt(id));
            if (idx !== -1) {
                state.menuItems[idx].nameEn = nameEn;
                state.menuItems[idx].descriptionEn = descriptionEn;
                state.menuItems[idx].tagsEn = tagsEn;
                if (state.menuItems[idx].options) {
                    options.forEach((newGrp, gi) => {
                        if (state.menuItems[idx].options[gi]) {
                            state.menuItems[idx].options[gi].nameEn = newGrp.nameEn;
                            newGrp.choices.forEach((newCh, ci) => {
                                if (state.menuItems[idx].options[gi].choices[ci]) {
                                    state.menuItems[idx].options[gi].choices[ci].nameEn = newCh.nameEn;
                                }
                            });
                        }
                    });
                }
                await saveMenuItem(state.menuItems[idx]);
            }
        } else {
            const newId = state.menuItems.length ? Math.max(...state.menuItems.map(i=>i.id)) + 1 : 1;
            const maxOrder = state.menuItems.reduce((m,i)=>Math.max(m,i.displayOrder||0),0);
            const newItem = {
                id: newId,
                name: '',
                nameEn: nameEn,
                description: '',
                descriptionEn: descriptionEn,
                price: parseFloat(document.getElementById('editItemPriceEn').value) || 0,
                category: document.getElementById('editItemCategoryEn').value,
                image: '',
                tags: [],
                tagsEn: tagsEn,
                options: options.map(grp => ({
                    id: grp.id,
                    name: '',
                    nameEn: grp.nameEn,
                    type: grp.type,
                    choices: grp.choices.map(ch => ({ name: '', nameEn: ch.nameEn, price: 0 }))
                })),
                displayOrder: maxOrder + 1
            };
            state.menuItems.push(newItem);
            state.menuItems.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            await saveMenuItem(newItem);
        }
        form.style.display = 'none';
        document.getElementById('menuItemsListEn').style.display = 'block';
        loadMenuItemsForAdmin();
        loadMenuItemsForAdminEn();
        showNotification(id ? "English menu item updated." : "New English menu item created.");
    }
    async function duplicateMenuItemOptimisticEn(id) {
        const orig = state.menuItems.find(i => i.id === id);
        if (!orig) return;
        const newId = state.menuItems.length ? Math.max(...state.menuItems.map(i=>i.id)) + 1 : 1;
        const maxOrder = state.menuItems.reduce((m,i)=>Math.max(m,i.displayOrder||0),0);
        const newItem = { 
            ...orig, 
            id: newId, 
            name: orig.name + ' (Î±Î½Ï„Î¯Î³ÏÎ±Ï†Î¿)',
            nameEn: orig.nameEn ? orig.nameEn + ' (copy)' : '',
            displayOrder: maxOrder + 1 
        };
        state.menuItems.push(newItem);
        state.menuItems.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
        loadMenuItemsForAdmin();
        loadMenuItemsForAdminEn();
        displayMenuItems('all');
        showNotification(`"${newItem.name}" duplicated.`);
        await saveMenuItem(newItem);
    }
    async function deleteMenuItemOptimisticEn(id) {
        if (!confirm("Delete this menu item? This will also delete the Greek version.")) return;
        const item = state.menuItems.find(i => i.id === id);
        state.menuItems = state.menuItems.filter(i => i.id !== id);
        loadMenuItemsForAdmin();
        loadMenuItemsForAdminEn();
        displayMenuItems('all');
        showNotification(`"${item?.name || item?.nameEn}" deleted.`);
        await deleteMenuItemFirestore(id);
    }

    // --- CATEGORY ADMIN (EL) (unchanged) ---
    function loadCategoriesForAdmin() {
        const con = document.getElementById('categoriesListContainer'); con.innerHTML = '';
        if (state.categories.length===0) { con.innerHTML = '<p style="text-align:center; color:var(--gray); padding:20px;">No categories added yet.</p>'; return; }
        state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)).forEach(c => {
            const cnt = state.menuItems.filter(i=>i.category===c.id).length;
            const el = document.createElement('div'); el.className = 'category-item'; el.setAttribute('draggable','true'); el.dataset.categoryId = c.id;
            el.innerHTML = `<div style="display:flex; align-items:center;"><i class="fas fa-grip-vertical drag-handle-category"></i><span class="category-item-name">${c.displayName} <span style="font-size:12px; color:var(--gray);">(EN: ${c.displayNameEn || ''})</span></span><span class="category-item-count">${cnt} item${cnt!==1?'s':''}</span></div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-category-el" data-id="${c.id}" data-displayname="${c.displayName}" data-displaynameen="${c.displayNameEn || ''}"><i class="fas fa-edit"></i></button><button class="admin-small-btn btn-danger delete-category" data-id="${c.id}"><i class="fas fa-trash"></i></button></div>`;
            con.appendChild(el);
        });
        document.querySelectorAll('.delete-category').forEach(b=> b.addEventListener('click', function() { const id = this.dataset.id; showAdminChangePrompt(()=>deleteCategoryOptimistic(id)); }));
        document.querySelectorAll('.edit-category-el').forEach(b=> b.addEventListener('click', function() {
            const id = this.dataset.id;
            const displayName = this.dataset.displayname;
            const displayNameEn = this.dataset.displaynameen;
            const newDisplayName = prompt("Edit Greek display name:", displayName);
            if (newDisplayName !== null) {
                const newDisplayNameEn = prompt("Edit English display name:", displayNameEn);
                const cat = state.categories.find(c => c.id === id);
                if (cat) {
                    cat.displayName = newDisplayName;
                    cat.displayNameEn = newDisplayNameEn || '';
                    saveCategories();
                    loadCategoriesForAdmin();
                    loadCategoriesForAdminEn();
                    updateCategoryTabs();
                    showNotification("Category updated.");
                }
            }
        }));
        makeCategoriesDraggable('categoriesListContainer');
    }
    // NEW: Category Admin (EN) (unchanged)
    function loadCategoriesForAdminEn() {
        const con = document.getElementById('categoriesListContainerEn'); con.innerHTML = '';
        if (state.categories.length===0) { con.innerHTML = '<p style="text-align:center; color:var(--gray); padding:20px;">No categories added yet.</p>'; return; }
        state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)).forEach(c => {
            const cnt = state.menuItems.filter(i=>i.category===c.id).length;
            const el = document.createElement('div'); el.className = 'category-item'; el.setAttribute('draggable','true'); el.dataset.categoryId = c.id;
            el.innerHTML = `<div style="display:flex; align-items:center;"><i class="fas fa-grip-vertical drag-handle-category"></i><span class="category-item-name">${c.displayNameEn || c.displayName}</span><span class="category-item-count">${cnt} item${cnt!==1?'s':''}</span></div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-category-en" data-id="${c.id}" data-displaynameen="${c.displayNameEn || ''}"><i class="fas fa-edit"></i></button></div>`;
            con.appendChild(el);
        });
        document.querySelectorAll('.edit-category-en').forEach(b=> b.addEventListener('click', function() {
            const id = this.dataset.id;
            const displayNameEn = this.dataset.displaynameen;
            const newDisplayNameEn = prompt("Edit English display name:", displayNameEn);
            if (newDisplayNameEn !== null) {
                const cat = state.categories.find(c => c.id === id);
                if (cat) {
                    cat.displayNameEn = newDisplayNameEn;
                    saveCategories();
                    loadCategoriesForAdmin();
                    loadCategoriesForAdminEn();
                    updateCategoryTabs();
                    showNotification("English category name updated.");
                }
            }
        }));
        makeCategoriesDraggable('categoriesListContainerEn');
    }
    async function addCategoryOptimistic() {
        const ni = document.getElementById('newCategoryName'); const di = document.getElementById('newCategoryDisplayName'); const die = document.getElementById('newCategoryDisplayNameEn');
        const id = ni.value.trim().toLowerCase().replace(/\s+/g,'-'); const disp = di.value.trim() || ni.value.trim(); const dispEn = die.value.trim() || disp;
        if (!id) { showNotification("Please enter a category name (ID)."); return; }
        if (state.categories.some(c=>c.id===id)) { showNotification("Category already exists."); return; }
        const maxOrder = state.categories.reduce((m,c)=>Math.max(m,c.displayOrder||0),0);
        state.categories.push({ id, name: id, displayName: disp, displayNameEn: dispEn, isDefault: false, displayOrder: maxOrder+1 });
        state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
        loadCategoriesForAdmin(); loadCategoriesForAdminEn(); updateCategoryTabs();
        ni.value = ''; di.value = ''; die.value = '';
        showNotification(`Category "${disp}" added.`);
        await saveCategories();
    }
    async function deleteCategoryOptimistic(id) {
        const cat = state.categories.find(c=>c.id===id); if (!cat) return;
        const used = state.menuItems.filter(i=>i.category===id).length;
        if (used>0) { showNotification(`Cannot delete "${cat.displayName}" â€“ it has ${used} menu item(s).`); return; }
        if (!confirm(`Delete category "${cat.displayName}"?`)) return;
        state.categories = state.categories.filter(c=>c.id!==id);
        loadCategoriesForAdmin(); loadCategoriesForAdminEn(); updateCategoryTabs();
        showNotification(`Category "${cat.displayName}" deleted.`);
        await saveCategories();
    }

    // --- ORDER ADMIN (unchanged, but added printed icon and print button) ---
    function loadOrdersForAdmin() {
        const list = document.getElementById('adminOrdersList');
        const statusFilter = document.getElementById('orderStatusFilter').value;
        const tableFilter = document.getElementById('orderTableFilter').value;
        let filtered = statusFilter === 'all' ? [...state.orders] : state.orders.filter(o => o.status === statusFilter);
        if (tableFilter !== 'all') {
            filtered = filtered.filter(o => o.table === tableFilter);
        }
        filtered.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)); // â† ascending order
        if (filtered.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">No orders found.</p>';
            return;
        }
        list.innerHTML = '';
        filtered.forEach(o => {
            const card = document.createElement('div'); card.className = 'admin-card'; card.style.marginBottom = '15px';
            const date = new Date(o.timestamp).toLocaleString();
            let badge = ''; 
            switch(o.status) { 
                case 'pending': badge='<span class="order-status-badge status-pending">Pending</span>'; break; 
                case 'preparing': badge='<span class="order-status-badge status-preparing">Preparing</span>'; break; 
                case 'ready': badge='<span class="order-status-badge status-ready">Ready</span>'; break; 
                case 'served': badge='<span class="order-status-badge status-served">Served</span>'; break; 
                case 'cancelled': badge='<span class="order-status-badge status-cancelled">Cancelled</span>'; break;
                case 'payed': badge='<span class="order-status-badge status-payed">Payed</span>'; break;
            }
            let printedIcon = o.printed ? '<i class="fas fa-print" style="color:green; margin-right:5px;" title="Printed"></i>' : '';
            let itemsHtml = '';
            o.items.forEach(item => {
                itemsHtml += `<div style="margin-bottom:8px;"><div style="display:flex; justify-content:space-between;"><span><strong>${item.quantity}x ${item.name}</strong></span><span style="color:var(--primary);">$${(item.price*item.quantity).toFixed(2)}</span></div>`;
                if (item.selectedOptions?.length) {
                    itemsHtml += '<div style="margin-left:20px; font-size:12px; color:var(--gray);">';
                    item.selectedOptions.forEach(opt => {
                        if (opt.isComment) itemsHtml += `<div><i class="fas fa-comment"></i> ${opt.groupName}: "${opt.choiceName}"</div>`;
                        else itemsHtml += `<div>â€¢ ${opt.groupName}: ${opt.choiceName} ${opt.price>0?`(+$${opt.price.toFixed(2)})`:opt.price<0?`(-$${Math.abs(opt.price).toFixed(2)})`:''}</div>`;
                    });
                    itemsHtml += '</div>';
                }
                itemsHtml += '</div>';
            });
            // Add a delete button next to edit button
            card.innerHTML = `<div class="admin-card-header"><div><div class="admin-card-title">${printedIcon} Order #${o.orderNumber}</div><div style="font-size:12px; color:var(--gray);">${date}</div></div><div>${badge}</div></div><p style="margin-bottom:10px; font-size:14px;"><strong>Table:</strong> ${o.table}<br><strong>Items:</strong></p><div style="margin-bottom:15px;">${itemsHtml}</div><p style="margin-bottom:10px; font-size:14px;"><strong>Total:</strong> $${o.total.toFixed(2)}<br><strong>Payment:</strong> ${o.paymentMethod==='card'?'Card':'Cash'} (${o.paymentTime==='now'?'Pay Now':'Pay Later'})</p><div style="display:flex; gap:10px; margin-top:15px;"><select class="admin-select" style="flex:1;" data-order-id="${o.orderNumber}"><option value="pending" ${o.status==='pending'?'selected':''}>Pending</option><option value="preparing" ${o.status==='preparing'?'selected':''}>Preparing</option><option value="ready" ${o.status==='ready'?'selected':''}>Ready</option><option value="served" ${o.status==='served'?'selected':''}>Served</option><option value="cancelled" ${o.status==='cancelled'?'selected':''}>Cancelled</option><option value="payed" ${o.status==='payed'?'selected':''}>Payed</option></select><button class="btn btn-primary btn-small update-status" data-order-id="${o.orderNumber}" style="padding:8px 15px;">Update</button><button class="btn btn-secondary btn-small edit-order-btn" data-order-id="${o.orderNumber}" style="padding:8px 15px;"><i class="fas fa-edit"></i> Edit</button><button class="btn btn-danger btn-small delete-order-btn" data-order-id="${o.orderNumber}" style="padding:8px 15px;"><i class="fas fa-trash"></i> Delete</button><button class="btn btn-info btn-small print-order-btn" data-order-id="${o.orderNumber}" style="padding:8px 15px;"><i class="fas fa-print"></i> Print</button></div>`;
            list.appendChild(card);
        });
        populateTableSelect('tableSelectForDelete');
        populateTableSelect('tableSelectForDeleteModal');
    }
    async function updateOrderStatusOptimistic(orderId, newStatus) {
        const idx = state.orders.findIndex(o=>o.orderNumber===orderId);
        if (idx!==-1) {
            state.orders[idx].status = newStatus;
            updatePendingBadges();
            loadOrdersForAdmin();
            if (state.currentTable === state.orders[idx].table) loadMyOrders();
            showNotification(`Order #${orderId} status updated.`);
            await saveOrder(state.orders[idx]);
        }
    }
    async function clearAllOrdersOptimistic() {
        if (!confirm("Clear ALL orders? This will also reset cumulative statistics.")) return;
        const toDelete = [...state.orders];
        state.orders = [];
        state.cumulativeStats = { totalOrders: 0, totalRevenue: 0 };
        await saveCumulativeStats();
        updatePendingBadges();
        populateTableFilter();
        populateTableFilterModal();
        loadOrdersForAdmin(); loadMyOrders();
        loadSystemStats();
        populateTableSelect('tableSelectForDelete'); populateTableSelect('tableSelectForDeleteModal');
        showNotification("All orders cleared and statistics reset.");
        await Promise.all(toDelete.map(o=>deleteOrderFirestore(o.orderNumber)));
    }

    // --- HELP REQUESTS ADMIN (unchanged) ---
    function loadHelpRequestsForAdmin() {
        const list = document.getElementById('adminHelpRequestsList');
        const filter = document.getElementById('helpRequestStatusFilter').value;
        let filtered = filter === 'all' ? [...state.helpRequests] : state.helpRequests.filter(r => r.status === filter);
        filtered.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        if (filtered.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">No help requests found.</p>';
            return;
        }
        list.innerHTML = '';
        filtered.forEach(r => {
            const card = document.createElement('div'); card.className = 'help-request-card';
            const date = new Date(r.timestamp).toLocaleString();
            const badge = r.status === 'pending' ? '<span class="help-badge-pending">Pending</span>' : '<span class="help-badge-resolved">Resolved</span>';
            const icon = r.requestType === 'payment' ? 'ğŸ’°' : 'ğŸ†˜';
            card.innerHTML = `
                <div class="help-request-header">
                    <div class="help-request-table">${icon} ${r.table}</div>
                    <div>${badge}</div>
                </div>
                <div class="help-request-time">${date}</div>
                <div class="help-request-actions">
                    ${r.status === 'pending' ? `<button class="btn btn-success btn-small resolve-help-btn" data-request-id="${r.id}"><i class="fas fa-check"></i> Mark Resolved</button>` : ''}
                    <button class="btn btn-danger btn-small delete-help-btn" data-request-id="${r.id}"><i class="fas fa-trash"></i> Delete</button>
                </div>
            `;
            list.appendChild(card);
        });
        list.querySelectorAll('.resolve-help-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.requestId;
                updateHelpRequestStatus(id, 'resolved');
            });
        });
        list.querySelectorAll('.delete-help-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const id = this.dataset.requestId;
                if (!confirm('Delete this help request?')) return;
                state.helpRequests = state.helpRequests.filter(r => r.id !== id);
                await deleteHelpRequestFirestore(id);
                loadHelpRequestsForAdmin();
                showNotification('Help request deleted.');
                updatePendingBadges();
            });
        });
    }
    async function updateHelpRequestStatus(requestId, newStatus) {
        const idx = state.helpRequests.findIndex(r => r.id === requestId);
        if (idx !== -1) {
            state.helpRequests[idx].status = newStatus;
            await saveHelpRequest(state.helpRequests[idx]);
            loadHelpRequestsForAdmin();
            showNotification(`Help request marked as ${newStatus}.`);
            updatePendingBadges();
        }
    }

    // --- SYSTEM STATS (unchanged) ---
    function loadSystemStats() {
        const stats = document.getElementById('systemStats');
        const total = state.cumulativeStats.totalOrders;
        const revenue = state.cumulativeStats.totalRevenue;
        const avg = total>0 ? revenue/total : 0;
        const pending = state.orders.filter(o=>o.status==='pending').length;
        const prep = state.orders.filter(o=>o.status==='preparing').length;
        const ready = state.orders.filter(o=>o.status==='ready').length;
        const served = state.orders.filter(o=>o.status==='served').length;
        const cancelled = state.orders.filter(o=>o.status==='cancelled').length;
        const payed = state.orders.filter(o=>o.status==='payed').length;
        stats.innerHTML = `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:15px;"><div style="background-color:var(--light); padding:15px; border-radius:8px;"><div style="font-size:24px; font-weight:600; color:var(--primary);">${total}</div><div style="font-size:14px; color:var(--gray);">Total Orders (Lifetime)</div></div><div style="background-color:var(--light); padding:15px; border-radius:8px;"><div style="font-size:24px; font-weight:600; color:var(--primary);">$${revenue.toFixed(2)}</div><div style="font-size:14px; color:var(--gray);">Total Revenue (Lifetime)</div></div><div style="background-color:var(--light); padding:15px; border-radius:8px;"><div style="font-size:24px; font-weight:600; color:var(--primary);">$${avg.toFixed(2)}</div><div style="font-size:14px; color:var(--gray);">Average Order</div></div><div style="background-color:var(--light); padding:15px; border-radius:8px;"><div style="font-size:24px; font-weight:600; color:var(--primary);">${state.menuItems.length}</div><div style="font-size:14px; color:var(--gray);">Menu Items</div></div><div style="background-color:var(--light); padding:15px; border-radius:8px;"><div style="font-size:24px; font-weight:600; color:var(--primary);">${state.categories.length}</div><div style="font-size:14px; color:var(--gray);">Categories</div></div></div><div style="margin-top:20px;"><h5 style="margin-bottom:10px;">Order Status Distribution (Current Orders)</h5><div style="display:flex; gap:10px; flex-wrap:wrap;"><div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background-color:#fff3cd; border-radius:2px;"></div><span>Pending: ${pending}</span></div><div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background-color:#d1ecf1; border-radius:2px;"></div><span>Preparing: ${prep}</span></div><div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background-color:#d4edda; border-radius:2px;"></div><span>Ready: ${ready}</span></div><div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background-color:#cce5ff; border-radius:2px;"></div><span>Served: ${served}</span></div><div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background-color:#f8d7da; border-radius:2px;"></div><span>Cancelled: ${cancelled}</span></div><div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background-color:#cce5ff; border-radius:2px;"></div><span>Payed: ${payed}</span></div></div></div>`;
    }
    function exportData() {
        const data = { restaurantInfo: state.restaurantInfo, menuItems: state.menuItems, orders: state.orders, categories: state.categories, customization: state.customization, soundEffects: state.soundEffects, helpRequests: state.helpRequests, cumulativeStats: state.cumulativeStats, tables: state.tables, printers: state.printers, exportDate: new Date().toISOString() };
        const str = JSON.stringify(data,null,2); const uri = 'data:application/json;charset=utf-8,'+encodeURIComponent(str);
        const a = document.createElement('a'); a.href = uri; a.download = `dineeasy-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); showNotification("Data exported successfully.");
    }
    async function importData(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(ev) {
            try {
                const d = JSON.parse(ev.target.result);
                if (confirm("Importing will replace ALL current data. Are you sure?")) {
                    if (d.restaurantInfo) state.restaurantInfo = d.restaurantInfo;
                    if (d.menuItems) state.menuItems = d.menuItems;
                    if (d.orders) state.orders = d.orders;
                    if (d.categories) state.categories = d.categories;
                    if (d.customization) state.customization = d.customization;
                    if (d.soundEffects) state.soundEffects = d.soundEffects;
                    if (d.helpRequests) state.helpRequests = d.helpRequests;
                    if (d.cumulativeStats) state.cumulativeStats = d.cumulativeStats;
                    if (d.tables) state.tables = d.tables;
                    if (d.printers) state.printers = d.printers;
                    await Promise.all(state.menuItems.map(i=>saveMenuItem(i)));
                    await saveCategories();
                    await Promise.all(state.orders.map(o=>saveOrder(o)));
                    await saveRestaurantInfo();
                    await saveCustomization();
                    await saveSoundEffects();
                    await Promise.all(state.helpRequests.map(r=>saveHelpRequest(r)));
                    await saveCumulativeStats();
                    await Promise.all(state.tables.map(t=>saveTable(t)));
                    await Promise.all(state.printers.map(p=>savePrinter(p)));
                    updateRestaurantUI(); displayMenuItems('all'); updateCategoryTabs(); applyCustomization();
                    loadMenuItemsForAdmin(); loadMenuItemsForAdminEn(); loadCategoriesForAdmin(); loadCategoriesForAdminEn(); loadOrdersForAdmin(); loadSystemStats(); loadHelpRequestsForAdmin(); loadTablesForAdmin(); loadPrintersForAdmin();
                    showNotification("Data imported successfully.");
                }
            } catch { showNotification("Error importing data. Invalid file format."); }
        }; reader.readAsText(file); e.target.value = '';
    }

    // --- CUSTOMIZATION (unchanged) ---
    function loadCustomizationSettings() {}
    function initializeCustomizationTab() {
        const g = document.getElementById('themeGallery'); g.innerHTML = '';
        Object.entries(themes).forEach(([tid, t]) => {
            const el = document.createElement('div'); el.className = `theme-card ${tid===state.currentTheme?'selected':''}`; el.dataset.theme = tid;
            el.innerHTML = `<div class="theme-colors-preview"><div style="background-color:${t.primary};"></div><div style="background-color:${t.secondary};"></div><div style="background-color:${t.background};"></div><div style="background-color:${t.text};"></div><div style="background-color:${t.cardBg};"></div></div><div class="theme-info"><div class="theme-name">${t.name}</div><span class="theme-category">${t.category}</span><div class="theme-preview-small"><div style="background-color:${t.primary};"></div><div style="background-color:${t.secondary};"></div><div style="background-color:${t.lightGray};"></div></div></div>`;
            el.addEventListener('click', function() { g.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('selected')); this.classList.add('selected'); document.getElementById('currentThemeName').textContent = t.name; document.getElementById('currentThemeCategory').textContent = t.category; });
            g.appendChild(el);
        });
        document.getElementById('applyThemeBtn').addEventListener('click', function() {
            const sel = g.querySelector('.theme-card.selected'); if (sel) applyTheme(sel.dataset.theme);
        });
        const fg = document.getElementById('fontOptions'); fg.innerHTML = '';
        Object.entries(fonts).forEach(([fid, f]) => {
            const el = document.createElement('div'); el.className = `font-option ${fid===state.currentFont?'selected':''}`; el.dataset.font = fid; el.dataset.primary = f.primary; el.dataset.secondary = f.secondary;
            el.innerHTML = `<div class="font-preview-large" style="font-family:${f.primary.replace(/'/g,'')};">${f.name}</div><div class="font-details"><div style="font-family:${f.primary.replace(/'/g,'')}; margin-bottom:5px;">The quick brown fox</div><div style="font-family:${f.secondary.replace(/'/g,'')}; font-style:italic;">Elegant restaurant menu</div></div>`;
            el.addEventListener('click', function() { fg.querySelectorAll('.font-option').forEach(f=>f.classList.remove('selected')); this.classList.add('selected'); document.getElementById('currentFontName').textContent = f.name; });
            fg.appendChild(el);
        });
        document.getElementById('applyFontBtn').addEventListener('click', function() {
            const sel = fg.querySelector('.font-option.selected'); if (sel) applyFont(sel.dataset.font, sel.dataset.primary, sel.dataset.secondary);
        });
        const cc = document.getElementById('colorCustomization'); cc.innerHTML = '';
        importantColors.forEach(col => {
            const el = document.createElement('div'); el.className = 'color-option';
            el.innerHTML = `<div class="color-label">${col.label}</div><div class="color-preview" style="background-color: ${state.customization[col.id]};"></div><div class="color-input-group"><input type="color" class="color-input" id="color-${col.id}" value="${state.customization[col.id]}"><div class="color-value">${state.customization[col.id]}</div></div>`;
            const inp = el.querySelector('.color-input'); const val = el.querySelector('.color-value'); const pre = el.querySelector('.color-preview');
            inp.addEventListener('input', function() { const v = this.value; val.textContent = v; pre.style.backgroundColor = v; state.customization[col.id] = v; state.currentTheme = "custom"; g.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('selected')); document.getElementById('currentThemeName').textContent = "Custom"; document.getElementById('currentThemeCategory').textContent = "Custom"; applyCustomization(); });
            cc.appendChild(el);
        });
    
        // --- ADD GRADIENT GALLERY AND BLUR SLIDER ---
        // Create a new section for gradients if not already present
        let gradSection = document.querySelector('#customizationTab .gradient-section');
        if (!gradSection) {
            gradSection = document.createElement('div');
            gradSection.className = 'customization-section gradient-section';
            gradSection.innerHTML = `
                <div class="section-title-small"><i class="fas fa-palette"></i> Background Gradient Gallery (60 Premium Gradients)</div>
                <p style="margin-bottom: 20px; color: var(--gray);">Click a gradient to apply it. Use "None" to use the solid background color or uploaded image.</p>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" id="gradientNoneBtn"><i class="fas fa-times"></i> None</button>
                </div>
                <div class="theme-gallery" id="gradientGallery"></div>
            `;
            // Insert after the font section, before color customization
            const fontSection = document.querySelector('#customizationTab .customization-section .font-options')?.closest('.customization-section');
            if (fontSection) {
                fontSection.insertAdjacentElement('afterend', gradSection);
            } else {
                // fallback: append to panel
                document.querySelector('.customization-panel').appendChild(gradSection);
            }
        }
    
        // Populate gradient gallery
        const gradGallery = document.getElementById('gradientGallery');
        if (gradGallery) {
            gradGallery.innerHTML = '';
            gradientLibrary.forEach(g => {
                const card = document.createElement('div');
                card.className = `theme-card ${state.customization.backgroundGradient === g.gradient ? 'selected' : ''}`;
                card.dataset.gradient = g.gradient;
                card.innerHTML = `
                    <div style="height: 100px; background: ${g.gradient}; border-radius: 8px 8px 0 0;"></div>
                    <div class="theme-info">
                        <div class="theme-name">${g.name}</div>
                    </div>
                `;
                card.addEventListener('click', () => {
                    gradGallery.querySelectorAll('.theme-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    state.customization.backgroundGradient = g.gradient;
                    applyCustomization();
                    updatePreviewGradient();
                });
                gradGallery.appendChild(card);
            });
        }
    
        document.getElementById('gradientNoneBtn')?.addEventListener('click', () => {
            gradGallery.querySelectorAll('.theme-card').forEach(c => c.classList.remove('selected'));
            state.customization.backgroundGradient = null;
            applyCustomization();
            updatePreviewGradient();
        });
    
        // Add blur slider section
        let blurSection = document.querySelector('#customizationTab .blur-section');
        if (!blurSection) {
            blurSection = document.createElement('div');
            blurSection.className = 'customization-section blur-section';
            blurSection.innerHTML = `
                <div class="section-title-small"><i class="fas fa-tint"></i> Background Blur</div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <input type="range" id="blurSlider" min="0" max="50" value="${state.customization.backgroundBlur}" step="1" style="flex: 1;">
                    <span id="blurValue">${state.customization.backgroundBlur} px</span>
                </div>
            `;
            // Insert after gradient section
            if (gradSection) {
                gradSection.insertAdjacentElement('afterend', blurSection);
            } else {
                document.querySelector('.customization-panel').appendChild(blurSection);
            }
        }
    
        const blurSlider = document.getElementById('blurSlider');
        const blurValue = document.getElementById('blurValue');
        if (blurSlider) {
            blurSlider.value = state.customization.backgroundBlur;
            blurSlider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                state.customization.backgroundBlur = val;
                blurValue.textContent = val + ' px';
                applyCustomization();
                updatePreviewBlur(val);
            });
        }
    
        // Add a preview box for the gradient inside the existing preview grid if not present
        const previewGrid = document.querySelector('.customization-preview .preview-content-grid');
        if (previewGrid && !document.getElementById('gradientPreviewBox')) {
            const gradPreviewDiv = document.createElement('div');
            gradPreviewDiv.innerHTML = `
                <div class="preview-card" style="margin-top: 15px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: var(--text);">Background Preview</div>
                    <div id="gradientPreviewBox" style="height: 100px; border-radius: 8px; background: ${state.customization.backgroundGradient || 'var(--background)'}; filter: blur(${state.customization.backgroundBlur}px);"></div>
                </div>
            `;
            previewGrid.appendChild(gradPreviewDiv);
        }
    
        function updatePreviewGradient() {
            const previewBox = document.getElementById('gradientPreviewBox');
            if (!previewBox) return;
            if (state.customization.backgroundGradient) {
                previewBox.style.background = state.customization.backgroundGradient;
            } else {
                previewBox.style.background = 'var(--background)';
            }
        }
        function updatePreviewBlur(blur) {
            const previewBox = document.getElementById('gradientPreviewBox');
            if (previewBox) previewBox.style.filter = `blur(${blur}px)`;
        }
    
        // --- end of new gradient/blur UI ---
    
        document.getElementById('resetCustomizationBtn').addEventListener('click', function() { if (confirm("Reset all visual customization to default values?")) { resetCustomization(); setTimeout(initializeCustomizationTab,100); } });
        document.getElementById('saveCustomizationBtn').addEventListener('click', saveCustomizationOptimistic);
        const curTheme = themes[state.currentTheme]; if (curTheme) { document.getElementById('currentThemeName').textContent = curTheme.name; document.getElementById('currentThemeCategory').textContent = curTheme.category; }
        else { document.getElementById('currentThemeName').textContent = "Custom"; document.getElementById('currentThemeCategory').textContent = "Custom"; }
        document.getElementById('currentFontName').textContent = fonts[state.currentFont]?.name || "Poppins";
    }
    function applyTheme(id) {
        if (!themes[id]) return;
        const t = themes[id]; state.currentTheme = id;
        state.customization.primary = t.primary; state.customization.primaryDark = darkenColor(t.primary,20);
        state.customization.secondary = t.secondary; state.customization.background = t.background; state.customization.text = t.text;
        state.customization.cardBg = t.cardBg; state.customization.lightGray = t.lightGray; state.customization.buttonText = getContrastColor(t.primary);
        applyCustomization(); updateColorInputs();
        document.querySelectorAll('#themeGallery .theme-card').forEach(c=>c.classList.remove('selected'));
        const sel = document.querySelector(`#themeGallery .theme-card[data-theme="${id}"]`);
        if (sel) { sel.classList.add('selected'); document.getElementById('currentThemeName').textContent = t.name; document.getElementById('currentThemeCategory').textContent = t.category; }
        showNotification(`"${t.name}" theme applied.`);
    }
    function applyFont(id, pri, sec) { state.currentFont = id; state.customization.fontPrimary = pri; state.customization.fontSecondary = sec; applyCustomization(); document.querySelectorAll('#fontOptions .font-option').forEach(f=>f.classList.remove('selected')); const sel = document.querySelector(`#fontOptions .font-option[data-font="${id}"]`); if (sel) { sel.classList.add('selected'); document.getElementById('currentFontName').textContent = fonts[id].name; } showNotification(`"${fonts[id].name}" font applied.`); }
    function updateColorInputs() { importantColors.forEach(col=>{ const inp = document.getElementById(`color-${col.id}`); if (inp) { const val = inp.parentElement.querySelector('.color-value'); const pre = inp.parentElement.parentElement.querySelector('.color-preview'); if (inp && val && pre) { inp.value = state.customization[col.id]; val.textContent = state.customization[col.id]; pre.style.backgroundColor = state.customization[col.id]; } } }); }
    async function saveCustomizationOptimistic() { showNotification("Visual customization saved."); await saveCustomization(); }
    function resetCustomization() {
            state.customization = {
            primary: "#e63946",
            primaryDark: "#c1121f",
            secondary: "#457b9d",
            light: "#f8f9fa",
            dark: "#212529",
            gray: "#6c757d",
            lightGray: "#e9ecef",
            success: "#2a9d8f",
            warning: "#e9c46a",
            danger: "#dc3545",
            shadow: "0 4px 12px rgba(0, 0, 0, 0.08)",
            radius: "12px",
            background: "#fefefe",
            text: "#212529",
            cardBg: "#ffffff",
            headerBg: "#ffffff",
            menuBg: "#ffffff",
            cartBg: "#ffffff",
            paymentBg: "#ffffff",
            buttonText: "#ffffff",
            fontPrimary: "'Poppins', sans-serif",
            fontSecondary: "'Playfair Display', serif",
            backgroundGradient: null,
            backgroundBlur: 0
        };
        state.currentTheme = "default";
        state.currentFont = "poppins";
        applyCustomization();
    }
    function darkenColor(c,p) { const n = parseInt(c.replace("#",""),16); const a = Math.round(2.55*p); const r = (n>>16)-a, g = (n>>8&0x00FF)-a, b = (n&0x0000FF)-a; return "#" + (0x1000000 + (r<255?r<1?0:r:255)*0x10000 + (g<255?g<1?0:g:255)*0x100 + (b<255?b<1?0:b:255)).toString(16).slice(1); }
    function getContrastColor(h) { const r=parseInt(h.substr(1,2),16), g=parseInt(h.substr(3,2),16), b=parseInt(h.substr(5,2),16), yiq=((r*299)+(g*587)+(b*114))/1000; return yiq>=128?'#000000':'#ffffff'; }

    // --- SOUND EFFECTS ADMIN UI (unchanged) ---
    function loadSoundSettingsUI() {
        const enabledCheck = document.getElementById('soundEffectsEnabled');
        if (enabledCheck) enabledCheck.checked = state.soundEffects.enabled;
        const cartPreview = document.getElementById('cartSoundPreview');
        const checkoutPreview = document.getElementById('checkoutSoundPreview');
        const helpPreview = document.getElementById('helpSoundPreview');
        const newOrderPreview = document.getElementById('newOrderSoundPreview');
        if (state.soundEffects.addToCartSound) {
            cartPreview.innerHTML = `<audio controls src="${state.soundEffects.addToCartSound}" style="width:100%;"></audio>`;
        } else {
            cartPreview.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-music"></i><p>No sound uploaded</p></div>';
        }
        if (state.soundEffects.checkoutSound) {
            checkoutPreview.innerHTML = `<audio controls src="${state.soundEffects.checkoutSound}" style="width:100%;"></audio>`;
        } else {
            checkoutPreview.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-music"></i><p>No sound uploaded</p></div>';
        }
        if (state.soundEffects.helpRequestSound) {
            helpPreview.innerHTML = `<audio controls src="${state.soundEffects.helpRequestSound}" style="width:100%;"></audio>`;
        } else {
            helpPreview.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-music"></i><p>No sound uploaded</p></div>';
        }
        if (state.soundEffects.newOrderSound) {
            newOrderPreview.innerHTML = `<audio controls src="${state.soundEffects.newOrderSound}" style="width:100%;"></audio>`;
        } else {
            newOrderPreview.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-music"></i><p>No sound uploaded</p></div>';
        }

        function getSoundIds(type) {
            if (type === 'NewOrder') {
                return {
                    upload: 'uploadNewOrderSoundBtn',
                    remove: 'removeNewOrderSoundBtn',
                    test: 'testNewOrderSoundBtn',
                    file: 'newOrderSoundUpload'
                };
            } else {
                const lower = type.toLowerCase();
                return {
                    upload: `upload${type}SoundBtn`,
                    remove: `remove${type}SoundBtn`,
                    test: `test${type}SoundBtn`,
                    file: `${lower}SoundUpload`
                };
            }
        }

        ['Cart','Checkout','Help','NewOrder'].forEach(type => {
            const ids = getSoundIds(type);
            const uploadBtn = document.getElementById(ids.upload);
            const removeBtn = document.getElementById(ids.remove);
            const testBtn = document.getElementById(ids.test);
            const fileInput = document.getElementById(ids.file);

            if (uploadBtn) {
                const newBtn = uploadBtn.cloneNode(true);
                uploadBtn.parentNode.replaceChild(newBtn, uploadBtn);
                newBtn.addEventListener('click', () => fileInput.click());
            }
            if (removeBtn) {
                const newBtn = removeBtn.cloneNode(true);
                removeBtn.parentNode.replaceChild(newBtn, removeBtn);
                newBtn.addEventListener('click', () => {
                    if (type === 'Cart') state.soundEffects.addToCartSound = null;
                    else if (type === 'Checkout') state.soundEffects.checkoutSound = null;
                    else if (type === 'Help') state.soundEffects.helpRequestSound = null;
                    else if (type === 'NewOrder') state.soundEffects.newOrderSound = null;
                    loadSoundSettingsUI();
                    showNotification(`${type} sound removed.`);
                });
            }
            if (testBtn) {
                const newBtn = testBtn.cloneNode(true);
                testBtn.parentNode.replaceChild(newBtn, testBtn);
                newBtn.addEventListener('click', () => {
                    let sound = null;
                    if (type === 'Cart') sound = state.soundEffects.addToCartSound;
                    else if (type === 'Checkout') sound = state.soundEffects.checkoutSound;
                    else if (type === 'Help') sound = state.soundEffects.helpRequestSound;
                    else if (type === 'NewOrder') sound = state.soundEffects.newOrderSound;
                    playSound(sound);
                });
            }
            if (fileInput) {
                const newInput = fileInput.cloneNode(true);
                fileInput.parentNode.replaceChild(newInput, fileInput);
                newInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file || !file.type.startsWith('audio/')) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        if (type === 'Cart') state.soundEffects.addToCartSound = ev.target.result;
                        else if (type === 'Checkout') state.soundEffects.checkoutSound = ev.target.result;
                        else if (type === 'Help') state.soundEffects.helpRequestSound = ev.target.result;
                        else if (type === 'NewOrder') state.soundEffects.newOrderSound = ev.target.result;
                        loadSoundSettingsUI();
                        showNotification(`${type} sound loaded. Don't forget to save.`);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        document.getElementById('resetSoundDefaultsBtn').addEventListener('click', () => {
            if (confirm("Clear all uploaded sounds?")) {
                state.soundEffects.addToCartSound = null;
                state.soundEffects.checkoutSound = null;
                state.soundEffects.helpRequestSound = null;
                state.soundEffects.newOrderSound = null;
                loadSoundSettingsUI();
                showNotification("All sounds cleared. Save to persist.");
            }
        });
        document.getElementById('saveSoundEffectsBtn').addEventListener('click', ()=> showAdminChangePrompt(async function() {
            state.soundEffects.enabled = document.getElementById('soundEffectsEnabled').checked;
            await saveSoundEffects();
            showNotification("Sound effects saved.");
        }));
        const modalEnabled = document.getElementById('soundEffectsEnabledModal');
        if (modalEnabled) {
            modalEnabled.checked = state.soundEffects.enabled;
            document.getElementById('saveSoundEffectsModalBtn').onclick = function() {
                state.soundEffects.enabled = modalEnabled.checked;
                showAdminChangePrompt(async function() {
                    await saveSoundEffects();
                    showNotification("Sound settings saved from modal.");
                });
            };
        }
    }

    // --- MODAL ADMIN (unchanged, except added button for vertical orders viewer) ---
    function setupAdminPanel() {
        adminClose.addEventListener('click', ()=> adminPanel.style.display = 'none');
        document.querySelectorAll('#adminPanel .admin-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tid = this.dataset.tab;
                document.querySelectorAll('#adminPanel .admin-tab').forEach(t=>t.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('#adminPanel .admin-content').forEach(c=>c.classList.remove('active'));
                document.getElementById(tid+'TabModal').classList.add('active');
                if (tid==='customization') setTimeout(initializeModalCustomizationTab,100);
                if (tid==='menu') setTimeout(()=>makeAdminGridDraggable('menuItemsListModal'),500);
                if (tid==='menuEn') setTimeout(()=>{ loadMenuItemsForAdminModalEn(); makeAdminGridDraggable('menuItemsListModalEn'); },500);
                if (tid==='categories') setTimeout(()=>makeCategoriesDraggable('categoriesListContainerModal'),200);
                if (tid==='categoriesEn') setTimeout(loadCategoriesForAdminModalEn,100);
                if (tid==='orders') { loadOrdersForAdminModal(); populateTableSelect('tableSelectForDeleteModal'); }
                if (tid==='helpRequests') { loadHelpRequestsForAdminModal(); }
                if (tid==='tablesModal') { loadTablesForAdminModal(); }
                if (tid==='printerModal') { loadPrintersForAdminModal(); } // NEW
                if (tid==='sound') { 
                    const modalEnabled = document.getElementById('soundEffectsEnabledModal');
                    if (modalEnabled) modalEnabled.checked = state.soundEffects.enabled;
                }
            });
        });
        document.getElementById('adminRestaurantNameModal').value = state.restaurantInfo.name;
        document.getElementById('adminTaxRateModal').value = state.restaurantInfo.taxRate;
        document.getElementById('adminPrepTimeModal').value = state.restaurantInfo.estimatedPrepTime;
        document.getElementById('adminWelcomeMessageModal').value = state.restaurantInfo.welcomeMessage || '';
        // NEW: set adminChangeCode modal field
        document.getElementById('adminChangeCodeModal').value = state.adminChangeCode;
        updateLogoPreview();
        loadMenuItemsForAdminModal();
        loadMenuItemsForAdminModalEn();
        loadCategoriesForAdminModal();
        loadCategoriesForAdminModalEn(); // new
        document.getElementById('generateQRPDFBtnModal').addEventListener('click', function() {
            const textarea = document.getElementById('tableNamesForQRModal');
            const tableNames = textarea.value.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            generateTableQRCodePDF(tableNames);
        });
        document.getElementById('deleteOrdersForTableBtnModal').addEventListener('click', function() {
            const sel = document.getElementById('tableSelectForDeleteModal');
            if (sel.value) {
                state.pendingAdminCodeAction = async () => { await deleteOrdersForTable(sel.value); };
                showAdminChangePrompt(); // uses the numeric code modal
            } else {
                showNotification('Please select a table.');
            }
        });
        document.getElementById('helpRequestStatusFilterModal').addEventListener('change', loadHelpRequestsForAdminModal);
        document.getElementById('openHelpVerticalBtnModal').addEventListener('click', openHelpVerticalView);
        document.getElementById('openCustomerOrderViewBtnModal').addEventListener('click', openCustomerOrderView);
        // NEW: Vertical Orders Viewer button in modal
        document.getElementById('openVerticalOrdersViewBtnModal').addEventListener('click', openVerticalOrdersView);
        document.getElementById('addTableBtnModal').addEventListener('click', ()=> showAdminChangePrompt(addTableModal));
        // NEW: Add Printer button modal and scan
        document.getElementById('addPrinterBtnModal').addEventListener('click', ()=> showAdminChangePrompt(addPrinterModal));
        document.getElementById('scanPrintersBtnModal').addEventListener('click', ()=> showAdminChangePrompt(scanNetworkPrinters));

        // NEW: Save Restaurant Settings Modal
        document.getElementById('saveRestaurantSettingsModal').addEventListener('click', () => showAdminChangePrompt(async function() {
            const newCode = document.getElementById('adminChangeCodeModal').value.trim();
            if (newCode && !/^\d{4}$/.test(newCode)) {
                showNotification('Change code must be exactly 4 digits.');
                return;
            }
            if (newCode) {
                state.adminChangeCode = newCode;
                state.restaurantInfo.adminChangeCode = newCode;
            }

            state.restaurantInfo.name = document.getElementById('adminRestaurantNameModal').value;
            state.restaurantInfo.taxRate = parseFloat(document.getElementById('adminTaxRateModal').value);
            state.restaurantInfo.estimatedPrepTime = document.getElementById('adminPrepTimeModal').value;
            state.restaurantInfo.welcomeMessage = document.getElementById('adminWelcomeMessageModal').value;

            updateRestaurantUI();
            await saveRestaurantInfo();
            showNotification("Restaurant settings saved.");
        }));
    }

    function loadMenuItemsForAdminModal() {
        const list = document.getElementById('menuItemsListModal'); if (!list) return;
        list.innerHTML = '';
        if (state.menuItems.length===0) { list.innerHTML = '<p style="text-align: center; color: var(--gray);">No menu items found.</p>'; return; }
        const sorted = [...state.menuItems].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
        sorted.forEach(item => {
            const card = document.createElement('div'); card.className = 'admin-card'; card.setAttribute('draggable','true'); card.dataset.itemId = item.id;
            const img = item.image ? `<div style="height:120px; background-image:url('${item.image}'); background-size:cover; background-position:center; border-radius:8px; margin-bottom:10px;"></div>` : `<div style="height:120px; background-color:var(--light-gray); border-radius:8px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; color:var(--gray);"><i class="fas fa-utensils"></i></div>`;
            card.innerHTML = `<div style="display:flex; align-items:center; margin-bottom:5px;"><i class="fas fa-grip-vertical drag-handle"></i></div>${img}<div class="admin-card-header"><div class="admin-card-title">${item.name}</div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-item-modal" data-id="${item.id}"><i class="fas fa-edit"></i></button><button class="admin-small-btn btn-secondary duplicate-item-modal" data-id="${item.id}"><i class="fas fa-copy"></i></button><button class="admin-small-btn btn-danger delete-item-modal" data-id="${item.id}"><i class="fas fa-trash"></i></button></div></div><p style="margin-bottom:10px; font-size:14px;">${item.description}</p><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:600; color:var(--primary);">$${item.price.toFixed(2)}</span><span style="font-size:12px; color:var(--gray);">${getCategoryDisplayName(item.category)}</span></div><div class="tag-display">${item.tags.map(t=>`<span class="tag-item">${t}</span>`).join('')}</div>`;
            if (item.options?.length) card.innerHTML += `<div style="margin-top:10px; font-size:12px; color:var(--secondary);"><i class="fas fa-tasks"></i> ${item.options.length} option group(s)</div>`;
            list.appendChild(card);
        });
        document.querySelectorAll('.edit-item-modal').forEach(b=> b.addEventListener('click', function() { const id = parseInt(this.dataset.id); openEditMenuItemForm(id); adminPanel.style.display = 'none'; }));
        document.querySelectorAll('.duplicate-item-modal').forEach(b=> b.addEventListener('click', function() { duplicateMenuItemOptimistic(parseInt(this.dataset.id)); }));
        document.querySelectorAll('.delete-item-modal').forEach(b=> b.addEventListener('click', function() { const id = parseInt(this.dataset.id); showAdminChangePrompt(()=>deleteMenuItemOptimistic(id)); }));
        makeAdminGridDraggable('menuItemsListModal');
    }

    function loadMenuItemsForAdminModalEn() {
        const list = document.getElementById('menuItemsListModalEn'); if (!list) return;
        list.innerHTML = '';
        if (state.menuItems.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--gray);">No menu items found.</p>';
            return;
        }
        const sorted = [...state.menuItems].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
        sorted.forEach(item => {
            const card = document.createElement('div'); card.className = 'admin-card'; card.setAttribute('draggable','true'); card.dataset.itemId = item.id;
            const img = item.image ? `<div style="height:120px; background-image:url('${item.image}'); background-size:cover; background-position:center; border-radius:8px; margin-bottom:10px;"></div>` : `<div style="height:120px; background-color:var(--light-gray); border-radius:8px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; color:var(--gray);"><i class="fas fa-utensils"></i></div>`;
            card.innerHTML = `<div style="display:flex; align-items:center; margin-bottom:5px;"><i class="fas fa-grip-vertical drag-handle"></i></div>${img}<div class="admin-card-header"><div class="admin-card-title">${item.nameEn || '(no English name)'}</div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-item-modal-en" data-id="${item.id}"><i class="fas fa-edit"></i></button><button class="admin-small-btn btn-secondary duplicate-item-modal-en" data-id="${item.id}"><i class="fas fa-copy"></i></button><button class="admin-small-btn btn-danger delete-item-modal-en" data-id="${item.id}"><i class="fas fa-trash"></i></button></div></div><p style="margin-bottom:10px; font-size:14px;">${item.descriptionEn || ''}</p><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:600; color:var(--primary);">$${item.price.toFixed(2)}</span><span style="font-size:12px; color:var(--gray);">${getCategoryDisplayName(item.category)}</span></div><div class="tag-display">${(item.tagsEn || []).map(t=>`<span class="tag-item">${t}</span>`).join('')}</div>`;
            if (item.options?.length) card.innerHTML += `<div style="margin-top:10px; font-size:12px; color:var(--secondary);"><i class="fas fa-tasks"></i> ${item.options.length} option group(s)</div>`;
            list.appendChild(card);
        });
        document.querySelectorAll('.edit-item-modal-en').forEach(b=> b.addEventListener('click', function() { const id = parseInt(this.dataset.id); openEditMenuItemFormEn(id); adminPanel.style.display = 'none'; }));
        document.querySelectorAll('.duplicate-item-modal-en').forEach(b=> b.addEventListener('click', function() { duplicateMenuItemOptimisticEn(parseInt(this.dataset.id)); }));
        document.querySelectorAll('.delete-item-modal-en').forEach(b=> b.addEventListener('click', function() { const id = parseInt(this.dataset.id); showAdminChangePrompt(()=>deleteMenuItemOptimisticEn(id)); }));
        makeAdminGridDraggable('menuItemsListModalEn');
    }

    function loadCategoriesForAdminModal() {
        const con = document.getElementById('categoriesListContainerModal'); if (!con) return;
        con.innerHTML = '';
        if (state.categories.length===0) { con.innerHTML = '<p style="text-align:center; color:var(--gray); padding:20px;">No categories added yet.</p>'; return; }
        state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)).forEach(c => {
            const cnt = state.menuItems.filter(i=>i.category===c.id).length;
            const el = document.createElement('div'); el.className = 'category-item'; el.setAttribute('draggable','true'); el.dataset.categoryId = c.id;
            el.innerHTML = `<div style="display:flex; align-items:center;"><i class="fas fa-grip-vertical drag-handle-category"></i><span class="category-item-name">${c.displayName}</span><span class="category-item-count">${cnt} item${cnt!==1?'s':''}</span></div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-category-modal" data-id="${c.id}" data-displayname="${c.displayName}" data-displaynameen="${c.displayNameEn||''}"><i class="fas fa-edit"></i></button><button class="admin-small-btn btn-danger delete-category-modal" data-id="${c.id}"><i class="fas fa-trash"></i></button></div>`;
            con.appendChild(el);
        });
        document.querySelectorAll('.delete-category-modal').forEach(b=> b.addEventListener('click', function() { const id = this.dataset.id; showAdminChangePrompt(()=>deleteCategoryOptimistic(id)); }));
        document.querySelectorAll('.edit-category-modal').forEach(b=> b.addEventListener('click', function() {
            const id = this.dataset.id;
            const displayName = this.dataset.displayname;
            const displayNameEn = this.dataset.displaynameen;
            const newDisplayName = prompt("Edit Greek display name:", displayName);
            if (newDisplayName !== null) {
                const newDisplayNameEn = prompt("Edit English display name:", displayNameEn);
                const cat = state.categories.find(c => c.id === id);
                if (cat) {
                    cat.displayName = newDisplayName;
                    cat.displayNameEn = newDisplayNameEn || '';
                    saveCategories();
                    loadCategoriesForAdmin();
                    loadCategoriesForAdminEn();
                    loadCategoriesForAdminModal();
                    loadCategoriesForAdminModalEn();
                    updateCategoryTabs();
                    showNotification("Category updated.");
                }
            }
        }));
        makeCategoriesDraggable('categoriesListContainerModal');
    }
    // NEW: Category Admin Modal (EN)
    function loadCategoriesForAdminModalEn() {
        const con = document.getElementById('categoriesListContainerEnModal'); if (!con) return;
        con.innerHTML = '';
        if (state.categories.length===0) { con.innerHTML = '<p style="text-align:center; color:var(--gray); padding:20px;">No categories added yet.</p>'; return; }
        state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)).forEach(c => {
            const cnt = state.menuItems.filter(i=>i.category===c.id).length;
            const el = document.createElement('div'); el.className = 'category-item'; el.setAttribute('draggable','true'); el.dataset.categoryId = c.id;
            el.innerHTML = `<div style="display:flex; align-items:center;"><i class="fas fa-grip-vertical drag-handle-category"></i><span class="category-item-name">${c.displayNameEn || c.displayName}</span><span class="category-item-count">${cnt} item${cnt!==1?'s':''}</span></div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-category-en-modal" data-id="${c.id}" data-displaynameen="${c.displayNameEn||''}"><i class="fas fa-edit"></i></button></div>`;
            con.appendChild(el);
        });
        document.querySelectorAll('.edit-category-en-modal').forEach(b=> b.addEventListener('click', function() {
            const id = this.dataset.id;
            const displayNameEn = this.dataset.displaynameen;
            const newDisplayNameEn = prompt("Edit English display name:", displayNameEn);
            if (newDisplayNameEn !== null) {
                const cat = state.categories.find(c => c.id === id);
                if (cat) {
                    cat.displayNameEn = newDisplayNameEn;
                    saveCategories();
                    loadCategoriesForAdmin();
                    loadCategoriesForAdminEn();
                    loadCategoriesForAdminModal();
                    loadCategoriesForAdminModalEn();
                    updateCategoryTabs();
                    showNotification("English category name updated.");
                }
            }
        }));
        makeCategoriesDraggable('categoriesListContainerEnModal');
    }

    function loadOrdersForAdminModal() {
        const list = document.getElementById('adminOrdersListModal');
        const statusFilter = document.getElementById('orderStatusFilterModal').value;
        const tableFilter = document.getElementById('orderTableFilterModal').value;
        let filtered = statusFilter === 'all' ? [...state.orders] : state.orders.filter(o => o.status === statusFilter);
        if (tableFilter !== 'all') {
            filtered = filtered.filter(o => o.table === tableFilter);
        }
        filtered.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)); // â† ascending order
        if (filtered.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">No orders found.</p>';
            return;
        }
        list.innerHTML = '';
        filtered.forEach(o => {
            const card = document.createElement('div'); card.className = 'admin-card'; card.style.marginBottom = '15px';
            const date = new Date(o.timestamp).toLocaleString();
            let badge = ''; 
            switch(o.status) { 
                case 'pending': badge='<span class="order-status-badge status-pending">Pending</span>'; break; 
                case 'preparing': badge='<span class="order-status-badge status-preparing">Preparing</span>'; break; 
                case 'ready': badge='<span class="order-status-badge status-ready">Ready</span>'; break; 
                case 'served': badge='<span class="order-status-badge status-served">Served</span>'; break; 
                case 'cancelled': badge='<span class="order-status-badge status-cancelled">Cancelled</span>'; 
                case 'payed': badge='<span class="order-status-badge status-payed">Payed</span>';
            }
            let printedIcon = o.printed ? '<i class="fas fa-print" style="color:green; margin-right:5px;" title="Printed"></i>' : '';
            let itemsHtml = '';
            o.items.forEach(item => {
                itemsHtml += `<div style="margin-bottom:8px;"><div style="display:flex; justify-content:space-between;"><span><strong>${item.quantity}x ${item.name}</strong></span><span style="color:var(--primary);">$${(item.price*item.quantity).toFixed(2)}</span></div>`;
                if (item.selectedOptions?.length) {
                    itemsHtml += '<div style="margin-left:20px; font-size:12px; color:var(--gray);">';
                    item.selectedOptions.forEach(opt => {
                        if (opt.isComment) itemsHtml += `<div><i class="fas fa-comment"></i> ${opt.groupName}: "${opt.choiceName}"</div>`;
                        else itemsHtml += `<div>â€¢ ${opt.groupName}: ${opt.choiceName} ${opt.price>0?`(+$${opt.price.toFixed(2)})`:opt.price<0?`(-$${Math.abs(opt.price).toFixed(2)})`:''}</div>`;
                    });
                    itemsHtml += '</div>';
                }
                itemsHtml += '</div>';
            });
            // Add delete button in modal as well
            card.innerHTML = `<div class="admin-card-header"><div><div class="admin-card-title">${printedIcon} Order #${o.orderNumber}</div><div style="font-size:12px; color:var(--gray);">${date}</div></div><div>${badge}</div></div><p style="margin-bottom:10px; font-size:14px;"><strong>Table:</strong> ${o.table}<br><strong>Items:</strong></p><div style="margin-bottom:15px;">${itemsHtml}</div><p style="margin-bottom:10px; font-size:14px;"><strong>Total:</strong> $${o.total.toFixed(2)}<br><strong>Payment:</strong> ${o.paymentMethod==='card'?'Card':'Cash'} (${o.paymentTime==='now'?'Pay Now':'Pay Later'})</p><div style="display:flex; gap:10px; margin-top:15px;"><select class="admin-select" style="flex:1;" data-order-id="${o.orderNumber}"><option value="pending" ${o.status==='pending'?'selected':''}>Pending</option><option value="preparing" ${o.status==='preparing'?'selected':''}>Preparing</option><option value="ready" ${o.status==='ready'?'selected':''}>Ready</option><option value="served" ${o.status==='served'?'selected':''}>Served</option><option value="cancelled" ${o.status==='cancelled'?'selected':''}>Cancelled</option><option value="payed" ${o.status==='payed'?'selected':''}>Payed</option></select><button class="btn btn-primary btn-small update-status-modal" data-order-id="${o.orderNumber}" style="padding:8px 15px;">Update</button><button class="btn btn-secondary btn-small edit-order-btn-modal" data-order-id="${o.orderNumber}" style="padding:8px 15px;"><i class="fas fa-edit"></i> Edit</button><button class="btn btn-danger btn-small delete-order-btn-modal" data-order-id="${o.orderNumber}" style="padding:8px 15px;"><i class="fas fa-trash"></i> Delete</button><button class="btn btn-info btn-small print-order-btn-modal" data-order-id="${o.orderNumber}" style="padding:8px 15px;"><i class="fas fa-print"></i> Print</button></div>`;
            list.appendChild(card);
        });
        populateTableSelect('tableSelectForDeleteModal');
        document.querySelectorAll('.update-status-modal').forEach(b=> b.addEventListener('click', function() { const oid = this.dataset.orderId; const sel = document.querySelector(`select[data-order-id="${oid}"]`); if (sel && oid) updateOrderStatusOptimistic(oid, sel.value); }));
        document.querySelectorAll('.edit-order-btn-modal').forEach(b=> b.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            const order = state.orders.find(o => o.orderNumber === orderId);
            if (order) openEditOrderModal(order);
        }));
        // Add delete handler for modal
        document.querySelectorAll('.delete-order-btn-modal').forEach(b=> b.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            deleteSingleOrder(orderId);
        }));
        // Add print handler for modal
        document.querySelectorAll('.print-order-btn-modal').forEach(b=> b.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            printOrderToPrinter(orderId);
        }));
    }

    function loadHelpRequestsForAdminModal() {
        const list = document.getElementById('adminHelpRequestsListModal');
        if (!list) return;
        const filter = document.getElementById('helpRequestStatusFilterModal').value;
        let filtered = filter === 'all' ? [...state.helpRequests] : state.helpRequests.filter(r => r.status === filter);
        filtered.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        if (filtered.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">No help requests found.</p>';
            return;
        }
        list.innerHTML = '';
        filtered.forEach(r => {
            const card = document.createElement('div'); card.className = 'help-request-card';
            const date = new Date(r.timestamp).toLocaleString();
            const badge = r.status === 'pending' ? '<span class="help-badge-pending">Pending</span>' : '<span class="help-badge-resolved">Resolved</span>';
            const icon = r.requestType === 'payment' ? 'ğŸ’°' : 'ğŸ†˜';
            card.innerHTML = `
                <div class="help-request-header">
                    <div class="help-request-table">${icon} ${r.table}</div>
                    <div>${badge}</div>
                </div>
                <div class="help-request-time">${date}</div>
                <div class="help-request-actions">
                    ${r.status === 'pending' ? `<button class="btn btn-success btn-small resolve-help-btn-modal" data-request-id="${r.id}"><i class="fas fa-check"></i> Resolve</button>` : ''}
                    <button class="btn btn-danger btn-small delete-help-btn-modal" data-request-id="${r.id}"><i class="fas fa-trash"></i> Delete</button>
                </div>
            `;
            list.appendChild(card);
        });
        list.querySelectorAll('.resolve-help-btn-modal').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.requestId;
                updateHelpRequestStatus(id, 'resolved');
            });
        });
        list.querySelectorAll('.delete-help-btn-modal').forEach(btn => {
            btn.addEventListener('click', async function() {
                const id = this.dataset.requestId;
                if (!confirm('Delete this help request?')) return;
                state.helpRequests = state.helpRequests.filter(r => r.id !== id);
                await deleteHelpRequestFirestore(id);
                loadHelpRequestsForAdminModal();
                showNotification('Help request deleted.');
                updatePendingBadges();
            });
        });
    }

    function initializeModalCustomizationTab() {
        const g = document.getElementById('themeGalleryModal'); if (!g) return;
        g.innerHTML = '';
        const modalThemes = Object.entries(themes).slice(0,8);
        modalThemes.forEach(([tid,t]) => {
            const el = document.createElement('div'); el.className = `theme-card ${tid===state.currentTheme?'selected':''}`; el.dataset.theme = tid;
            el.innerHTML = `<div class="theme-colors-preview"><div style="background-color:${t.primary};"></div><div style="background-color:${t.secondary};"></div><div style="background-color:${t.background};"></div><div style="background-color:${t.text};"></div><div style="background-color:${t.cardBg};"></div></div><div class="theme-info"><div class="theme-name">${t.name}</div><span class="theme-category">${t.category}</span></div>`;
            el.addEventListener('click', function() { g.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('selected')); this.classList.add('selected'); });
            g.appendChild(el);
        });
        const fg = document.getElementById('fontOptionsModal'); if (!fg) return;
        fg.innerHTML = '';
        Object.entries(fonts).forEach(([fid,f]) => {
            const el = document.createElement('div'); el.className = `font-option ${fid===state.currentFont?'selected':''}`; el.dataset.font = fid;
            el.innerHTML = `<div class="font-preview-large" style="font-family:${f.primary.replace(/'/g,'')};">${f.name}</div>`;
            el.addEventListener('click', function() { fg.querySelectorAll('.font-option').forEach(f=>f.classList.remove('selected')); this.classList.add('selected'); });
            fg.appendChild(el);
        });
        document.getElementById('resetCustomizationBtnModal').addEventListener('click', function() { if (confirm("Reset all visual customization to default values?")) { resetCustomization(); setTimeout(initializeModalCustomizationTab,100); showNotification("Customization reset in modal."); } });
        document.getElementById('saveCustomizationBtnModal').addEventListener('click', function() {
            const selTheme = g.querySelector('.theme-card.selected'); if (selTheme) applyTheme(selTheme.dataset.theme);
            const selFont = fg.querySelector('.font-option.selected'); if (selFont) { const fid = selFont.dataset.font; const f = fonts[fid]; if (f) applyFont(fid, f.primary, f.secondary); }
            saveCustomizationOptimistic(); showNotification("Customization saved from modal.");
        });
    }

    // ========== NEW AUTH HANDLERS (UPDATED ERROR MESSAGE) ==========
    function showAdminLoginPrompt() {
        adminLoginPrompt.style.display = 'flex';
        adminEmail.focus();
        loginError.style.display = 'none';
    }

    async function handleAdminLogin() {
        const email = adminEmail.value.trim();
        const password = adminPassword.value.trim();
        if (!email || !password) {
            loginError.textContent = 'Please enter email and password.';
            loginError.style.display = 'block';
            return;
        }
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            // Check business admin email
            const businessDoc = await getBusinessDoc().get();
            if (!businessDoc.exists) {
                loginError.textContent = 'Business configuration not found.';
                loginError.style.display = 'block';
                await auth.signOut();
                return;
            }
            const businessData = businessDoc.data();
            if (businessData.adminEmail !== user.email) {
                loginError.textContent = 'This email is not authorized for this business.';
                loginError.style.display = 'block';
                await auth.signOut();
                return;
            }
            adminLoginPrompt.style.display = 'none';
            adminEmail.value = '';
            adminPassword.value = '';
            loginError.style.display = 'none';
            enterAdminMode();
            // enterAdminMode will be triggered by onAuthStateChanged
        } catch (error) {
            loginError.textContent = 'Invalid email or password. Please try again.';
            loginError.style.display = 'block';
        }
    }

    function cancelAdminLogin() {
        adminLoginPrompt.style.display = 'none';
        adminEmail.value = '';
        adminPassword.value = '';
        loginError.style.display = 'none';
    }

    // ========== SHOW ADMIN CHANGE PROMPT (unchanged) ==========
    function showAdminChangePrompt(callback) {
        state.pendingAdminAction = callback;
        adminChangePrompt.style.display = 'flex';
        adminChangeCodeInput.focus();
    }

    // ========== EVENT LISTENERS ==========
    async function initApp() {
        await loadInitialData();
        setupListeners();
        autoLoginFromUrl();

        // QR scanner buttons
        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);

        document.getElementById('languageToggleBtn').addEventListener('click', toggleLanguage);
        document.querySelectorAll('.table-btn').forEach(btn => btn.addEventListener('click', function() { selectTable(this.dataset.table, false); }));
        cartFloating.addEventListener('click', function() { if (!state.isAdminMode || (state.currentTable && state.currentTable !== "Admin")) showSection('cartSection'); });
        document.getElementById('backToMenuBtn').addEventListener('click', ()=> showSection('menuSection'));
        document.getElementById('proceedToPaymentBtn').addEventListener('click', function() { if (state.cart.length===0) { showNotification(state.currentLanguage === 'el' ? 'Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ ÎµÎ¯Î´Î· ÏƒÏ„Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÏƒÎ±Ï‚ Ï€ÏÎ¹Î½ Ï€ÏÎ¿Ï‡Ï‰ÏÎ®ÏƒÎµÏ„Îµ ÏƒÏ„Î·Î½ Ï€Î»Î·ÏÏ‰Î¼Î®' : 'Please add items to your cart before proceeding to payment'); return; } updatePaymentSummary(); showSection('paymentSection'); });
        document.getElementById('backToCartBtn').addEventListener('click', ()=> showSection('cartSection'));
        document.querySelectorAll('.option-card[data-payment]').forEach(card => {
            card.addEventListener('click', function() { document.querySelectorAll('.option-card[data-payment]').forEach(c=>c.classList.remove('selected')); this.classList.add('selected'); state.selectedPaymentMethod = this.dataset.payment; });
        });
        document.querySelectorAll('.option-card[data-time]').forEach(card => {
            card.addEventListener('click', function() { document.querySelectorAll('.option-card[data-time]').forEach(c=>c.classList.remove('selected')); this.classList.add('selected'); state.selectedPaymentTime = this.dataset.time; });
        });
        document.getElementById('confirmPaymentBtn').addEventListener('click', placeOrderOptimistic);
        
        document.getElementById('newOrderBtn').addEventListener('click', function() {
            resetCart();
            state.selectedPaymentMethod = null;
            state.selectedPaymentTime = null;
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            if (state.currentTable) {
                menuSubtitle.textContent = state.currentLanguage === 'el' ? `ÎÎµÎºÎ¹Î½Î®ÏƒÏ„Îµ Î¼Î¹Î± Î½Î­Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± Î³Î¹Î± ${state.currentTable}` : `Start a new order for ${state.currentTable}`;
            }
            showSection('menuSection');
            showNotification(state.currentLanguage === 'el' ? 'ÎˆÏ„Î¿Î¹Î¼Î¿Î¹ Î³Î¹Î± Î½Î­Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±!' : 'Ready for a new order!');
        });
        
        document.getElementById('viewMyOrdersBtn').addEventListener('click', function() { loadMyOrders(); showSection('myOrdersSection'); });
        document.getElementById('viewMenuBtn').addEventListener('click', function() { resetCart(); state.selectedPaymentMethod = null; state.selectedPaymentTime = null; document.querySelectorAll('.option-card').forEach(c=>c.classList.remove('selected')); if (state.currentTable) menuSubtitle.textContent = state.currentLanguage === 'el' ? `ÎÎµÎºÎ¹Î½Î®ÏƒÏ„Îµ Î¼Î¹Î± Î½Î­Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± Î³Î¹Î± ${state.currentTable}` : `Start a new order for ${state.currentTable}`; showSection('menuSection'); showNotification(state.currentLanguage === 'el' ? 'ÎˆÏ„Î¿Î¹Î¼Î¿Î¹ Î³Î¹Î± Î½Î­Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±!' : 'Ready for a new order!'); });
        document.getElementById('needHelpBtn').addEventListener('click', showHelpNotification);
        headerHelpButton.addEventListener('click', showHelpNotification);
        requestPayBtn.addEventListener('click', requestPay);
        myOrdersButton.addEventListener('click', function() { loadMyOrders(); showSection('myOrdersSection'); });
        document.getElementById('backToMenuFromOrdersBtn').addEventListener('click', ()=> showSection('menuSection'));
        document.getElementById('placeNewOrderBtn').addEventListener('click', function() { resetCart(); showSection('menuSection'); });

        // PDF download button
        downloadOrderPdfBtn.addEventListener('click', function() {
            // Find the current order (the one just placed) â€“ stored in state.currentOrderNumber? 
            // Actually the order is displayed in confirmation section; we need to retrieve it.
            // We can store the last placed order in a temporary variable.
            if (state.currentOrderNumber) {
                const order = state.orders.find(o => o.orderNumber === state.currentOrderNumber);
                if (order) downloadOrderPdf(order);
            } else {
                // Fallback: try to get from URL or last order in state
                const lastOrder = state.orders[state.orders.length - 1];
                if (lastOrder) downloadOrderPdf(lastOrder);
            }
        });
        
        // Admin floating button now shows login prompt
        adminFloating.addEventListener('click', function() {
            if (!state.currentTable || state.currentTable.toLowerCase() !== "admin") {
                showNotification(state.currentLanguage === 'el' ? 'Î— Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î® ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· Î¼ÏŒÎ½Î¿ Î¼Î­ÏƒÏ‰ QR Ï„Î¿Ï… Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï Admin.' : 'Admin access is only available via Admin table QR.');
                return;
            }
            if (state.isAdminMode) {
                showNotification(state.currentLanguage === 'el' ? 'Î•Î¯ÏƒÏ„Îµ Î®Î´Î· ÏƒÎµ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®.' : 'You are already in admin mode.');
                return;
            }
            showAdminLoginPrompt();
        });

        // Login modal buttons
        submitAdminLoginBtn.addEventListener('click', handleAdminLogin);
        cancelAdminLoginBtn.addEventListener('click', cancelAdminLogin);

        // Change code modal (unchanged)
        submitChangeCodeBtn.addEventListener('click', function() { 
            if (adminChangeCodeInput.value === state.adminChangeCode) { 
                adminChangePrompt.style.display = 'none'; 
                adminChangeCodeInput.value = ''; 
                if (state.pendingAdminAction) { 
                    state.pendingAdminAction(); 
                } 
                state.pendingAdminAction = null; 
            } else { 
                showNotification(state.currentLanguage === 'el' ? "Î›Î¬Î¸Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚." : "Incorrect confirmation code."); 
                adminChangeCodeInput.value = ''; 
                adminChangeCodeInput.focus(); 
            } 
        });
        cancelChangeBtn.addEventListener('click', function() { adminChangePrompt.style.display = 'none'; adminChangeCodeInput.value = ''; state.pendingAdminAction = null; showNotification(state.currentLanguage === 'el' ? "ÎŸÎ¹ Î±Î»Î»Î±Î³Î­Ï‚ Î±ÎºÏ…ÏÏÎ¸Î·ÎºÎ±Î½." : "Changes cancelled."); });

        cancelEditOrderBtn.addEventListener('click', function() {
            editOrderModal.style.display = 'none';
            state.currentEditOrder = null;
        });
        saveEditOrderBtn.addEventListener('click', saveEditedOrder);
        setupAdminPanel();

        // Table settings modal buttons
        cancelTableSettingsBtn.addEventListener('click', cancelTableSettings);
        saveTableSettingsBtn.addEventListener('click', saveTableSettings);
    }

    // ========== UPDATED PLACE ORDER FUNCTION ==========
    window.placeOrderOptimistic = async function() {
        if (!state.selectedPaymentMethod || !state.selectedPaymentTime) { showNotification(state.currentLanguage === 'el' ? 'Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÏŒÏ€Î¿ ÎºÎ±Î¹ Ï‡ÏÏŒÎ½Î¿ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚' : 'Please select payment method and time'); return; }
        if (state.cart.length === 0) { showNotification(state.currentLanguage === 'el' ? 'Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿' : 'Cart is empty'); return; }
        const orderNumber = generateOrderNumber();
        const order = {
            orderNumber, table: state.currentTable,
            items: state.cart.map(item => ({ ...item })),
            paymentMethod: state.selectedPaymentMethod, paymentTime: state.selectedPaymentTime,
            subtotal: calculateSubtotal(), total: calculateTotal(),
            status: 'pending', timestamp: new Date().toISOString(), customerNotes: "",
            printed: false          // <-- ADD THIS LINE
        };
        state.orders.push(order);
        state.currentOrderNumber = orderNumber; // store for PDF
        state.cumulativeStats.totalOrders++;
        state.cumulativeStats.totalRevenue += order.total;
        await saveCumulativeStats();
        showOrderConfirmation(order);
        playSound(state.soundEffects.checkoutSound);
        await saveOrder(order);
        
        // Adjust confirmation buttons based on table type
        const isTakeaway = state.currentTable && state.currentTable.toLowerCase().includes('take away');
        if (isTakeaway) {
            document.getElementById('viewMyOrdersBtn').style.display = 'none';
            document.getElementById('downloadOrderPdfBtn').style.display = 'inline-flex';
        } else {
            document.getElementById('viewMyOrdersBtn').style.display = 'inline-flex';
            document.getElementById('downloadOrderPdfBtn').style.display = 'none';
        }
        
        if (state.isAdminMode && state.currentTable && state.currentTable !== "Admin") {
            state.currentTable = null;
            showSection('adminDashboardSection');
            backToAdminBtn.style.display = 'none';
            cartFloating.style.display = 'none';
            updateRequestPayButton();
            tableInfo.innerHTML = `<i class="fas fa-qrcode"></i> ${state.currentLanguage === 'el' ? 'Î£Î±ÏÏÏƒÏ„Îµ QR Î³Î¹Î± Î­Î½Î±ÏÎ¾Î·' : 'Scan QR to start'}`;
            myOrdersButton.style.display = 'none';
            adminFloating.style.display = 'flex';
        } else {
            showSection('confirmationSection');
            resetCart();
        }
        showNotification(state.currentLanguage === 'el' ? `Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± #${orderNumber} ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹ÏÎ¸Î·ÎºÎµ!` : `Order #${orderNumber} confirmed!`);
    };

    initApp();

    setTimeout(() => {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 500);
        }
    }, 7000);
     </script>
   </body>
</html> 
